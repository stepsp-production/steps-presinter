<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة المراقبة</title>

  <!-- نحاول استخدام المكتبات محليًا، مع فولباك من CDN تلقائيًا -->
  <script defer src="/vendor/hls.min.js"></script>
  <script defer src="/vendor/livekit-client.umd.min.js"></script>

  <style>
    :root{
      --bg:#0f1115; --panel:#151824; --muted:#7e88a3; --text:#e6ecf1; --ok:#17c964; --warn:#f5a524; --err:#f31260; --brand:#006fee;
      --card:#111522; --border:#24283a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Tajawal", "Noto Kufi Arabic", sans-serif}
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    header{grid-column:1/-1;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:5}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button{background:#1b2134;color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    button.ghost{background:transparent}
    button:disabled{opacity:.55;cursor:not-allowed}
    .sidebar{background:var(--panel);border-inline-start:1px solid var(--border);padding:12px 10px;overflow:auto}
    .section-title{font-weight:700;color:#aab6d1;font-size:13px;margin:8px 0 6px}
    .rooms{display:flex;flex-direction:column;gap:6px}
    .room{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .room-hd{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;cursor:pointer;background:linear-gradient(180deg,#131729,#101427)}
    .room-hd .name{font-weight:700}
    .room-bd{padding:10px;display:grid;grid-template-columns:repeat(2,1fr);gap:8px;background:#0f1324;border-top:1px solid var(--border)}
    .cam-btn{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:7px 9px;border-radius:10px;background:#12172a;border:1px solid var(--border);cursor:pointer}
    .cam-btn span{font-weight:600}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0e1323;font-size:12px}
    .dot{width:10px;height:10px;border-radius:50%;background:#3b3f55;box-shadow:0 0 0 1px rgba(0,0,0,.2) inset}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.err{background:var(--err)}
    .main{padding:12px;overflow:auto;display:grid;grid-template-rows:auto 1fr;gap:12px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .card{background:#0e1323;border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .card h4{margin:0;padding:8px 10px;border-bottom:1px solid var(--border);color:#aab6d1}
    video{width:100%;height:240px;background:#000;display:block}
    .kbd{font-family:ui-monospace,Menlo,monospace;font-size:12px;background:#0b0f1d;border:1px solid var(--border);padding:2px 6px;border-radius:6px;color:#b6c3e0}
    @media (max-width:1200px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){.app{grid-template-columns:1fr}.sidebar{order:2}}
    /* نافذة اقتران الكاميرا/المايك */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:50}
    .modal.show{display:grid}
    .sheet{width:min(680px,96vw);background:#0f1324;border:1px solid var(--border);border-radius:14px;padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    select{background:#0d1222;border:1px solid var(--border);color:var(--text);padding:8px;border-radius:10px}
    .sheet video{height:220px}
  </style>
</head>
<body>
  <header>
    <div><strong>لوحة المراقبة</strong></div>
    <div class="actions">
      <button id="btnStart" class="primary">تشغيل + مزامنة</button>
      <button id="btnPauseAll">إيقاف الكل</button>
      <button id="btnSync" class="ghost">مزامنة الآن</button>
      <button id="btnPair">اقتران الكاميرا والمايك</button>
      <span class="kbd">HLS عبر Worker</span>
    </div>
  </header>

  <div class="app">
    <aside class="sidebar">
      <div class="section-title">الغرف (10)</div>
      <div id="rooms" class="rooms"></div>
    </aside>

    <main class="main">
      <div class="toolbar">
        <span>الغرفة النشطة: <strong id="activeRoomName">—</strong></span>
        <span id="lkStatus" class="pill"><i id="lkDot" class="dot"></i> LiveKit</span>
        <span id="mainStatus" class="pill"><i id="mainDot" class="dot"></i> main</span>
      </div>
      <section id="grid" class="grid"></section>
    </main>
  </div>

  <!-- نافذة اقتران الأجهزة -->
  <div id="pairModal" class="modal" role="dialog" aria-modal="true">
    <div class="sheet">
      <h3 style="margin-top:0">اقتران الكاميرا والميكروفون</h3>
      <div class="row">
        <div class="field">
          <label>اختيار الكاميرا</label>
          <select id="selCam"></select>
          <video id="camPreview" autoplay muted playsinline></video>
        </div>
        <div class="field">
          <label>اختيار الميكروفون</label>
          <select id="selMic"></select>
          <div style="margin-top:8px">
            <small id="micHint" style="color:#aab6d1">تلميح: قد تحتاج لمنح الإذن أولاً ليظهر اسم الجهاز.</small>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="btnClosePair" class="ghost">إغلاق</button>
        <button id="btnSavePair" class="primary">سماح & نشر في الغرفة</button>
      </div>
    </div>
  </div>

  <!-- ====== إعدادات عامة ====== -->
  <script>
    // نقطة HLS النهائية (عبر الوركر المرتبط بالتانل كما ذكرت)
    const HLS_BASE = 'https://hls-proxy.it-f2c.workers.dev';

    // مفاتيح القنوات (ضمنها "main" = live)
    const CAMERA_KEYS = ['live','lastone','live2','live3','live4','live5','live6','live7'];

    // 10 غرف افتراضية (استبدل الأسماء إن لزم)
    const ROOMS = Array.from({length:10}, (_,i)=>({id:`room-${i+1}`, name:`الغرفة ${i+1}`}));

    // خدمة إصدار توكن للانضمام إلى LiveKit (لا تغيّر)
    const LIVEKIT_API = 'https://steps-livekit-api.onrender.com';

    // تحويل اسم القناة لمسار m3u8
    const toPath = (key)=> `/hls/${key}/playlist.m3u8`;

    // حالة عامة
    const state = {
      activeRoom: ROOMS[0].id,
      hlsByKey: {}, videoByKey: {},
      roomObj: null,
      selectedCamId: null, selectedMicId: null,
      localStream: null
    };
  </script>

  <!-- ====== واجهة الغرف والشبكة ====== -->
  <script>
    const $rooms = document.getElementById('rooms');
    const $grid  = document.getElementById('grid');
    const $activeRoomName = document.getElementById('activeRoomName');

    function el(tag, attrs={}, children=[]){
      const n = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if (k==='class') n.className = v;
        else if (k==='html') n.innerHTML = v;
        else n.setAttribute(k,v);
      }
      for(const c of children) n.appendChild(c);
      return n;
    }

    function buildRooms(){
      $rooms.innerHTML = '';
      ROOMS.forEach((r, idx)=>{
        const hd = el('div', {class:'room-hd'}, [
          el('span',{class:'name',html:r.name}),
          el('span',{class:'pill'}, [el('i',{id:`roomDot-${r.id}`,class:'dot'}), document.createTextNode(' حالة')])
        ]);
        const bd = el('div', {class:'room-bd'});
        CAMERA_KEYS.forEach(key=>{
          const btn = el('div', {'data-room':r.id,'data-key':key,class:'cam-btn'}, [
            el('span',{html:key}),
            el('i',{id:`dot-${r.id}-${key}`,class:'dot'})
          ]);
          btn.addEventListener('click', ()=> switchRoom(r.id, key));
          bd.appendChild(btn);
        });
        const box = el('div',{class:'room'},[hd,bd]);
        hd.addEventListener('click', ()=> setActiveRoom(r.id));
        $rooms.appendChild(box);
        if (idx===0) setActiveRoom(r.id);
      });
    }

    function buildGrid(){
      $grid.innerHTML = '';
      CAMERA_KEYS.forEach(key=>{
        const card = el('div',{class:'card'});
        card.appendChild(el('h4',{html:key==='live' ? 'main (live)' : key}));
        const v = el('video', {playsinline:'',controls:'',muted:'', 'data-key':key});
        card.appendChild(v);
        $grid.appendChild(card);
        state.videoByKey[key] = v;
      });
    }

    function setActiveRoom(roomId){
      state.activeRoom = roomId;
      const r = ROOMS.find(x=>x.id===roomId);
      $activeRoomName.textContent = r?.name || roomId;
      // أرفق HLS لكل الفيديوهات
      CAMERA_KEYS.forEach(attachHlsToKey);
    }

    function switchRoom(roomId, key){
      setActiveRoom(roomId);
      const card = state.videoByKey[key]?.closest('.card');
      if (card) card.scrollIntoView({behavior:'smooth',block:'center'});
    }
  </script>

  <!-- ====== HLS + Ping ====== -->
  <script>
    // فولباك لمكتبة hls.js إن لم تُحمَّل محليًا
    (function ensureHls(){
      if (!window.Hls) {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js';
        s.defer = true; s.crossOrigin='anonymous';
        document.head.appendChild(s);
      }
    })();

    async function pingOnce(pathOrUrl){
      try{
        const full = (pathOrUrl.startsWith('http') ? pathOrUrl : (HLS_BASE + pathOrUrl)) + '?ping=' + Date.now();
        const res = await fetch(full, {method:'GET',cache:'no-store'});
        if (!res.ok) return false;
        const txt = await res.text();
        return txt.includes('#EXTM3U');
      }catch{ return false; }
    }

    function attachHlsToKey(key){
      const videoEl = state.videoByKey[key];
      if (!videoEl) return;

      // دمر القديم
      try{ state.hlsByKey[key]?.destroy?.(); }catch{}
      state.hlsByKey[key] = null;

      const url = HLS_BASE + toPath(key);

      const H = window.Hls;
      if (H && H.isSupported()){
        const hls = new H({ enableWorker:true, lowLatencyMode:true });
        state.hlsByKey[key] = hls;
        hls.loadSource(url);
        hls.attachMedia(videoEl);
        hls.on(H.Events.MANIFEST_PARSED, async ()=>{
          try{ await videoEl.play(); }catch{}
        });
        hls.on(H.Events.ERROR, (evt, data)=>{
          if (data?.fatal){
            try{ hls.destroy(); }catch{}
            state.hlsByKey[key] = null;
          }
        });
      } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')){
        videoEl.src = url;
        videoEl.addEventListener('loadedmetadata', ()=> videoEl.play().catch(()=>{}), {once:true});
      }
    }

    function playAll(){
      CAMERA_KEYS.forEach(k=> state.videoByKey[k]?.play?.().catch(()=>{}));
    }

    function pauseAll(){
      CAMERA_KEYS.forEach(k=> state.videoByKey[k]?.pause?.());
    }

    function syncAll(){
      CAMERA_KEYS.forEach(key=>{
        const hls = state.hlsByKey[key];
        const v = state.videoByKey[key];
        if (!v) return;
        try{
          if (hls && typeof hls.liveSyncPosition === 'number'){
            v.currentTime = hls.liveSyncPosition;
          } else if (v.buffered && v.buffered.length){
            const end = v.buffered.end(v.buffered.length - 1);
            v.currentTime = Math.max(0, end - 0.5);
          }
          v.play().catch(()=>{});
        }catch{}
      });
    }

    async function refreshDots(){
      const rid = state.activeRoom;
      const okMain = await pingOnce(toPath('live'));
      setDot(`roomDot-${rid}`, okMain ? 'ok' : 'err');
      setDot('mainDot', okMain ? 'ok' : 'err');

      for (const key of CAMERA_KEYS){
        const ok = await pingOnce(toPath(key));
        setDot(`dot-${rid}-${key}`, ok ? 'ok' : 'err');
      }
    }

    function setDot(id, st){
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('ok','warn','err');
      if (st) el.classList.add(st);
    }
  </script>

  <!-- ====== LiveKit: انضمام + نشر الميك/الكاميرا ====== -->
  <script>
    function ensureLiveKit(cb){
      if (window.livekit || window.LivekitClient) return cb && cb();
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/livekit-client@2/dist/livekit-client.umd.min.js';
      s.defer = true; s.onload = ()=> cb && cb();
      document.head.appendChild(s);
    }

    async function joinRoom(roomName){
      await new Promise(r=> ensureLiveKit(r));
      const LK = window.livekit || window.LivekitClient;
      const who = 'browser-' + Math.random().toString(36).slice(2,7);
      const resp = await fetch(`${LIVEKIT_API}/token?room=${encodeURIComponent(roomName)}&identity=${encodeURIComponent(who)}`, {cache:'no-store'});
      if (!resp.ok) throw new Error('token '+resp.status);
      const {url, token} = await resp.json();
      const room = new LK.Room();
      await room.connect(url, token);
      state.roomObj = room;
      setDot('lkDot','ok');
      return room;
    }

    async function publishSelectedDevices(){
      await new Promise(r=> ensureLiveKit(r));
      const LK = window.livekit || window.LivekitClient;
      if (!state.roomObj) {
        setDot('lkDot','warn');
        await joinRoom(state.activeRoom);
      }
      const room = state.roomObj;

      // أنشئ المسارات وفق الأجهزة المختارة
      const tracks = [];
      if (state.selectedMicId){
        const audio = await LK.createLocalAudioTrack({deviceId:{exact: state.selectedMicId}});
        tracks.push(audio);
      }
      if (state.selectedCamId){
        const video = await LK.createLocalVideoTrack({deviceId:{exact: state.selectedCamId}});
        tracks.push(video);
      }
      for (const t of tracks){
        await room.localParticipant.publishTrack(t);
      }
      setDot('lkDot','ok');
    }
  </script>

  <!-- ====== نافذة الاقتران (enumerate + preview) ====== -->
  <script>
    const $pairModal = document.getElementById('pairModal');
    const $selCam = document.getElementById('selCam');
    const $selMic = document.getElementById('selMic');
    const $camPreview = document.getElementById('camPreview');

    async function ensurePermissions(){
      try{
        // طلب صلاحيات لإظهار أسماء الأجهزة
        const s = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
        s.getTracks().forEach(t=> t.stop());
      }catch{}
    }

    async function fillDevices(){
      await ensurePermissions();
      const list = await navigator.mediaDevices.enumerateDevices();
      const cams = list.filter(d=> d.kind==='videoinput');
      const mics = list.filter(d=> d.kind==='audioinput');

      $selCam.innerHTML = cams.map(d=> `<option value="${d.deviceId}">${d.label || 'كاميرا'}</option>`).join('');
      $selMic.innerHTML = mics.map(d=> `<option value="${d.deviceId}">${d.label || 'ميكروفون'}</option>`).join('');

      if (!$selCam.value && cams[0]) $selCam.value = cams[0].deviceId;
      if (!$selMic.value && mics[0]) $selMic.value = mics[0].deviceId;
    }

    async function openPair(){
      $pairModal.classList.add('show');
      await fillDevices();
      await startLocalPreview();
    }

    function closePair(){
      $pairModal.classList.remove('show');
      stopLocalPreview();
    }

    async function startLocalPreview(){
      stopLocalPreview();
      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          video: state.selectedCamId ? {deviceId:{exact:state.selectedCamId}} : true,
          audio: state.selectedMicId ? {deviceId:{exact:state.selectedMicId}} : true,
        });
        state.localStream = stream;
        $camPreview.srcObject = stream;
      }catch(e){
        console.warn('preview error', e);
      }
    }

    function stopLocalPreview(){
      try{ state.localStream?.getTracks()?.forEach(t=> t.stop()); }catch{}
      $camPreview.srcObject = null;
      state.localStream = null;
    }

    // تزامن تغييرات select مع المعاينة
    $selCam?.addEventListener('change', ()=>{
      state.selectedCamId = $selCam.value || null;
      startLocalPreview();
    });
    $selMic?.addEventListener('change', ()=>{
      state.selectedMicId = $selMic.value || null;
      // لا حاجة لمؤشر مرئي، الصوت لا يُعرض فيديو
    });

    // أزرار النافذة
    document.getElementById('btnPair')?.addEventListener('click', openPair);
    document.getElementById('btnClosePair')?.addEventListener('click', closePair);
    document.getElementById('btnSavePair')?.addEventListener('click', async ()=>{
      state.selectedCamId = $selCam.value || null;
      state.selectedMicId = $selMic.value || null;
      try{
        setDot('lkDot','warn');
        await publishSelectedDevices();
        closePair();
      }catch(e){
        console.error(e);
        setDot('lkDot','err');
        alert('تعذّر نشر الصوت/الفيديو إلى الغرفة.');
      }
    });
  </script>

  <!-- ====== تهيئة وتشغيل ====== -->
  <script>
    function bootstrap(){
      buildRooms();
      buildGrid();
      setActiveRoom(ROOMS[0].id);
      refreshDots();
      setInterval(refreshDots, 8000);
    }

    // أزرار التحكم العليا
    document.getElementById('btnStart').addEventListener('click', async ()=>{
      // ربط كل الفيديوهات + تشغيل + مزامنة (يتطلب تفاعل المستخدم)
      CAMERA_KEYS.forEach(attachHlsToKey);
      playAll();
      syncAll();
      // حاول الانضمام للغرفة إن لم تكن متصلاً
      try{
        if (!state.roomObj){
          setDot('lkDot','warn');
          await joinRoom(state.activeRoom);
        }
      }catch{ setDot('lkDot','err'); }
    });

    document.getElementById('btnPauseAll').addEventListener('click', pauseAll);
    document.getElementById('btnSync').addEventListener('click', syncAll);

    // ابدأ
    bootstrap();
  </script>
</body>
</html>
