<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Content-Security-Policy تسمح باتصالات HLS Proxy و LiveKit و API -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src  'self';
    style-src   'self' 'unsafe-inline';
    img-src     'self' data:;
    font-src    'self' data:;
    media-src   * blob:;
    connect-src 'self'
                 https://hls-proxy.it-f2c.workers.dev
                 https://*.trycloudflare.com
                 https://steps-livekit-api.onrender.com
                 wss://*.livekit.cloud;
    worker-src  'self' blob:;
  ">

  <title>Steps MultiCam</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{--bg:#0b0f14;--card:#0f151c;--muted:#a9b3be;--ok:#1ccf63;--err:#ff6161;--btn:#1f2937;--btn2:#0e7490;}
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:#e5eef7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;}
    .app{max-width:1200px;margin:0 auto;padding:16px;}
    h1{font-size:20px;margin:0 0 12px;}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
    .btn{background:var(--btn);border:1px solid #1f2937;color:#e5eef7;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--btn2);border-color:#155e75}
    .btn.ok{background:#14532d;border-color:#14532d}
    .btn.warn{background:#7f1d1d;border-color:#7f1d1d}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #162032;font-size:12px}
    .grid{display:grid;grid-template-columns:260px 1fr;gap:12px}
    .panel{background:var(--card);border:1px solid #162032;border-radius:14px;padding:12px}
    .sources .btn{width:100%;justify-content:space-between;display:flex;align-items:center}
    .sources .btn + .btn{margin-top:8px}
    .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .card{background:#0c131c;border:1px solid #162032;border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .card header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #162032}
    .name{display:flex;align-items:center;gap:8px}
    .dot{width:9px;height:9px;border-radius:50%;background:#586273}
    .dot.live{background:var(--ok)}
    .card video{width:100%;aspect-ratio:16/9;background:#000;display:block}
    .card footer{padding:8px 12px;display:flex;gap:8px;flex-wrap:wrap;border-top:1px solid #162032}
    .field{display:flex;gap:6px;align-items:center}
    .field input,.field select{background:#0b1220;border:1px solid #1c2736;color:#cfe3ff;border-radius:10px;padding:8px}
    .status{display:flex;align-items:center;gap:8px}
    .mono{font-family:ui-monospace,Consolas,monospace}
    small{color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <h1>لوحة البث المتعدد</h1>

    <div class="panel bar">
      <div class="field">
        <label>الاستوديو:</label>
        <select id="roomSel">
          <option value="room-1">studio-1</option>
          <option value="room-2">studio-2</option>
          <option value="room-3">studio-3</option>
        </select>
      </div>
      <div class="field">
        <label>اسم العرض:</label>
        <input id="displayName" placeholder="اسم المتحدّث" />
      </div>
      <button id="pairBtn" class="btn">اقتران الكاميرا/المايك</button>
      <button id="publishBtn" class="btn ok" disabled>تشغيل</button>
      <button id="stopBtn" class="btn warn" disabled>إيقاف</button>
      <span class="pill status">حالة : <span id="lkStatus">LiveKit: غير متصل</span></span>
    </div>

    <div class="grid">
      <!-- القائمة الجانبية / مصادر -->
      <div class="panel sources">
        <div class="pill mono">SOURCES</div>
        <button class="btn" data-src="live">MAIN • <small class="mono">/hls/live/playlist.m3u8</small></button>
        <button class="btn" data-src="live2">CAM 2 • <small class="mono">/hls/live2/playlist.m3u8</small></button>
        <button class="btn" data-src="live3">CAM 3 • <small class="mono">/hls/live3/playlist.m3u8</small></button>
        <button class="btn" data-src="live4">CAM 4 • <small class="mono">/hls/live4/playlist.m3u8</small></button>
        <button class="btn" data-src="live5">CAM 5 • <small class="mono">/hls/live5/playlist.m3u8</small></button>
        <button class="btn" data-src="live6">CAM 6 • <small class="mono">/hls/live6/playlist.m3u8</small></button>
        <button class="btn" data-src="live7">CAM 7 • <small class="mono">/hls/live7/playlist.m3u8</small></button>
        <button class="btn" data-src="lastone">SINEFLEX • <small class="mono">/hls/lastone/playlist.m3u8</small></button>
      </div>

      <!-- البطاقات -->
      <div class="cards" id="cards">
        <!-- يتم توليدها بالـ JS -->
      </div>
    </div>

    <p><small>تلميح: اضغط F لملء الشاشة / لإظهار/إخفاء الواجهة.</small></p>
  </div>

  <!-- مكتبات الطرف الثالث (ضع ملفاتك المحلية داخل /vendor/) -->
  <script src="/vendor/hls.min.js"></script>
  <script src="/vendor/livekit-client.umd.min.js"></script>

  <!-- ملفاتنا -->
  <script src="/vendor/utils.js"></script>
  <script src="/vendor/hls-player.js"></script>
  <script src="/vendor/lk-pub.js"></script>

  <script>
    // ---------- إعدادات عامة ----------
    const HLS_PROXY_BASE = 'https://hls-proxy.it-f2c.workers.dev'; // عبر التانل/الوركر
    const LK_TOKEN_API   = 'https://steps-livekit-api.onrender.com/token'; // API الذي أنشأناه

    const SOURCES = [
      { key: 'live',    title: 'Main (live)'  },
      { key: 'live2',   title: 'Cam 2'        },
      { key: 'live3',   title: 'Cam 3'        },
      { key: 'live4',   title: 'Cam 4'        },
      { key: 'live5',   title: 'Cam 5'        },
      { key: 'live6',   title: 'Cam 6'        },
      { key: 'live7',   title: 'Cam 7'        },
      { key: 'lastone', title: 'Sineflex'     },
    ];

    const cardsEl = document.getElementById('cards');
    const lkStatusEl = document.getElementById('lkStatus');
    const roomSel = document.getElementById('roomSel');
    const displayName = document.getElementById('displayName');
    const pairBtn = document.getElementById('pairBtn');
    const publishBtn = document.getElementById('publishBtn');
    const stopBtn = document.getElementById('stopBtn');

    // ---------- توليد بطاقات الفيديو ----------
    function makeCard(src) {
      const id = `card-${src.key}`;
      const url = `${HLS_PROXY_BASE}/hls/${src.key}/playlist.m3u8`;
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <header>
          <div class="name">
            <span class="dot live"></span>
            <strong>${src.title}</strong>
          </div>
          <small class="mono">${url}</small>
        </header>
        <video id="${id}" playsinline muted controls></video>
        <footer>
          <button class="btn" data-act="play">تشغيل</button>
          <button class="btn" data-act="pause">إيقاف</button>
          <span class="pill mono" data-role="state">HLS: idle</span>
        </footer>
      `;
      cardsEl.appendChild(el);

      // ربط HLS
      const video = el.querySelector('video');
      const state = el.querySelector('[data-role=state]');
      const hp = new HlsPlayer(video, state);
      hp.attach(url);

      el.querySelector('[data-act=play]').onclick  = () => video.play();
      el.querySelector('[data-act=pause]').onclick = () => video.pause();

      return el;
    }

    SOURCES.forEach(makeCard);

    // ---------- LiveKit (اقتران/نشر/إيقاف) ----------
    const lk = new LiveKitPublisher({
      statusEl: lkStatusEl,
      Livekit: window.livekitClient,
      tokenApi: LK_TOKEN_API,
    });

    pairBtn.onclick = async () => {
      try {
        await lk.pairDevices();
        publishBtn.disabled = false;
        pairBtn.classList.add('primary');
      } catch (e) {
        alert('تعذّر الوصول للكاميرا/المايك: ' + e.message);
      }
    };

    publishBtn.onclick = async () => {
      publishBtn.disabled = true;
      try {
        await lk.joinAndPublish({
          room: roomSel.value,
          identity: displayName.value || ('user-' + crypto.randomUUID().slice(0,8)),
        });
        stopBtn.disabled = false;
        alert('تم النشر بنجاح ✅');
      } catch (e) {
        console.error(e);
        alert('تعذّر نشر الصوت/الفيديو:\n' + (e.userMessage || e.message || e));
        publishBtn.disabled = false;
      }
    };

    stopBtn.onclick = async () => {
      try { await lk.stop(); } finally {
        stopBtn.disabled = true;
        publishBtn.disabled = false;
      }
    };

    // UI بسيط لملء الشاشة
    window.addEventListener('keydown', (e)=>{
      if (e.key.toLowerCase() === 'f') document.documentElement.requestFullscreen?.();
    });
  </script>
</body>
</html>
