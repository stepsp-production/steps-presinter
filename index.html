<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Steps Co VIP Player</title>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%2300c19a'/%3E%3C/svg%3E" />

  <style>
    :root{ --btn-bg:#00c19a; --btn-bg-h:#00ad8a; --btn-bg-a:#009e7e; --btn-txt:#fff; --panel-bg:#0b0b0fe6; --panel-bd:#ffffff26; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

    #playerContainer{position:relative;width:100vw;height:100vh}
    .videoFrame{position:absolute;top:0;right:0;width:100%;height:100%;background:#000;overflow:hidden}
    .videoFrame video{width:100%;height:100%;object-fit:contain;background:#000}

    #mainPreview{position:absolute;top:16px;right:20px;width:22%;height:24%;z-index:6;border:1px solid #fff2;border-radius:18px;cursor:pointer;transition:transform .18s,box-shadow .18s,width .18s,height .18s,top .18s,right .18s,left .18s}
    #mainPreview:hover{box-shadow:0 10px 30px #0008}

    .split #mainPreview{top:0;right:0;width:50%;height:100%;border:0;border-radius:0;cursor:default}
    .split #activeCam{top:0;left:0;right:auto;width:50%;height:100%}
    .split.mode1 #mainPreview video,.split.mode1 #activeCam video{object-fit:contain}
    .split.mode2 #mainPreview video,.split.mode2 #activeCam video{object-fit:contain; transform:scale(1.08)}
    .split.mode3 #mainPreview video,.split.mode3 #activeCam video{object-fit:cover}

    .main-full #mainPreview{top:0;right:0;width:100%;height:100%;z-index:7;border:0;border-radius:0;cursor:zoom-out}
    .main-full #activeCam{display:none}
    .main-full.cover-one #mainPreview video{object-fit:cover}

    .hint{position:absolute;top:20px;right:20px;z-index:8;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
    .split .hint,.main-full .hint{display:none}

    #streamPanel{position:absolute; top:0; left:0; height:100%; width:230px; z-index:12; color:#fff; padding:12px 10px;}
    #streamPanel .panel-title{font-weight:900;letter-spacing:.8px;margin:6px 6px 12px;font-size:13px;text-shadow:0 1px 2px #000}
    #streamList{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;max-height:calc(100% - 48px);overflow:auto}
    .stream-item{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer;background:rgba(0,0,0,.30); border:1px solid rgba(255,255,255,.20); backdrop-filter: blur(2px); transition:background .12s, border-color .12s}
    .stream-item:hover{background:rgba(0,0,0,.38);border-color:#ffffff35}
    .stream-item.active{background:rgba(0,0,0,.55);border-color:#ffffff60}
    .stream-name{font-weight:800; font-size:12px; letter-spacing:.4px; text-transform:uppercase}
    .status-dot{width:8px;height:8px;border-radius:999px;background:#999;border:1px solid #0005}

    #utilityControls,#globalControls{position:absolute;z-index:12;display:flex;gap:8px;flex-wrap:wrap;transition:opacity .18s}
    #utilityControls{top:10px;right:10px}
    #globalControls{bottom:70px;left:50%;transform:translateX(-50%);background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd);align-items:center;min-width:340px}
    #globalControls.hidden{display:none}

    button{-webkit-tap-highlight-color:transparent;appearance:none;border:0;outline:0;cursor:pointer;background:var(--btn-bg);color:var(--btn-txt);padding:11px 12px;font-size:12px;font-weight:800;border-radius:12px;letter-spacing:.2px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 18px #000a,0 0 0 0 rgba(0,193,154,.28);transition:transform .12s,box-shadow .12s,background .12s}
    button:hover{background:var(--btn-bg-h);box-shadow:0 12px 26px #000c,0 0 0 6px rgba(0,193,154,.28)}
    button:active{background:var(--btn-bg-a);transform:translateY(1px)}
    #scrub{-webkit-appearance:none;appearance:none;width:320px;height:6px;border-radius:999px;background:#ffffff30;outline:none;margin:0 8px}
    #scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #0006;cursor:pointer}
    #timeLabel{color:#fff;font-size:12px;min-width:108px;text-align:center}

    #gatePlay{position:absolute;inset:0;z-index:9;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2))}
    #gatePlay.hidden{display:none}
    .gate-card{background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .gate-card .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--panel-bd);color:#fff;background:#111a;font-size:18px}
    #startBtn{min-width:160px}

    #sysBanner{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:15;background:#000c;color:#fff;border:1px solid #fff2;padding:6px 10px;border-radius:999px;font-size:12px;display:none}
    #sysBanner.show{display:block}

    .ui-hidden #streamPanel,
    .ui-hidden #utilityControls,
    .ui-hidden #globalControls{opacity:0; pointer-events:none}
    .ui-visible #streamPanel,
    .ui-visible #utilityControls,
    .ui-visible #globalControls{opacity:1; pointer-events:auto}

    @media (orientation: portrait){
      #mainPreview{top:12px;right:14px;width:58vw;height:36vh;border-radius:18px}
      #globalControls{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 8px);left:50%;transform:translateX(-50%);width:min(94vw,560px);padding:8px 10px;z-index:9999}
      #scrub{width:clamp(140px,56vw,380px)}
      #streamPanel{width:190px}
    }

    #lkPanel{position:fixed;bottom:10px;right:10px;z-index:20;display:flex;gap:8px;background:#0b0b0fe6;border:1px solid #ffffff26;padding:10px;border-radius:12px;align-items:center}
    #lkPanel input, #lkPanel select{padding:6px 8px;border-radius:8px;border:1px solid #ffffff26;background:#111;color:#fff;min-width:110px}
    #lkPanel .icon{font-size:14px}
    #lkState{color:#fff;font-size:12px;margin-inline-start:6px}
  </style>
</head>
<body>
  <div id="playerContainer" class="ui-visible" aria-label="مشغّل متعدد الكاميرات">
    <aside id="streamPanel" aria-label="مصادر البث">
      <div class="panel-title">SOURCES</div>
      <ul id="streamList"></ul>
    </aside>

    <div id="activeCam" class="videoFrame" aria-label="الكاميرا النشطة"></div>
    <div id="mainPreview" class="videoFrame" title="انقر للتكبير/التصغير" aria-label="المعاينة الرئيسية المصغّرة"></div>
    <div class="hint">انقر على المعاينة للتكبير • أو اضغط F</div>

    <div id="gatePlay" role="dialog" aria-modal="true" aria-label="بدء التشغيل">
      <div class="gate-card">
        <div class="icon">▶</div>
        <div>
          <div style="color:#fff;font-weight:800;margin-bottom:6px">ابدأ التشغيل والمزامنة</div>
          <div style="font-size:12px;color:#eaeaf0b3">سيظهر شريط التقديم/التأخير بعد الضغط على تشغيل</div>
        </div>
        <button id="startBtn" aria-label="ابدأ التشغيل الآن">تشغيل/بدء المزامنة</button>
      </div>
    </div>

    <div id="utilityControls" role="toolbar" aria-label="أدوات">
      <button id="btnSplit" title="تقسيم"><span class="icon">🧩</span> تقسيم</button>
      <button id="btnFill"  title="ملء"><span class="icon">🖼️</span> ملء</button>
      <button id="btnSound" title="صوت"><span class="icon">🔊</span> صوت</button>
    </div>

    <div id="globalControls" class="hidden" role="group" aria-label="تحكم موحّد">
      <button id="gBack" title="⏪ -5s">⏪ 5s</button>
      <button id="gPlay" title="⏯">⏯</button>
      <button id="gFwd"  title="+5s ⏩">5s ⏩</button>
      <input id="scrub" type="range" min="0" max="0" value="0" step="0.01" aria-label="شريط التقدم">
      <div id="timeLabel">00:00 / 00:00</div>
      <div style="margin-inline-start:8px;color:#fff;font-size:12px;display:flex;align-items:center;gap:6px">
        <span>SYNC</span><span id="syncDot" style="width:9px;height:9px;border-radius:50%;background:#666;display:inline-block;border:1px solid #0008"></span>
      </div>
    </div>

    <div id="sysBanner"></div>
  </div>

  <div id="lkPanel" aria-label="LiveKit">
    <span style="color:#fff;font-weight:700;margin-inline-end:6px">LiveKit</span>
    <input id="lkName" placeholder="اسمك" />
    <select id="lkRoom">
      <option>studio-1</option><option>studio-2</option><option>studio-3</option>
      <option>studio-4</option><option>studio-5</option><option>studio-6</option>
      <option>studio-7</option><option>studio-8</option><option>studio-9</option><option>studio-10</option>
    </select>
    <button id="lkJoin" title="انضمام"><span class="icon">🔗</span> انضم</button>
    <button id="lkLeave" title="مغادرة" disabled><span class="icon">↩️</span> غادر</button>
    <button id="lkToggleCam" title="الكاميرا" disabled><span class="icon" id="camIcon">📷</span></button>
    <button id="lkToggleMic" title="المايك" disabled><span class="icon" id="micIcon">🎙️</span></button>
    <span id="lkState">جاهز</span>
  </div>

  <script>
    const qh = new URLSearchParams(location.search).get('h');
    window.HLS_BASE = (qh && qh.trim()) || "https://hls-proxy.it-f2c.workers.dev";
    window.API_BASE = "https://steps-livekit-api.onrender.com";
    window.LK_URL = "wss://presinter-stream-gjthpz2z.livekit.cloud";
  </script>

  <!-- HLS من نطاقك -->
  <script defer src="/vendor/hls.min.js"></script>

  <script>
  const sysBanner=(()=>{const el=document.getElementById('sysBanner');return{show:(m)=>{try{el.textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),4500);}catch(_){console.log(m)}}}})();

  async function checkM3U8(url, timeout=6000){
    try{
      const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeout);
      const r=await fetch(url,{signal:ctrl.signal,mode:'cors',cache:'no-store'});
      clearTimeout(t);
      if(!r.ok) return {ok:false, status:r.status};
      const txt=await r.text();
      return {ok:txt.trim().startsWith('#EXTM3U'), status:r.status};
    }catch(e){ return {ok:false, err:e}; }
  }

  (function buildSources(){
    const BASE=(window.HLS_BASE||"").replace(/\/$/,"");
    const build=(p)=>BASE?`${BASE}${p}`:p;
    window.sources={
      main:build("/hls/live/playlist.m3u8"),
      cam1:build("/hls/lastone/playlist.m3u8"),
      cam2:build("/hls/live2/playlist.m3u8"),
      cam3:build("/hls/live3/playlist.m3u8"),
      cam4:build("/hls/live4/playlist.m3u8"),
      cam5:build("/hls/live5/playlist.m3u8"),
      cam6:build("/hls/live6/playlist.m3u8"),
      cam7:build("/hls/live7/playlist.m3u8")
    };
    const channelMap=[
      {id:'main',label:'MAIN',src:sources.main},
      {id:'cam1',label:'CAM1',src:sources.cam1},
      {id:'cam2',label:'CAM2',src:sources.cam2},
      {id:'cam3',label:'CAM3',src:sources.cam3},
      {id:'cam4',label:'CAM4',src:sources.cam4},
      {id:'cam5',label:'CAM5',src:sources.cam5},
      {id:'cam6',label:'DRONE',src:sources.cam6},
      {id:'cam7',label:'SINEFLEX',src:sources.cam7},
    ];
    window.channelMap = channelMap;
  })();

  (async function buildStreamList(){
    const ul=document.getElementById('streamList');
    ul.innerHTML='';
    for(const ch of window.channelMap){
      const li=document.createElement('li');
      li.className='stream-item';
      li.dataset.id=ch.id;

      const dot=document.createElement('span'); dot.className='status-dot'; dot.style.background='#666';
      const name=document.createElement('div'); name.className='stream-name'; name.textContent=ch.label;

      li.appendChild(dot); li.appendChild(name);
      li.onclick=()=>selectActive(ch.id);
      ul.appendChild(li);

      checkM3U8(ch.src, 5000).then(res=>{ dot.style.background = res.ok ? '#10b981' : '#ef4444'; }).catch(()=>{ dot.style.background='#ef4444';});
    }
  })();

  function createVideo(parent){
    parent.innerHTML='';
    const v=document.createElement('video');
    v.playsInline=true; v.controls=false; v.preload='auto'; v.muted=true; v.setAttribute('muted','');
    parent.appendChild(v); return v;
  }
  const hlsSupported=()=>!!(window.Hls && window.Hls.isSupported && window.Hls.isSupported());

  function attachHls(video, src, {timeoutMs=10000}={}){
    return new Promise(async(resolve)=>{
      if(!video){ resolve(false); return; }
      const finish=(ok)=>{ clearTimeout(tid); resolve(!!ok); };
      const tid=setTimeout(()=>{ console.warn('HLS timeout',src); finish(false); }, timeoutMs);

      const onError=(data)=>{
        const code = data?.response?.code || data?.response?.status || 0;
        if(code===502 || code===404){ sysBanner.show('فشل تحميل الفيديو: تحقّق من HLS_BASE أو بدّله عبر ?h=...'); }
      };

      if(hlsSupported()){
        try{
          const h=new window.Hls({lowLatencyMode:true,enableWorker:true,backBufferLength:90,liveSyncDurationCount:3});
          h.on(window.Hls.Events.ERROR,(_e,data)=>onError(data));
          h.on(window.Hls.Events.MANIFEST_PARSED,()=>finish(true));
          h.loadSource(src); h.attachMedia(video);
        }catch(_){ finish(false); }
      }else{
        video.src=src;
        const ok=()=>finish(true), bad=()=>finish(false);
        try{ video.addEventListener('loadedmetadata',ok,{once:true}); video.addEventListener('error',bad,{once:true}); video.load(); }catch(_){ finish(false); }
      }
    });
  }

  function isReady(v){ return !!(v && v.readyState >= 2); }
  function waitCanPlay(v, timeout=8000){
    return new Promise((res)=>{
      if(!v){ res(false); return; }
      if(isReady(v)) return res(true);
      let done=false;
      const on=()=>{ if(!done){ done=true; cleanup(); res(true); } };
      const to=setTimeout(()=>{ if(!done){ done=true; cleanup(); res(false); } }, timeout);
      function cleanup(){ try{ v.removeEventListener('canplay',on); }catch(_){ } clearTimeout(to); }
      try{ v.addEventListener('canplay',on,{once:true}); v.load(); }catch(_){ res(false); }
    });
  }
  async function safePlay(v){
    try{ await v.play(); return true; }
    catch(_){ try{ v.muted=true; v.setAttribute('muted',''); await v.play(); return true; }catch(__){ return false; } }
  }
  function getSeekableRange(v){ try{ if(v.seekable&&v.seekable.length){ return {start:v.seekable.start(0), end:v.seekable.end(0)}; } }catch(_){ } return null; }
  function snapIntoBuffer(v,t){ try{ const r=getSeekableRange(v); if(!r) return t; if(t<r.start) return r.start+0.05; if(t>r.end) return r.end-0.05; return t; }catch(_){ return t; } }

  const mainPreviewEl=document.getElementById('mainPreview');
  const activeCamEl=document.getElementById('activeCam');

  let mainPlayer=null, activePlayer=null, started=false, tickerId=null;

  async function selectActive(id){
    const ch=window.channelMap.find(x=>x.id===id);
    if(!ch) return;
    document.querySelectorAll('.stream-item').forEach(li=>li.classList.toggle('active', li.dataset.id===id));
    if(!activePlayer) activePlayer=createVideo(activeCamEl);
    const ok = await attachHls(activePlayer, ch.src);
    if(started && ok) await safePlay(activePlayer);
  }

  async function initPlayers(){
    mainPlayer=createVideo(mainPreviewEl);
    const res = await checkM3U8(window.sources.main, 6000);
    let mainSrc = window.sources.main;
    if(!res.ok){
      sysBanner.show('المصدر الرئيسي غير متاح، سيتم استخدام CAM2 كبديل.');
      mainSrc = (window.sources.cam2 || window.sources.main);
    }
    const okMain = await attachHls(mainPlayer, mainSrc);
    activePlayer=createVideo(activeCamEl);
    const okCam  = await attachHls(activePlayer, (window.channelMap.find(x=>x.id!=='main')||{}).src || mainSrc);
    if(!okMain || !okCam){ sysBanner.show('مصادر الفيديو غير جاهزة (قد يكون 502/404).'); }
  }

  const gatePlay=document.getElementById('gatePlay');
  const globalControls=document.getElementById('globalControls');
  const timeLabel=document.getElementById('timeLabel');
  const scrub=document.getElementById('scrub');
  const syncDot=document.getElementById('syncDot');

  function startTimeTicker(){
    stopTimeTicker();
    const fmt=(t)=>{t=Math.max(0,t|0); const m=(t/60)|0,s=(t%60)|0; return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;};
    tickerId=setInterval(()=>{ try{
      if(!mainPlayer) return;
      const cur=mainPlayer.currentTime||0;
      const dur=Math.max(cur,(getSeekableRange(mainPlayer)?.end||cur));
      scrub.max=(dur||0).toFixed(2); scrub.value=(cur||0).toFixed(2);
      timeLabel.textContent=`${fmt(cur)} / ${fmt(dur)}`;

      if(activePlayer){
        const diff=Math.abs((activePlayer.currentTime||0)-(mainPlayer.currentTime||0));
        syncDot.style.background = diff<=0.4 ? '#10b981' : '#f59e0b';
      }
    }catch(_){ } },250);
  }
  function stopTimeTicker(){ if(tickerId){ clearInterval(tickerId); tickerId=null; } }

  async function startPlayback(){
    if(started) return;
    if(!mainPlayer || !activePlayer){ sysBanner.show('لم تُجهّز المشغلات بعد.'); return; }
    const okMainReady = await waitCanPlay(mainPlayer,8000);
    const okCamReady  = await waitCanPlay(activePlayer,8000);
    if(!okMainReady){ sysBanner.show('المصدر الرئيسي غير جاهز. غيّر HLS_BASE أو جرّب ?h=...'); return; }
    await safePlay(mainPlayer);
    if(okCamReady) await safePlay(activePlayer);
    started=true; gatePlay.classList.add('hidden'); globalControls.classList.remove('hidden'); startTimeTicker();
  }

  document.getElementById('startBtn').addEventListener('click', startPlayback);

  (function autoUI(){
    const root=document.getElementById('playerContainer');
    let uiTimer=null;
    function showUI(){root.classList.remove('ui-hidden');root.classList.add('ui-visible');clearTimeout(uiTimer);uiTimer=setTimeout(()=>{root.classList.add('ui-hidden');root.classList.remove('ui-visible');},2200);}
    ['mousemove','touchstart','keydown'].forEach(ev=>document.addEventListener(ev,showUI,{passive:true}));
    showUI();
  })();

  document.getElementById('btnSplit').addEventListener('click', ()=>{
    const root=document.getElementById('playerContainer');
    const modes=['','mode1','mode2','mode3'];
    if(!root.classList.contains('split')){ root.classList.add('split','mode1'); return; }
    const m = modes.findIndex(md=>root.classList.contains(md));
    root.classList.remove('mode1','mode2','mode3');
    if(m===1) root.classList.add('mode2'); else if(m===2) root.classList.add('mode3'); else root.classList.remove('split');
  });
  document.getElementById('btnFill').addEventListener('click', ()=>{
    const c=document.getElementById('playerContainer');
    if(c.classList.contains('main-full')) c.classList.remove('main-full','cover-one');
    else { c.classList.add('main-full'); setTimeout(()=>c.classList.toggle('cover-one'),50); }
  });
  document.getElementById('btnSound').addEventListener('click', ()=>{ if(!mainPlayer) return; mainPlayer.muted=!mainPlayer.muted; sysBanner.show(mainPlayer.muted?'تم كتم الصوت':'تم تشغيل الصوت');});
  document.getElementById('gPlay').addEventListener('click', async ()=>{ if(!started){ await startPlayback(); return; } if(mainPlayer.paused){ await safePlay(mainPlayer); if(activePlayer) await safePlay(activePlayer);} else { mainPlayer.pause(); if(activePlayer) activePlayer.pause(); }});
  document.getElementById('gBack').addEventListener('click', ()=>{ try{ const t=Math.max(0,(mainPlayer.currentTime||0)-5); mainPlayer.currentTime=snapIntoBuffer(mainPlayer,t); if(activePlayer) activePlayer.currentTime=snapIntoBuffer(activePlayer,t);}catch(_){ }});
  document.getElementById('gFwd').addEventListener('click', ()=>{ try{ const t=(mainPlayer.currentTime||0)+5; mainPlayer.currentTime=snapIntoBuffer(mainPlayer,t); if(activePlayer) activePlayer.currentTime=snapIntoBuffer(activePlayer,t);}catch(_){ }});
  document.getElementById('mainPreview').addEventListener('click', ()=>{ const c=document.getElementById('playerContainer'); c.classList.toggle('main-full'); });
  window.addEventListener('keydown',(e)=>{ if(e.key.toLowerCase()==='f'){ document.getElementById('playerContainer').classList.toggle('main-full'); } });

  (async function init(){ try{ await initPlayers(); }catch(e){ console.error(e); sysBanner.show('فشل التهيئة. تحقق من HLS_BASE/CORS.'); } })();
  </script>

  <!-- LiveKit -->
  <script>
    function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>res(); s.onerror=()=>rej(new Error('script load failed: '+src)); document.head.appendChild(s); }); }
    async function ensureLiveKit(){
      let LK = window.LivekitClient || window.livekitClient || window.LiveKit || window.livekit;
      if(!LK){
        await loadScript('/vendor/livekit-client.umd.min.js').catch(()=>{});
        LK = window.LivekitClient || window.livekitClient || window.LiveKit || window.livekit;
      }
      if(!LK) throw new Error('LiveKit library did not load');
      return LK;
    }

    let lkRoom=null, camOn=false, micOn=false;
    const lkStateEl=document.getElementById('lkState');
    const camIcon=document.getElementById('camIcon');
    const micIcon=document.getElementById('micIcon');
    const btnJoin=document.getElementById('lkJoin');
    const btnLeave=document.getElementById('lkLeave');
    const btnCam=document.getElementById('lkToggleCam');
    const btnMic=document.getElementById('lkToggleMic');

    async function joinLiveKit(){
      try{
        await navigator.mediaDevices.getUserMedia({video:true,audio:true}).catch(()=>{});
        const LK = await ensureLiveKit();

        const roomName = (document.getElementById('lkRoom')||{}).value || 'studio-1';
        const identity = (document.getElementById('lkName')||{}).value || ('guest-'+Math.random().toString(36).slice(2,7));
        const url = `${window.API_BASE}/api/token?room=${encodeURIComponent(roomName)}&identity=${encodeURIComponent(identity)}`;
        const r = await fetch(url,{cache:'no-store'});
        let token='', wsUrl=window.LK_URL;
        try{ const j=await r.json(); token=j.token||j.accessToken||j.jwt||''; wsUrl=j.url||j.wsUrl||wsUrl; }catch{ token=await r.text(); }
        if(!token) throw new Error('token missing');
        if(!wsUrl) throw new Error('wsUrl missing');

        // ====== التصحيح المهم هنا ======
        if (typeof LK.connect === 'function') {
          lkRoom = await LK.connect(wsUrl, token, { autoSubscribe:true, stopLocalTrackOnUnpublish:true });
        } else {
          const room = new LK.Room({ autoSubscribe:true, stopLocalTrackOnUnpublish:true, adaptiveStream:true });
          await room.connect(wsUrl, token);
          lkRoom = room;
        }

        lkStateEl.textContent='متصل';
        btnLeave.disabled=false; btnCam.disabled=false; btnMic.disabled=false;

        await toggleCam(true);
        await toggleMic(true);
        alert('تم الانضمام');
      }catch(err){ console.error('joinLiveKit error',err); alert('تعذّر الانضمام: '+(err?.message||err)); }
    }

    async function leaveLiveKit(){
      try{
        if(lkRoom){
          await toggleCam(false); await toggleMic(false);
          lkRoom.disconnect?.(); lkRoom=null;
          lkStateEl.textContent='تمت المغادرة';
          btnLeave.disabled=true; btnCam.disabled=true; btnMic.disabled=true;
        }
      }catch(_){}
    }

    async function toggleCam(state){
      camOn = (typeof state==='boolean') ? state : !camOn;
      if(!lkRoom) return;
      try{
        if(camOn){
          const LK = await ensureLiveKit();
          const vt = await (LK.createLocalVideoTrack ? LK.createLocalVideoTrack() : (await LK.createLocalTracks({video:true})).find(t=>t.kind==='video'));
          if(vt) await lkRoom.localParticipant.publishTrack(vt);
          camIcon.textContent='📷'; camOn=true;
        }else{
          lkRoom.localParticipant?.videoTracks?.forEach(pub=>{ try{ lkRoom.localParticipant.unpublishTrack(pub.track, true); }catch(_){ } });
          camIcon.textContent='🚫'; camOn=false;
        }
      }catch(e){ console.warn('toggleCam',e); }
    }

    async function toggleMic(state){
      micOn = (typeof state==='boolean') ? state : !micOn;
      if(!lkRoom) return;
      try{
        if(micOn){
          const LK = await ensureLiveKit();
          const at = await (LK.createLocalAudioTrack ? LK.createLocalAudioTrack() : (await LK.createLocalTracks({audio:true})).find(t=>t.kind==='audio'));
          if(at) await lkRoom.localParticipant.publishTrack(at);
          micIcon.textContent='🎙️'; micOn=true;
        }else{
          lkRoom.localParticipant?.audioTracks?.forEach(pub=>{ try{ lkRoom.localParticipant.unpublishTrack(pub.track, true); }catch(_){ } });
          micIcon.textContent='🔇'; micOn=false;
        }
      }catch(e){ console.warn('toggleMic',e); }
    }

    btnJoin.addEventListener('click', joinLiveKit);
    btnLeave.addEventListener('click', leaveLiveKit);
    btnCam.addEventListener('click', ()=>toggleCam());
    btnMic.addEventListener('click', ()=>toggleMic());
  </script>
</body>
</html>
