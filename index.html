<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />

<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
  style-src  'self' 'unsafe-inline';
  img-src    'self' data:;
  font-src   'self' data:;
  media-src  * blob:;
  connect-src 'self'
               https://hls-proxy.it-f2c.workers.dev
               https://*.trycloudflare.com
               https://steps-livekit-api.onrender.com
               https://cdn.jsdelivr.net
               wss://*.livekit.cloud;
  worker-src 'self' blob:;
  child-src  'self' blob:;
">

  <meta http-equiv="Permissions-Policy" content="camera=(self), microphone=(self)">

  <link rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%2300c19a'/%3E%3C/svg%3E" />

  <style>
    :root{ --btn-bg:#00c19a; --btn-bg-h:#00ad8a; --btn-bg-a:#009e7e; --btn-txt:#fff;
           --panel-bg:#0b0b0fe6; --panel-bd:#ffffff26; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

    #playerContainer{position:relative;width:100vw;height:100vh}
    .videoFrame{position:absolute;top:0;right:0;width:100%;height:100%;background:#000;overflow:hidden}

    #mainPreview{position:absolute;top:16px;right:20px;width:22%;height:24%;z-index:6;border:1px solid #fff2;border-radius:18px;cursor:pointer;transition:transform .18s,box-shadow .18s,width .18s,height .18s,top .18s,right .18s,left .18s}
    #mainPreview:hover{box-shadow:0 10px 30px #0008}
    #mainPreview video{display:block;width:100%;height:100%;object-fit:contain}

    .split #mainPreview{top:0;right:0;width:50%;height:100%;border:0;border-radius:0;cursor:default}
    .split #activeCam{top:0;left:0;right:auto;width:50%;height:100%}

    .split.mode1 #mainPreview video,.split.mode1 #activeCam video{object-fit:contain}
    .split.mode2 #mainPreview video,.split.mode2 #activeCam video{object-fit:contain;transform:scale(1.08);transform-origin:center}
    .split.mode3 #mainPreview video,.split.mode3 #activeCam video{object-fit:cover}

    .main-full #mainPreview{top:0;right:0;width:100%;height:100%;z-index:7;border:0;border-radius:0;cursor:zoom-out}
    .main-full #activeCam{display:none}
    .main-full.cover-one #mainPreview video{object-fit:cover}

    .hint{position:absolute;top:20px;right:20px;z-index:8;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
    .split .hint,.main-full .hint{display:none}

    #utilityControls,#globalControls{position:absolute;z-index:12;display:flex;gap:8px;flex-wrap:wrap;transition:opacity .18s}
    #utilityControls{top:10px;right:10px}
    #globalControls{bottom:70px;left:50%;transform:translateX(-50%);background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd);align-items:center;min-width:340px}
    #globalControls.hidden{display:none}

    button{-webkit-tap-highlight-color:transparent;appearance:none;border:0;outline:0;cursor:pointer;background:var(--btn-bg);color:var(--btn-txt);padding:11px 12px;font-size:12px;font-weight:800;border-radius:12px;letter-spacing:.2px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 18px #000a,0 0 0 0 rgba(0,193,154,.28);transition:transform .12s,box-shadow .12s,background .12s}
    button:hover{background:var(--btn-bg-h);box-shadow:0 12px 26px #000c,0 0 0 6px rgba(0,193,154,.28)}
    button:active{background:var(--btn-bg-a);transform:translateY(1px)}

    #scrub{-webkit-appearance:none;appearance:none;width:320px;height:6px;border-radius:999px;background:#ffffff30;outline:none;margin:0 8px}
    #scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #0006;cursor:pointer}
    #timeLabel{color:#fff;font-size:12px;min-width:108px;text-align:center}

    #gatePlay{position:absolute;inset:0;z-index:9;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2))}
    #gatePlay.hidden{display:none}
    .gate-card{background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .gate-card .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--panel-bd);color:#fff;background:#111a;font-size:18px}
    #startBtn{min-width:160px}

    #streamPanel{position:absolute;top:0;left:0;height:100%;width:230px;z-index:12;background:none;border-right:none;padding:12px 10px;color:#fff;transition:opacity .18s;pointer-events:auto}
    #streamPanel .panel-title{font-weight:900;letter-spacing:.8px;margin:6px 6px 12px;font-size:13px;text-shadow:0 1px 2px #000}
    #streamList{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;max-height:calc(100% - 48px);overflow:auto}
    .stream-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;cursor:pointer;background:rgba(0,0,0,.30);border:1px solid rgba(255,255,255,.20);backdrop-filter:blur(2px);transition:background .12s,border-color .12s,transform .06s}
    .stream-item:hover{background:rgba(0,0,0,.38);border-color:#ffffff35}
    .stream-item.active{background:rgba(0,0,0,.55);border-color:#ffffff60}
    .stream-name{font-weight:800;font-size:12px;letter-spacing:.4px;text-transform:uppercase}

    .ui-hidden #streamPanel,.ui-hidden #utilityControls,.ui-hidden #globalControls{opacity:0;pointer-events:none}
    .ui-visible #streamPanel,.ui-visible #utilityControls,.ui-visible #globalControls{opacity:1;pointer-events:auto}

    .layer{position:absolute;inset:0}
    .fade-in{animation:fadeIn .18s ease forwards}
    .fade-out{animation:fadeOut .18s ease forwards}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeOut{from{opacity:1}to{opacity:0}}

    @media (orientation:portrait){
      #mainPreview{top:12px;right:14px;width:58vw;height:36vh;border-radius:18px}
      #globalControls{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 8px);left:50%;transform:translateX(-50%);width:min(94vw,560px);padding:8px 10px;z-index:9999}
      #scrub{width:clamp(140px,56vw,380px)}
      #streamPanel{width:190px}
    }

    .chrome{position:fixed;top:12px;inset-inline:12px;z-index:20}
    .bar{background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:16px;padding:10px;display:flex;gap:10px;align-items:center}
    .field{display:flex;align-items:center;gap:6px}
    .btn{padding:10px 12px;border-radius:10px}
    .ok{background:#0fb}.warn{background:#f66}
    .pill{background:#1118;padding:6px 10px;border-radius:999px;border:1px solid #fff2;color:#fff}
    input,select{padding:8px 10px;border-radius:10px;border:1px solid #fff3;background:#111a;color:#fff;min-width:160px}
  </style>
</head>

<body>
  <div id="playerContainer" class="ui-visible" aria-label="مشغّل متعدد الكاميرات">
    <aside id="streamPanel" aria-label="مصادر البث">
      <div class="panel-title">SOURCES</div>
      <ul id="streamList"></ul>
    </aside>

    <div id="activeCam" class="videoFrame" aria-label="الكاميرا النشطة"></div>
    <div id="mainPreview" class="videoFrame" title="انقر للتكبير/التصغير" aria-label="المعاينة الرئيسية المصغّرة"></div>
    <div class="hint">انقر على المعاينة للتكبير • أو اضغط F</div>

    <div id="gatePlay" role="dialog" aria-modal="true" aria-label="بدء التشغيل">
      <div class="gate-card">
        <div class="icon">▶</div>
        <div>
          <div style="color:#fff;font-weight:800;margin-bottom:6px">ابدأ التشغيل والمزامنة</div>
          <div style="font-size:12px;color:#eaeaf0b3">سيظهر شريط التقديم/التأخير بعد الضغط على تشغيل</div>
        </div>
        <button id="startBtn" aria-label="ابدأ التشغيل الآن">تشغيل/بدء المزامنة</button>
      </div>
    </div>

    <div id="utilityControls" role="toolbar" aria-label="أدوات">
      <button id="btnSplit" aria-label="تبديل وضع التقسيم" title="تقسيم">تقسيم</button>
      <button id="btnFill"  aria-label="تبديل ملء المحتوى" title="ملء">ملء</button>
      <button id="btnSound" aria-label="تشغيل/إيقاف الصوت" title="صوت">🔊/🔇</button>
    </div>

    <div id="globalControls" class="hidden" role="group" aria-label="تحكم موحّد">
      <button id="gBack" title="⏪ -5s">⏪ 5s</button>
      <button id="gPlay" title="⏯">⏯</button>
      <button id="gFwd"  title="+5s ⏩">5s ⏩</button>
      <input id="scrub" type="range" min="0" max="0" value="0" step="0.01" aria-label="شريط التقدم">
      <div id="timeLabel">00:00 / 00:00</div>
    </div>
  </div>

  <div class="chrome" id="chrome">
    <div class="bar">
      <h1 style="margin-inline-end:8px">لوحة البث المتعدد</h1>
      <div class="field">
        <label>الغرفة:</label>
        <select id="roomSel">
          <option value="room-1">room-1</option><option value="room-2">room-2</option>
          <option value="room-3">room-3</option><option value="room-4">room-4</option>
          <option value="room-5">room-5</option><option value="room-6">room-6</option>
          <option value="room-7">room-7</option><option value="room-8">room-8</option>
          <option value="room-9">room-9</option><option value="room-10">room-10</option>
        </select>
      </div>
      <div class="field">
        <label>الهوية/الاسم:</label>
        <input id="displayName" placeholder="اسم المتحدث" />
      </div>
      <button id="pairBtn" class="btn">سماح (اقتران)</button>
      <button id="publishBtn" class="btn ok" disabled>تشغيل (نشر)</button>
      <button id="stopBtn" class="btn warn" disabled>إيقاف</button>
      <span class="pill">الحالة: <b id="lkStatus">LiveKit: غير متصل</b></span>
    </div>
  </div>

  <!-- توجيه عبر ورَكر -->
  <script>window.HLS_BASE="https://hls-proxy.it-f2c.workers.dev";</script>

  <!-- مصادر البث -->
  <script>
    (function(){
      const BASE=(window.HLS_BASE||"").replace(/\/$/,"");
      const build=(p)=>BASE?`${BASE}${p}`:p;
      window.sources={
        main:build("/hls/live/playlist.m3u8"),
        cam1:build("/hls/lastone/playlist.m3u8"),
        cam2:build("/hls/live2/playlist.m3u8"),
        cam3:build("/hls/live3/playlist.m3u8"),
        cam4:build("/hls/live4/playlist.m3u8"),
        cam5:build("/hls/live5/playlist.m3u8"),
        cam6:build("/hls/live6/playlist.m3u8"),
        cam7:build("/hls/live7/playlist.m3u8")
      };
      window.channelMap=[
        {id:'main',label:'MAIN',src:sources.main},
        {id:'cam1',label:'Cam1',src:sources.cam1},
        {id:'cam2',label:'Cam2',src:sources.cam2},
        {id:'cam3',label:'Cam3',src:sources.cam3},
        {id:'cam4',label:'Cam4',src:sources.cam4},
        {id:'cam5',label:'Cam5',src:sources.cam5},
        {id:'cam6',label:'Drone',src:sources.cam6},
        {id:'cam7',label:'Sineflex',src:sources.cam7},
      ];
    })();
  </script>

  <!-- تحميل hls -->
<script src="/vendor/hls.min.js" defer></script>

<!-- تحميل LiveKit SDK من CDN -->
<script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js" crossorigin="anonymous"></script>

<!-- تطبيق الصفحة -->
<script src="/app.js" defer></script>

</html>
