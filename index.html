!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Steps Co VIP Player</title>

  <!-- HLS -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --btn:#00c19a; --btn2:#00ad8a; --btn3:#009e7e;
      --ring:rgba(0,193,154,.28); --panel:#0b0b0fe6; --bd:#ffffff26;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #player{position:relative;width:100vw;height:100vh}
    .frame{position:absolute;inset:0;background:#000;overflow:hidden}
    #preview{position:absolute;top:16px;right:20px;width:22%;height:24%;z-index:6;border:1px solid #fff2;border-radius:18px;cursor:pointer;transition:.18s}
    #preview:hover{box-shadow:0 10px 30px #0008}
    #preview video{width:100%;height:100%;object-fit:contain}
    .split #preview{top:0;right:0;width:50%;height:100%;border-radius:0;cursor:default}
    .split #active {left:0;right:auto;width:50%}
    .mode1 video{object-fit:contain}
    .mode2 video{object-fit:contain;transform:scale(1.08)}
    .mode3 video{object-fit:cover}
    .full #preview{top:0;right:0;width:100%;height:100%;z-index:7;border:0;border-radius:0;cursor:zoom-out}
    .full #active{display:none}
    .hint{position:absolute;top:20px;right:20px;z-index:8;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
    .split .hint,.full .hint{display:none}

    .bar{position:absolute;z-index:12;display:flex;gap:8px;transition:opacity .18s}
    #tools{top:10px;right:10px}
    #global{bottom:70px;left:50%;transform:translateX(-50%);background:var(--panel);padding:10px;border-radius:14px;border:1px solid var(--bd);align-items:center;min-width:340px}
    #global.hidden{display:none}
    button{-webkit-tap-highlight-color:transparent;appearance:none;border:0;cursor:pointer;background:var(--btn);color:#fff;padding:10px 12px;font-size:12px;font-weight:800;border-radius:12px;display:inline-flex;align-items:center;gap:6px;box-shadow:0 8px 18px #000a,0 0 0 0 var(--ring);transition:.12s}
    button:hover{background:var(--btn2);box-shadow:0 12px 26px #000c,0 0 0 6px var(--ring)}
    button:active{background:var(--btn3);transform:translateY(1px)}
    #scrub{-webkit-appearance:none;appearance:none;width:320px;height:6px;border-radius:999px;background:#ffffff30;outline:none;margin:0 8px}
    #scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #0006;cursor:pointer}
    #time{color:#fff;font-size:12px;min-width:108px;text-align:center}

    #gate{position:absolute;inset:0;z-index:9;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2))}
    #gate.hidden{display:none}
    .card{background:var(--panel);border:1px solid var(--bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}

    #panel{position:absolute; top:0; left:0; height:100%; width:220px; z-index:12; background:none; padding:12px 10px; color:#fff;}
    #panel .t{font-weight:900;letter-spacing:.8px;margin:6px 6px 12px;font-size:13px;text-shadow:0 1px 2px #000}
    #list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px;max-height:calc(100% - 48px);overflow:auto}
    .item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;cursor:pointer;background:rgba(0,0,0,.30);border:1px solid rgba(255,255,255,.20);backdrop-filter:blur(2px);transition:.12s}
    .item:hover{background:rgba(0,0,0,.38);border-color:#ffffff35}
    .item.active{background:rgba(0,0,0,.55);border-color:#ffffff60}
    .name{font-weight:800;font-size:12px;letter-spacing:.4px;text-transform:uppercase}

    .ui-hide #panel, .ui-hide #tools, .ui-hide #global, .ui-hide #lk{opacity:0; pointer-events:none}
    .ui-show #panel, .ui-show #tools, .ui-show #global, .ui-show #lk{opacity:1; pointer-events:auto}

    #lk{position:absolute; bottom:14px; right:14px; z-index:20; background:var(--panel); border:1px solid var(--bd); border-radius:14px; padding:10px; display:flex; flex-direction:column; gap:8px; width:min(92vw,520px)}
    #lk h3{margin:0;color:#fff;font-size:13px}
    #grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:8px; max-height:34vh; overflow:auto}
    .tile{position:relative;background:#0b0b0f;border:1px solid #ffffff22;border-radius:10px;overflow:hidden;min-height:90px}
    .tile video{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;left:6px;top:6px;background:#000a;color:#fff;font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid #fff2}
    #lkc select,#lkc input{background:#10151f;color:#fff;border:1px solid #ffffff22;border-radius:10px;padding:8px;font-size:12px}
    #hint{color:#eaeaf0b3;font-size:11px}

    @media (orientation:portrait){
      #preview{top:12px;right:14px;width:58vw;height:36vh;border-radius:18px}
      #global{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px)+8px);left:50%;transform:translateX(-50%);width:min(94vw,560px);padding:8px 10px;z-index:9999}
      #panel{width:180px}
    }
  </style>
</head>
<body>
  <div id="player" class="ui-show">
    <aside id="panel"><div class="t">SOURCES</div><ul id="list"></ul></aside>

    <div id="active" class="frame" aria-label="الكاميرا النشطة"></div>
    <div id="preview" class="frame" title="انقر للتكبير/التصغير" aria-label="المعاينة"></div>
    <div class="hint">انقر على المعاينة للتكبير • أو اضغط F</div>

    <div id="gate" role="dialog" aria-modal="true">
      <div class="card">
        <div style="color:#fff;font-weight:800;margin-bottom:6px">ابدأ التشغيل والمزامنة</div>
        <button id="start">تشغيل/بدء المزامنة</button>
      </div>
    </div>

    <div id="tools" class="bar" role="toolbar" aria-label="أدوات">
      <button id="bSplit">تقسيم</button>
      <button id="bFill">ملء</button>
      <button id="bMute">🔊/🔇</button>
    </div>

    <div id="global" class="bar hidden" role="group" aria-label="تحكم موحّد">
      <button id="back">⏪ 5s</button>
      <button id="play">⏯</button>
      <button id="fwd">5s ⏩</button>
      <input id="scrub" type="range" min="0" max="0" step="0.01" value="0" />
      <div id="time">00:00 / 00:00</div>
    </div>

    <div id="lk" aria-label="LiveKit Panel">
      <h3>الغرفة المباشرة (LiveKit)</h3>
      <div id="lkc" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
        <label>الغرفة:</label>
        <select id="room">
          <option>studio-1</option><option>studio-2</option><option>studio-3</option><option>studio-4</option><option>studio-5</option>
          <option>studio-6</option><option>studio-7</option><option>studio-8</option><option>studio-9</option><option>studio-10</option>
        </select>
        <input id="name" placeholder="اسم العرض (اختياري)" />
        <button id="join">انضم</button>
        <button id="leave" disabled>مغادرة</button>
        <button id="tCam" disabled>الكاميرا</button>
        <button id="tMic" disabled>المايك</button>
        <span id="hint">اضغط “تشغيل/بدء المزامنة” أولًا للسماح بالوسائط.</span>
      </div>
      <div id="grid" aria-live="polite"></div>
    </div>
  </div>

  <script>
    /* ============ إعدادات ثابتة ============ */
    const API_BASE = 'https://steps-livekit-api.onrender.com';   // ← عدّل إذا لزم
    const HLS_BASE = 'https://hls-proxy.it-f2c.workers.dev';

    const SOURCES = {
      main: `${HLS_BASE}/hls/live/playlist.m3u8`,
      cam1: `${HLS_BASE}/hls/lastone/playlist.m3u8`,
      cam2: `${HLS_BASE}/hls/live2/playlist.m3u8`,
      cam3: `${HLS_BASE}/hls/live3/playlist.m3u8`,
      cam4: `${HLS_BASE}/hls/live4/playlist.m3u8`,
      cam5: `${HLS_BASE}/hls/live5/playlist.m3u8`,
      cam6: `${HLS_BASE}/hls/live6/playlist.m3u8`,
      cam7: `${HLS_BASE}/hls/live7/playlist.m3u8`,
    };
    const CHANNELS = [
      {id:'main',label:'MAIN',src:SOURCES.main},
      {id:'cam1',label:'Cam1',src:SOURCES.cam1},
      {id:'cam2',label:'Cam2',src:SOURCES.cam2},
      {id:'cam3',label:'Cam3',src:SOURCES.cam3},
      {id:'cam4',label:'Cam4',src:SOURCES.cam4},
      {id:'cam5',label:'Cam5',src:SOURCES.cam5},
      {id:'cam6',label:'DRONE',src:SOURCES.cam6},
      {id:'cam7',label:'SINEFLEX',src:SOURCES.cam7},
    ];

    /* ====== أدوات LiveKit ====== */
    function pickLK(root){
      const cands = [
        root?.LiveKit,
        root?.livekitClient,
        root?.LivekitClient,
        root?.Livekit,
        root?.LK
      ];
      for (const c of cands){
        if (c && typeof c.connect === 'function') return c;
        if (c?.default && typeof c.default.connect === 'function') return c.default;
      }
      return null;
    }

    async function ensureLiveKit(){
      // إن كانت محمّلة أصلاً
      let LK = pickLK(window);
      if (LK) return LK;

      // جرّب من نفس النطاق أولاً
      LK = await new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src='/vendor/livekit-client.umd.min.js'; // ← تأكد من وجود الملف على Pages
        s.async=true;
        s.onload=()=> resolve(pickLK(window));
        s.onerror=()=> resolve(null);
        document.head.appendChild(s);
      });
      if (LK && typeof LK.connect==='function') return LK;

      // رجوع احتياطي لـ jsDelivr (مسموح في CSP لديك)
      LK = await new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/livekit-client@2.5.0/dist/livekit-client.umd.min.js';
        s.async=true;
        s.onload=()=> resolve(pickLK(window));
        s.onerror=()=> resolve(null);
        document.head.appendChild(s);
      });
      if (LK && typeof LK.connect==='function') return LK;

      throw new Error('LiveKit library did not load');
    }

    async function preflightMedia(){
      // لعرض نافذة الإذن فورًا
      if (!navigator.mediaDevices?.getUserMedia) return;
      try{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true, video:true});
        stream.getTracks().forEach(t=>t.stop());
      }catch(e){
        // المستخدم قد يرفض — لا تكسر التدفق، LiveKit سيحاول لاحقًا
        console.warn('media preflight failed', e);
      }
    }

    /* ============ فيديو HLS ============ */
    const root = document.getElementById('player');
    const activeWrap = document.getElementById('active');
    const previewWrap = document.getElementById('preview');
    const gate = document.getElementById('gate');
    const startBtn = document.getElementById('start');
    const tools = document.getElementById('tools');
    const gbar = document.getElementById('global');
    const back=document.getElementById('back'), fwd=document.getElementById('fwd'), play=document.getElementById('play');
    const scrub=document.getElementById('scrub'), timeLbl=document.getElementById('time');
    const list = document.getElementById('list');

    let started=false, split=0, full=false;
    let mainV, activeV, ticker=null, isScrubbing=false, current='cam2';

    function addItem(ch){
      const li=document.createElement('li'); li.className='item'; li.dataset.cam=ch.id;
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=ch.label;
      li.appendChild(nm); li.onclick=()=>switchCam(ch.id);
      list.appendChild(li);
    }
    CHANNELS.forEach(addItem);
    function markList(){ document.querySelectorAll('.item').forEach(el=>el.classList.toggle('active', el.dataset.cam===current)); }

    function createVideo(url){
      const w=document.createElement('div'); w.style.cssText='position:absolute;inset:0';
      const v=document.createElement('video'); v.playsInline=true; v.muted=true; v.controls=false; v.preload='auto';
      v.style.cssText='width:100%;height:100%;object-fit:contain';
      w.appendChild(v);
      if (Hls.isSupported()){
        const h=new Hls({ enableWorker:false, lowLatencyMode:false });
        h.attachMedia(v); h.on(Hls.Events.MEDIA_ATTACHED,()=>h.loadSource(url));
        v.__hls=h;
      }else if(v.canPlayType('application/vnd.apple.mpegURL')){ v.src=url; }
      v.addEventListener('error',()=>console.warn('video error', url));
      return {wrap:w,video:v};
    }
    function mount(container, ent){ container.innerHTML=''; container.appendChild(ent.wrap); }

    function initMain(){ const ent=createVideo(SOURCES.main); mainV=ent.video; mount(previewWrap, ent); }
    function initActive(){ const ent=createVideo(SOURCES[current]); activeV=ent.video; mount(activeWrap, ent); }

    function startTicker(){
      if(ticker) return;
      const fmt=t=>{t=Math.max(0,Math.floor(t||0));const m=String(Math.floor(t/60)).padStart(2,'0');const s=String(t%60).padStart(2,'0');return `${m}:${s}`;};
      ticker=setInterval(()=>{
        if(!mainV || isScrubbing) return;
        let d=0, ct=mainV.currentTime||0, r=mainV.seekable;
        if(r&&r.length) d=r.end(r.length-1);
        if(d&&isFinite(d)) scrub.max=d; scrub.value=ct||0; timeLbl.textContent=`${fmt(ct)} / ${fmt(d||0)}`;
      }, 250);
    }
    function setUiAutohide(){
      let t=null; const show=()=>{root.classList.remove('ui-hide');root.classList.add('ui-show');clearTimeout(t);t=setTimeout(()=>{root.classList.add('ui-hide');root.classList.remove('ui-show');},2200);};
      ['mousemove','touchstart','keydown'].forEach(ev=>document.addEventListener(ev,show,{passive:true}));
      [document.getElementById('panel'),tools,gbar,document.getElementById('lk')].forEach(el=>{
        el.addEventListener('mouseenter',()=>{clearTimeout(t);root.classList.remove('ui-hide');root.classList.add('ui-show');});
        el.addEventListener('mouseleave',show);
      });
      setTimeout(show,800);
    }

    startBtn.onclick = async () => {
      if(started) return; started=true; gate.classList.add('hidden'); gbar.classList.remove('hidden');
      initMain(); initActive();
      try{ await mainV.play(); }catch(_){}
      try{ await activeV.play(); }catch(_){}
      setUiAutohide(); startTicker();
    };

    function switchCam(id){
      if(!SOURCES[id]) return; current=id; markList();
      const ent=createVideo(SOURCES[id]); activeV=ent.video; mount(activeWrap, ent);
      if(mainV){ try{ activeV.currentTime=Math.max(0,(mainV.currentTime||0)); }catch(_){} }
      activeV.play().catch(()=>{});
    }
    markList();

    document.getElementById('bSplit').onclick = ()=>{
      split=(split+1)%4;
      root.classList.toggle('split', split!==0);
      root.classList.remove('mode1','mode2','mode3');
      if(split===1) root.classList.add('mode1'); if(split===2) root.classList.add('mode2'); if(split===3) root.classList.add('mode3');
    };
    document.getElementById('bFill').onclick = ()=>{
      if(split===0){ full=!full; root.classList.toggle('full',full); }
      else { split = (split===2?3:2); root.classList.remove('mode1','mode2','mode3'); root.classList.add(split===2?'mode2':'mode3'); root.classList.add('split'); }
    };
    document.getElementById('bMute').onclick = ()=>{
      if(!mainV) return; mainV.muted=!mainV.muted; if(!mainV.muted) mainV.play().catch(()=>{});
    };

    const seekBy = d => { if(!mainV) return; const r=mainV.seekable; let nt=(mainV.currentTime||0)+d; if(r&&r.length){ nt=Math.max(r.start(0), Math.min(nt, r.end(r.length-1))); } mainV.currentTime=nt; if(activeV) activeV.currentTime=nt; };
    back.onclick = ()=>seekBy(-5); fwd.onclick = ()=>seekBy(5);
    play.onclick = async()=>{ if(!mainV) return; if(mainV.paused){ try{ await mainV.play(); }catch(_){}} else { mainV.pause(); } };
    scrub.addEventListener('input',()=>{ if(started) isScrubbing=true; });
    scrub.addEventListener('change',()=>{ if(!started||!mainV) return; const nt=parseFloat(scrub.value)||0; mainV.currentTime=nt; if(activeV) activeV.currentTime=nt; isScrubbing=false; });
    previewWrap.onclick = ()=>{ if(split!==0) return; full=!full; root.classList.toggle('full',full); };
    document.addEventListener('keydown',e=>{
      if(e.key===' '||e.key==='Enter'){ e.preventDefault(); startBtn.click(); }
      if(e.key==='S'||e.key==='s'){ document.getElementById('bSplit').click(); }
      if(e.key==='F'||e.key==='f'){ document.getElementById('bFill').click(); }
      if(e.key==='M'||e.key==='m'){ document.getElementById('bMute').click(); }
      if(e.key==='ArrowLeft'){ back.click(); }
      if(e.key==='ArrowRight'){ fwd.click(); }
    });

    /* ============ LiveKit ============ */
    const elRoom=document.getElementById('room');
    const elName=document.getElementById('name');
    const btnJoin=document.getElementById('join');
    const btnLeave=document.getElementById('leave');
    const btnTCam=document.getElementById('tCam');
    const btnTMic=document.getElementById('tMic');
    const grid=document.getElementById('grid');

    let lkRoom=null, camOn=true, micOn=true;

    async function tokenFetch({room,name}){
      const resp = await fetch(`${API_BASE}/api/livekit-token`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ room, name })
      });
      if(!resp.ok) throw new Error('token request failed');
      return resp.json();
    }

    function addTile(track,label){
      const tile=document.createElement('div'); tile.className='tile';
      const badge=document.createElement('div'); badge.className='badge'; badge.textContent=label; tile.appendChild(badge);
      const el=track.attach(); if(el instanceof HTMLVideoElement){ el.playsInline=true; el.autoplay=true; el.muted=(label==='أنا'); }
      tile.appendChild(el); grid.appendChild(tile);
      return ()=>{ try{track.detach().forEach(e=>e.remove());}catch(_){ } try{tile.remove();}catch(_){ } };
    }
    function clearGrid(){ grid.innerHTML=''; }

    btnJoin.addEventListener('click', async()=>{
      try{
        if(!started) startBtn.click();

        // اطلب الإذن أولاً ليظهر Prompt
        await preflightMedia();

        const LK = await ensureLiveKit();
        const connect = LK.connect || LK.default?.connect;
        const createLocalTracks = LK.createLocalTracks || LK.default?.createLocalTracks;
        const RoomEvent = LK.RoomEvent || LK.default?.RoomEvent;

        if (typeof connect !== 'function') throw new Error('LK.connect not available');

        const roomName = elRoom.value;
        const displayName = elName.value.trim() || undefined;
        const { token, wsUrl } = await tokenFetch({ room: roomName, name: displayName });

        lkRoom = await connect(wsUrl, token, { autoSubscribe:true, stopLocalTrackOnUnpublish:true });

        const tracks = await createLocalTracks({ audio:true, video:{ facingMode:'user' } });
        for (const t of tracks) await lkRoom.localParticipant.publishTrack(t);
        for (const pub of lkRoom.localParticipant.trackPublications.values()){
          if(pub.track) addTile(pub.track, 'أنا');
        }

        const unsub = new Map();
        lkRoom
          .on(RoomEvent.TrackSubscribed, (track, publication, participant)=>{
            const d = addTile(track, participant.identity||'ضيف'); unsub.set(publication.sid, d);
          })
          .on(RoomEvent.TrackUnsubscribed, (_t, publication)=>{
            const d = unsub.get(publication.sid); if(d){ try{d();}catch(_){ } unsub.delete(publication.sid); }
          })
          .on(RoomEvent.Disconnected, ()=>{ clearGrid(); });

        btnJoin.disabled=true; btnLeave.disabled=false; btnTCam.disabled=false; btnTMic.disabled=false;
      }catch(err){
        console.error('joinLiveKit error', err);
        alert('تعذّر الانضمام: '+ (err?.message||err));
      }
    });

    btnLeave.addEventListener('click', async()=>{
      try{ await lkRoom?.disconnect(); }catch(_){}
      lkRoom=null; clearGrid();
      btnJoin.disabled=false; btnLeave.disabled=true; btnTCam.disabled=true; btnTMic.disabled=true;
      camOn=true; micOn=true;
    });

    btnTCam.addEventListener('click', async()=>{
      if(!lkRoom) return; camOn=!camOn;
      try{ await lkRoom.localParticipant.setCameraEnabled(camOn); }catch(_){}
      btnTCam.textContent = camOn? 'الكاميرا' : 'تشغيل الكاميرا';
    });
    btnTMic.addEventListener('click', async()=>{
      if(!lkRoom) return; micOn=!micOn;
      try{ await lkRoom.localParticipant.setMicrophoneEnabled(micOn); }catch(_){}
      btnTMic.textContent = micOn? 'المايك' : 'تشغيل المايك';
    });
  </script>
</body>
</html>
