<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steps Co VIP Player</title>

  <!-- HLS.js فقط (بدون يوتيوب/فيميو لتقليل مشاكل CSP) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>

  <!-- أيقونة -->
  <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%2300c19a'/%3E%3C/svg%3E" />

  <style>
    :root{
      --accent:#00c19a;
      --panel-bg:#0b0b0fe6;
      --panel-bd:#ffffff26;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

    #playerContainer{position:relative;width:100vw;height:100vh}

    .videoFrame{position:absolute;inset:0;background:#000;overflow:hidden}
    #mainPreview{position:absolute;top:14px;right:16px;width:22%;height:24%;z-index:6;border:1px solid #fff2;border-radius:16px;cursor:pointer}
    #mainPreview video{width:100%;height:100%;object-fit:contain}

    .split #mainPreview{top:0;right:0;width:50%;height:100%;border:0;border-radius:0;cursor:default}
    .split #activeCam{left:0;right:auto;width:50%}

    .split.mode1 #mainPreview video,.split.mode1 #activeCam video{object-fit:contain}
    .split.mode2 #mainPreview video,.split.mode2 #activeCam video{object-fit:contain;transform:scale(1.06)}
    .split.mode3 #mainPreview video,.split.mode3 #activeCam video{object-fit:cover}

    .main-full #mainPreview{inset:0;width:100%;height:100%;z-index:7;border:0;border-radius:0;cursor:zoom-out}
    .main-full #activeCam{display:none}
    .main-full.cover-one #mainPreview video{object-fit:cover}

    .hint{position:absolute;top:18px;right:18px;z-index:8;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
    .split .hint,.main-full .hint{display:none}

    /* لوحة المصادر */
    #streamPanel{
      position:absolute; top:0; left:0; height:100%; width:210px; z-index:12;
      background:none; padding:12px 10px; color:#fff; pointer-events:auto;
      transition:opacity .18s;
    }
    #streamPanel .panel-title{font-weight:900;letter-spacing:.8px;margin:6px 6px 12px;font-size:13px;text-shadow:0 1px 2px #000}
    #streamList{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;max-height:calc(100% - 48px);overflow:auto}
    .stream-item{
      display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;cursor:pointer;
      background:rgba(0,0,0,.30);border:1px solid rgba(255,255,255,.20);backdrop-filter: blur(2px);
    }
    .stream-item:hover{background:rgba(0,0,0,.38);border-color:#ffffff35}
    .stream-item.active{background:rgba(0,0,0,.55);border-color:#ffffff60}
    .stream-name{font-weight:800;font-size:12px;letter-spacing:.4px;text-transform:uppercase}

    /* أدوات */
    #utilityBar{position:absolute;top:10px;right:10px;z-index:12;display:flex;gap:8px;transition:opacity .18s}
    .btn{appearance:none;border:0;cursor:pointer;background:var(--accent);color:#fff;padding:10px 12px;font-size:12px;font-weight:800;border-radius:12px}
    .btn:active{transform:translateY(1px)}

    /* الشريط الموحّد */
    #globalControls{
      position:absolute;bottom:18px;left:50%;transform:translateX(-50%);z-index:12;
      background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:14px;padding:8px 10px;display:flex;align-items:center;gap:8px;min-width:320px;transition:opacity .18s
    }
    #globalControls.hidden{display:none}
    #scrub{-webkit-appearance:none;appearance:none;width:320px;height:6px;border-radius:999px;background:#ffffff30;outline:none}
    #scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #0006;cursor:pointer}
    #timeLabel{color:#fff;font-size:12px;min-width:108px;text-align:center}

    /* إخفاء تلقائي */
    .ui-hidden #streamPanel,
    .ui-hidden #utilityBar,
    .ui-hidden #globalControls{opacity:0;pointer-events:none}
    .ui-visible #streamPanel,
    .ui-visible #utilityBar,
    .ui-visible #globalControls{opacity:1;pointer-events:auto}

    /* بوابة البدء */
    #gatePlay{position:absolute;inset:0;z-index:9;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2))}
    #gatePlay.hidden{display:none}
    .gate-card{background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .gate-card .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--panel-bd);color:#fff;background:#111a;font-size:18px}
    #startBtn{min-width:180px}

    /* لوحة LiveKit */
    #lkPanel{
      position:absolute; bottom:14px; right:14px; z-index:20;
      background:var(--panel-bg); border:1px solid var(--panel-bd); border-radius:14px; padding:10px; backdrop-filter: blur(8px);
      display:flex; flex-direction:column; gap:8px; width:min(92vw, 520px);
      transition:opacity .18s;
    }
    #lkPanel h3{margin:0;color:#fff;font-size:13px}
    #lkGrid{display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:8px; max-height:34vh; overflow:auto}
    .tile{position:relative;background:#0b0b0f;border:1px solid #ffffff22;border-radius:10px;overflow:hidden;min-height:90px}
    .tile video{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;left:6px;top:6px;background:#000a;color:#fff;font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid #fff2}
    #lkControls{display:flex;gap:6px;flex-wrap:wrap}
    #lkControls select, #lkControls input{background:#10151f;color:#fff;border:1px solid #ffffff22;border-radius:10px;padding:8px;font-size:11px}
    #lkHint{color:#eaeaf0b3;font-size:11px}

    @media (orientation:portrait){
      #streamPanel{width:180px}
      #mainPreview{width:58vw;height:36vh}
      #globalControls{left:50%;transform:translateX(-50%);width:min(94vw,560px)}
    }
  </style>
</head>
<body>
  <div id="playerContainer" class="ui-visible" aria-label="مشغّل متعدد الكاميرات">

    <!-- قائمة المصادر -->
    <aside id="streamPanel" aria-label="مصادر البث">
      <div class="panel-title">SOURCES</div>
      <ul id="streamList"></ul>
    </aside>

    <!-- الفيديوهات -->
    <div id="activeCam" class="videoFrame" aria-label="الكاميرا النشطة"></div>
    <div id="mainPreview" class="videoFrame" title="انقر للتكبير/التصغير" aria-label="المعاينة الرئيسية المصغّرة"></div>
    <div class="hint">انقر على المعاينة للتكبير • أو اضغط F</div>

    <!-- بوابة البدء -->
    <div id="gatePlay" role="dialog" aria-modal="true" aria-label="بدء التشغيل">
      <div class="gate-card">
        <div class="icon">▶</div>
        <div>
          <div style="color:#fff;font-weight:800;margin-bottom:6px">ابدأ التشغيل والمزامنة</div>
          <div style="font-size:12px;color:#eaeaf0b3">سيظهر شريط التقديم/التأخير بعد الضغط على تشغيل</div>
        </div>
        <button id="startBtn" class="btn" aria-label="ابدأ التشغيل الآن">تشغيل/بدء المزامنة</button>
      </div>
    </div>

    <!-- أدوات -->
    <div id="utilityBar" role="toolbar" aria-label="أدوات">
      <button id="btnSplit" class="btn" title="تقسيم">تقسيم</button>
      <button id="btnFill"  class="btn" title="ملء">ملء</button>
      <button id="btnSound" class="btn" title="صوت">🔊/🔇</button>
    </div>

    <!-- الشريط الموحّد -->
    <div id="globalControls" class="hidden" role="group" aria-label="تحكم موحّد">
      <button id="gBack" class="btn" title="⏪ -5s">⏪ 5s</button>
      <button id="gPlay" class="btn" title="⏯">⏯</button>
      <button id="gFwd"  class="btn" title="+5s ⏩">5s ⏩</button>
      <input id="scrub" type="range" min="0" max="0" value="0" step="0.01" aria-label="شريط التقدم">
      <div id="timeLabel">00:00 / 00:00</div>
    </div>

    <!-- لوحة LiveKit -->
    <div id="lkPanel" aria-label="LiveKit Panel">
      <h3>الغرفة المباشرة (LiveKit)</h3>
      <div id="lkControls">
        <label class="text" for="lkRoom" style="color:#fff;font-size:11px">الغرفة:</label>
        <select id="lkRoom">
          <option>studio-1</option><option>studio-2</option><option>studio-3</option>
          <option>studio-4</option><option>studio-5</option><option>studio-6</option>
          <option>studio-7</option><option>studio-8</option><option>studio-9</option><option>studio-10</option>
        </select>
        <input id="lkName" placeholder="اسم العرض (اختياري)" />
        <button id="lkJoin"   class="btn">انضم</button>
        <button id="lkLeave"  class="btn" disabled>مغادرة</button>
        <button id="lkToggleCam" class="btn" disabled>الكاميرا</button>
        <button id="lkToggleMic" class="btn" disabled>المايك</button>
        <span id="lkHint" class="text">اضغط “تشغيل/بدء المزامنة” أولاً ثم انضم.</span>
      </div>
      <div id="lkGrid" aria-live="polite"></div>
    </div>
  </div>

  <!-- ===== إعدادات المسارات ===== -->
  <script>
    /* استخدم /hls من نفس الدومين (Functions) */
    window.HLS_BASE = ""; // اتركها فارغة ليصبح المسار: /hls/...
    /* API لرمز LiveKit (سيرفر Render لديك) */
    window.API_BASE = "https://steps-livekit-api.onrender.com";
  </script>

  <!-- ==== مصادر القنوات ==== -->
  <script>
    (function(){
      const BASE=(window.HLS_BASE||"").replace(/\/$/,"");
      const build=(p)=>BASE?`${BASE}${p}`:p;

      window.sources={
        main: build("/hls/live/playlist.m3u8"),
        cam1: build("/hls/lastone/playlist.m3u8"),
        cam2: build("/hls/live2/playlist.m3u8"),
        cam3: build("/hls/live3/playlist.m3u8"),
        cam4: build("/hls/live4/playlist.m3u8"),
        cam5: build("/hls/live5/playlist.m3u8"),
        cam6: build("/hls/live6/playlist.m3u8"),
        cam7: build("/hls/live7/playlist.m3u8"),
      };

      window.channelMap=[
        {id:'main',label:'MAIN',src:sources.main},
        {id:'cam1',label:'Cam1',src:sources.cam1},
        {id:'cam2',label:'Cam2',src:sources.cam2},
        {id:'cam3',label:'Cam3',src:sources.cam3},
        {id:'cam4',label:'Cam4',src:sources.cam4},
        {id:'cam5',label:'Cam5',src:sources.cam5},
        {id:'cam6',label:'DRONE',src:sources.cam6},
        {id:'cam7',label:'SINEFLEX',src:sources.cam7},
      ];
    })();
  </script>

  <!-- ==== أدوات مساعدة + مشغل HLS ==== -->
  <script>
    // ضبط HLS بدون workers (لتجنّب حظر CSP للـ blob workers)
    const HLS_CFG = {
      lowLatencyMode:false,
      liveSyncDurationCount:3, liveMaxLatencyDurationCount:6, maxLiveSyncPlaybackRate:1.0,
      maxBufferLength:18, backBufferLength:14, maxBufferSize:40*1000*1000,
      capLevelToPlayerSize:true, enableWorker:false, // ← مهم
      maxBufferHole:0.15, maxSeekHole:0.25, nudgeOffset:0.12, nudgeMaxRetry:10,
      abrMaxWithRealBitrate:true
    };

    const SAFETY_EDGE=0.80, SHOW_MIN_BUF=1.25, STARVED_RESEEK=0.25;

    const root=document.getElementById('playerContainer');
    const mainContainer=document.getElementById('mainPreview');
    const camContainer=document.getElementById('activeCam');
    const gatePlay=document.getElementById('gatePlay');
    const startBtn=document.getElementById('startBtn');

    const btnSplit=document.getElementById('btnSplit');
    const btnFill=document.getElementById('btnFill');
    const btnSound=document.getElementById('btnSound');

    const globalControls=document.getElementById('globalControls');
    const gPlay=document.getElementById('gPlay');
    const gBack=document.getElementById('gBack');
    const gFwd=document.getElementById('gFwd');
    const scrub=document.getElementById('scrub');
    const timeLabel=document.getElementById('timeLabel');

    const streamPanel=document.getElementById('streamPanel');
    const streamList=document.getElementById('streamList');

    let started=false, splitMode=0, isMainFull=false;
    let mainPlayer, activePlayer, currentCam='cam2';
    let ticker=null, isScrubbing=false;
    const playersCache=new Map();

    const fmt=(t)=>{t=Math.max(0,Math.floor(t||0));const m=String(Math.floor(t/60)).padStart(2,'0');const s=String(t%60).padStart(2,'0');return `${m}:${s}`;};
    const getSeekableRange=(v)=>{try{const r=v.seekable;if(!r||!r.length)return null;return{start:r.start(r.length-1),end:r.end(r.length-1)};}catch(e){return null;}};
    const capLiveEdge=(v,t)=>{const m=getSeekableRange(v); if(!m) return t; return Math.min(t, m.end - SAFETY_EDGE);};
    const containsTime=(v,t)=>{try{const b=v.buffered;for(let i=0;i<b.length;i++){if(t>=b.start(i)&&t<=b.end(i)) return {start:b.start(i),end:b.end(i)};} }catch(e){} return null;};
    const nearestBufferedTime=(v,t)=>{try{const b=v.buffered;let best=null,dm=1e9;for(let i=0;i<b.length;i++){const s=b.start(i),e=b.end(i);const cand=(t<s)?s:(t>e?e:t);const d=Math.abs(cand-t);if(d<dm){dm=d;best=cand;}} return best;}catch(e){return null;}};
    const snapIntoBuffer=(v,t)=>{t=capLiveEdge(v,t); const r=containsTime(v,t); if(r) return t; const near=nearestBufferedTime(v,t); return typeof near==='number'?near:t;};

    function attachHls(video,url){
      const hls=new Hls({...HLS_CFG}); video.__hls=hls; hls.attachMedia(video);
      hls.on(Hls.Events.MEDIA_ATTACHED,()=>hls.loadSource(url));
      hls.on(Hls.Events.ERROR,(_,err)=>{ if(err?.fatal){ try{hls.destroy();}catch(e){} try{attachHls(video,url);}catch(_){ } }});
      return hls;
    }

    function createVideoElement(url){
      const wrap=document.createElement('div'); wrap.style.cssText='position:absolute;inset:0';
      const v=document.createElement('video');
      v.playsInline=true; v.muted=true; v.controls=false; v.preload='auto'; v.crossOrigin='anonymous';
      v.style.cssText='width:100%;height:100%;object-fit:contain';
      wrap.appendChild(v);

      if (/\.m3u8(\?.*)?$/i.test(url)) {
        if (window.Hls && Hls.isSupported()) attachHls(v,url);
        else if (v.canPlayType('application/vnd.apple.mpegURL')) v.src=url;
        else v.src=url;
      } else {
        v.src=url;
      }
      return {wrap, video:v};
    }

    function buildStreamList(){
      streamList.innerHTML='';
      (window.channelMap||[]).forEach(ch=>{
        const li=document.createElement('li'); li.className='stream-item'; li.dataset.cam=ch.id;
        const name=document.createElement('div'); name.className='stream-name'; name.textContent=ch.label;
        li.appendChild(name);
        li.addEventListener('click',()=>setActiveCamSmooth(ch.id));
        streamList.appendChild(li);
      });
    }
    function markActiveList(){
      document.querySelectorAll('.stream-item').forEach(el=>el.classList.toggle('active',el.dataset.cam===currentCam));
    }

    function getOrCreateCam(id){
      let ent=playersCache.get(id);
      if(ent) return ent;
      const {wrap,video}=createVideoElement(sources[id]);
      camContainer.appendChild(wrap);
      const rec={wrap,video,ready:false};
      video.addEventListener('canplay',()=>{rec.ready=true;},{once:true});
      playersCache.set(id,rec);
      return rec;
    }

    function initOnce(){
      // main
      const {wrap,video}=createVideoElement(sources.main);
      mainContainer.appendChild(wrap); mainPlayer=video;

      // first cam
      const first=getOrCreateCam(currentCam);
      first.wrap.style.opacity='1';
      activePlayer=first.video;

      buildStreamList(); markActiveList();
    }
    initOnce();

    async function startPlayback(){
      if(started) return; started=true;
      gatePlay.classList.add('hidden'); globalControls.classList.remove('hidden');
      try{ await mainPlayer.play(); }catch(_){}
      try{ await activePlayer.play(); }catch(_){}
      setTimeout(()=>{ const m=getSeekableRange(mainPlayer); if(m){ mainPlayer.currentTime=Math.max(m.start,m.end-SAFETY_EDGE);} },300);
      startTicker();
    }

    function startTicker(){
      if(ticker) return;
      ticker=setInterval(()=>{
        if(isScrubbing) return;
        let d=0, ct=mainPlayer.currentTime||0;
        const r=mainPlayer.seekable; if(r&&r.length) d=r.end(r.length-1);
        if(d&&isFinite(d)) scrub.max=d;
        scrub.value=ct||0; timeLabel.textContent=`${fmt(ct)} / ${fmt(d||0)}`;
      },250);
    }

    async function setActiveCamSmooth(id){
      if(!sources[id] || id===currentCam) return;
      currentCam=id; markActiveList();
      const t=getOrCreateCam(id); const v=t.video, w=t.wrap;
      if(!t.ready) await new Promise(r=>v.addEventListener('canplay',r,{once:true}));
      let T=capLiveEdge(v, (mainPlayer.currentTime||0)); v.currentTime = snapIntoBuffer(v, T);
      try{ await v.play(); }catch(_){}
      [...camContainer.children].forEach(c=>c.style.opacity='0.0001');
      w.style.opacity='1'; activePlayer=v;
    }

    // أزرار
    startBtn.addEventListener('click',startPlayback);

    btnSplit.addEventListener('click',()=>{
      splitMode=(splitMode+1)%4;
      root.classList.toggle('split', splitMode!==0);
      root.classList.remove('mode1','mode2','mode3');
      if(splitMode===1) root.classList.add('mode1');
      if(splitMode===2) root.classList.add('mode2');
      if(splitMode===3) root.classList.add('mode3');
    });

    btnFill.addEventListener('click',()=>{
      if(splitMode===0){
        isMainFull=!isMainFull; root.classList.toggle('main-full',isMainFull); root.classList.toggle('cover-one',isMainFull);
      }else{
        splitMode = (splitMode===2)?3:2;
        root.classList.remove('mode1','mode2','mode3');
        root.classList.add(splitMode===2?'mode2':'mode3'); root.classList.add('split');
      }
    });

    btnSound.addEventListener('click',()=>{ if(!started) return; mainPlayer.muted=!mainPlayer.muted; if(!mainPlayer.muted) mainPlayer.play().catch(()=>{}); });

    const gSeek=(ofs)=>{ if(!started) return; const t=capLiveEdge(mainPlayer,(mainPlayer.currentTime||0)+ofs); mainPlayer.currentTime=t; if(activePlayer) activePlayer.currentTime=snapIntoBuffer(activePlayer,t); };
    gBack.addEventListener('click',()=>gSeek(-5));
    gFwd .addEventListener('click',()=>gSeek( 5));
    gPlay.addEventListener('click',async()=>{ if(!started) return; if(mainPlayer.paused){try{await mainPlayer.play();}catch(e){}} else mainPlayer.pause(); });

    scrub.addEventListener('input',()=>{ if(started) isScrubbing=true; });
    scrub.addEventListener('change',()=>{ if(!started) return; const nt=capLiveEdge(mainPlayer, parseFloat(scrub.value)||0); mainPlayer.currentTime=nt; if(activePlayer) activePlayer.currentTime=snapIntoBuffer(activePlayer,nt); isScrubbing=false; });

    mainContainer.addEventListener('click',()=>{ if(splitMode!==0) return; isMainFull=!isMainFull; root.classList.toggle('main-full',isMainFull); root.classList.toggle('cover-one',isMainFull); });

    // إظهار/إخفاء تلقائي للواجهة (مثل قائمة الكاميرات والشريط)
    let uiTimer=null;
    function showUI(){root.classList.remove('ui-hidden');root.classList.add('ui-visible');clearTimeout(uiTimer);uiTimer=setTimeout(()=>{root.classList.add('ui-hidden');root.classList.remove('ui-visible');},2500);}
    ['mousemove','touchstart','keydown'].forEach(ev=>document.addEventListener(ev,showUI,{passive:true}));
    [streamPanel,globalControls,document.getElementById('utilityBar')].forEach(el=>{
      el.addEventListener('mouseenter',()=>{clearTimeout(uiTimer);root.classList.remove('ui-hidden');root.classList.add('ui-visible');});
      el.addEventListener('mouseleave',showUI);
    });
    setTimeout(showUI,900);

    // بناء القائمة الرقمية (1..n)
    document.addEventListener('keydown',(e)=>{
      if(e.target && ['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
      const items=[...document.querySelectorAll('.stream-item')];
      const n=Number(e.key); if(n>=1 && n<=items.length) items[n-1].click();
      if(e.key===' '||e.key==='Enter'){ e.preventDefault(); startBtn.click(); }
      if(e.key==='S'||e.key==='s'){ btnSplit.click(); }
      if(e.key==='F'||e.key==='f'){ btnFill.click(); }
      if(e.key==='M'||e.key==='m'){ btnSound.click(); }
      if(e.key==='ArrowLeft'){ gBack.click(); }
      if(e.key==='ArrowRight'){ gFwd.click(); }
    });

    // املأ قائمة المصادر
    buildStreamList();
  </script>

  <!-- ==== تحميل LiveKit من نطاقك فقط + لوحة الانضمام ==== -->
  <script>
    // دوال التحميل من self (كما طلبت)
    async function loadScript(src){
      return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src; s.async = true; s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
      });
    }
    async function ensureLiveKit(){
      if (window.LiveKit) return window.LiveKit;
      // التحميل من Cloudflare Pages عبر Function: /vendor/livekit-client.umd.min.js
      await loadScript('/vendor/livekit-client.umd.min.js');
      if (!window.LiveKit) throw new Error('LiveKit library did not load');
      return window.LiveKit;
    }

    // عناصر LiveKit
    const lkRoomSel   = document.getElementById('lkRoom');
    const lkNameInput = document.getElementById('lkName');
    const lkJoinBtn   = document.getElementById('lkJoin');
    const lkLeaveBtn  = document.getElementById('lkLeave');
    const lkToggleCam = document.getElementById('lkToggleCam');
    const lkToggleMic = document.getElementById('lkToggleMic');
    const lkGrid      = document.getElementById('lkGrid');

    let lkRoom = null;
    let localCamEnabled = true;
    let localMicEnabled = true;

    function addTrackTile(track,label){
      const tile=document.createElement('div'); tile.className='tile';
      const badge=document.createElement('div'); badge.className='badge'; badge.textContent=label; tile.appendChild(badge);
      const mediaEl = track.attach(); if(mediaEl instanceof HTMLVideoElement){ mediaEl.playsInline=true; mediaEl.muted=(label==='أنا'); mediaEl.autoplay=true; }
      tile.appendChild(mediaEl); lkGrid.appendChild(tile);
      const detach=()=>{ try{ track.detach().forEach(el=>el.remove()); }catch(e){} try{ tile.remove(); }catch(e){} };
      return detach;
    }
    function cleanupGrid(){ [...lkGrid.children].forEach(ch=>ch.remove()); }

    async function fetchLiveKitToken({ room, identity, name }){
      const url = (window.API_BASE||'').replace(/\/$/,'') + '/api/livekit-token';
      const r = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ room, identity, name })
      });
      if(!r.ok) throw new Error('token request failed');
      return r.json(); // { token, wsUrl, identity, room }
    }

    async function joinLiveKit(){
      try{
        // تأكيد تشغيل الميديا
        if(!started){ await startPlayback(); }

        const LK = await ensureLiveKit();
        const roomName = lkRoomSel.value;
        const displayName = lkNameInput.value.trim() || undefined;

        const { token, wsUrl } = await fetchLiveKitToken({ room: roomName, name: displayName });

        lkRoom = await LK.connect(wsUrl, token, { autoSubscribe:true, stopLocalTrackOnUnpublish:true });

        // نشر كاميرا + مايك
        const tracks = await LK.createLocalTracks({ audio:true, video:{ facingMode:'user' } });
        for (const t of tracks) await lkRoom.localParticipant.publishTrack(t);

        // عرضي
        for (const pub of lkRoom.localParticipant.trackPublications.values()) {
          if (pub.track) addTrackTile(pub.track, 'أنا');
        }

        // الاشتراك بالآخرين
        const unsubs=new Map();
        lkRoom
          .on(LK.RoomEvent.TrackSubscribed, (track, publication, participant) => {
            const d=addTrackTile(track, participant.identity||'ضيف'); unsubs.set(publication.sid,d);
          })
          .on(LK.RoomEvent.TrackUnsubscribed, (_track, publication) => {
            const d=unsubs.get(publication.sid); if(d){ try{ d(); }catch(e){} unsubs.delete(publication.sid); }
          })
          .on(LK.RoomEvent.Disconnected, () => cleanupGrid());

        lkJoinBtn.disabled=true; lkLeaveBtn.disabled=false; lkToggleCam.disabled=false; lkToggleMic.disabled=false;
      }catch(e){
        console.error('joinLiveKit error', e);
        alert('تعذّر الانضمام: ' + (e?.message||e));
      }
    }

    async function leaveLiveKit(){
      if(!lkRoom) return;
      try{ await lkRoom.disconnect(); }catch(e){}
      lkRoom=null; cleanupGrid();
      lkJoinBtn.disabled=false; lkLeaveBtn.disabled=true; lkToggleCam.disabled=true; lkToggleMic.disabled=true;
      localCamEnabled=true; localMicEnabled=true;
    }

    lkJoinBtn.addEventListener('click', joinLiveKit);
    lkLeaveBtn.addEventListener('click', leaveLiveKit);
    lkToggleCam.addEventListener('click', async ()=>{
      if(!lkRoom) return; localCamEnabled=!localCamEnabled;
      try{ await lkRoom.localParticipant.setCameraEnabled(localCamEnabled); }catch(e){}
      lkToggleCam.textContent = localCamEnabled ? 'الكاميرا' : 'تشغيل الكاميرا';
    });
    lkToggleMic.addEventListener('click', async ()=>{
      if(!lkRoom) return; localMicEnabled=!localMicEnabled;
      try{ await lkRoom.localParticipant.setMicrophoneEnabled(localMicEnabled); }catch(e){}
      lkToggleMic.textContent = localMicEnabled ? 'المايك' : 'تشغيل المايك';
    });
  </script>
</body>
</html>
