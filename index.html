<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Steps Co VIP Player</title>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%2300c19a'/%3E%3C/svg%3E" />

  <style>
    :root{ --btn-bg:#00c19a; --btn-bg-h:#00ad8a; --btn-bg-a:#009e7e; --btn-txt:#fff; --panel-bg:#0b0b0fe6; --panel-bd:#ffffff26; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

    #playerContainer{position:relative;width:100vw;height:100vh}
    .videoFrame{position:absolute;top:0;right:0;width:100%;height:100%;background:#000;overflow:hidden}
    .videoFrame video{width:100%;height:100%;object-fit:contain;background:#000}

    /* المعاينة المصغّرة */
    #mainPreview{position:absolute;top:16px;right:20px;width:22%;height:24%;z-index:6;border:1px solid #fff2;border-radius:18px;cursor:pointer;transition:transform .18s,box-shadow .18s,width .18s,height .18s,top .18s,right .18s,left .18s}
    #mainPreview:hover{box-shadow:0 10px 30px #0008}

    /* تقسيم الشاشة */
    .split #mainPreview{top:0;right:0;width:50%;height:100%;border:0;border-radius:0;cursor:default}
    .split #activeCam{top:0;left:0;right:auto;width:50%;height:100%}
    .split.mode1 #mainPreview video,.split.mode1 #activeCam video{object-fit:contain}
    .split.mode2 #mainPreview video,.split.mode2 #activeCam video{object-fit:contain; transform:scale(1.08)}
    .split.mode3 #mainPreview video,.split.mode3 #activeCam video{object-fit:cover}

    .main-full #mainPreview{top:0;right:0;width:100%;height:100%;z-index:7;border:0;border-radius:0;cursor:zoom-out}
    .main-full #activeCam{display:none}
    .main-full.cover-one #mainPreview video{object-fit:cover}

    .hint{position:absolute;top:20px;right:20px;z-index:8;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
    .split .hint,.main-full .hint{display:none}

    /* القوائم و الأزرار */
    #streamPanel{position:absolute; top:0; left:0; height:100%; width:230px; z-index:12; color:#fff; padding:12px 10px;}
    #streamPanel .panel-title{font-weight:900;letter-spacing:.8px;margin:6px 6px 12px;font-size:13px;text-shadow:0 1px 2px #000}
    #streamList{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;max-height:calc(100% - 48px);overflow:auto}
    .stream-item{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer;background:rgba(0,0,0,.30); border:1px solid rgba(255,255,255,.20); backdrop-filter: blur(2px); transition:background .12s, border-color .12s}
    .stream-item:hover{background:rgba(0,0,0,.38);border-color:#ffffff35}
    .stream-item.active{background:rgba(0,0,0,.55);border-color:#ffffff60}
    .stream-name{font-weight:800; font-size:12px; letter-spacing:.4px; text-transform:uppercase}

    #utilityControls,#globalControls{position:absolute;z-index:12;display:flex;gap:8px;flex-wrap:wrap}
    #utilityControls{top:10px;right:10px}
    #globalControls{bottom:70px;left:50%;transform:translateX(-50%);background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bد);align-items:center;min-width:340px}
    #globalControls.hidden{display:none}

    button{-webkit-tap-highlight-color:transparent;appearance:none;border:0;outline:0;cursor:pointer;background:var(--btn-bg);color:var(--btn-txt);padding:11px 12px;font-size:12px;font-weight:800;border-radius:12px;letter-spacing:.2px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 18px #000a,0 0 0 0 rgba(0,193,154,.28);transition:transform .12s,box-shadow .12s,background .12s}
    button:hover{background:var(--btn-bg-h);box-shadow:0 12px 26px #000c,0 0 0 6px rgba(0,193,154,.28)}
    button:active{background:var(--btn-bg-a);transform:translateY(1px)}
    #scrub{-webkit-appearance:none;appearance:none;width:320px;height:6px;border-radius:999px;background:#ffffff30;outline:none;margin:0 8px}
    #scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #0006;cursor:pointer}
    #timeLabel{color:#fff;font-size:12px;min-width:108px;text-align:center}

    #gatePlay{position:absolute;inset:0;z-index:9;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2))}
    #gatePlay.hidden{display:none}
    .gate-card{background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .gate-card .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--panel-bd);color:#fff;background:#111a;font-size:18px}
    #startBtn{min-width:160px}

    #sysBanner{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:15;background:#000c;color:#fff;border:1px solid #fff2;padding:6px 10px;border-radius:999px;font-size:12px;display:none}
    #sysBanner.show{display:block}

    @media (orientation: portrait){
      #mainPreview{top:12px;right:14px;width:58vw;height:36vh;border-radius:18px}
      #globalControls{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 8px);left:50%;transform:translateX(-50%);width:min(94vw,560px);padding:8px 10px;z-index:9999}
      #scrub{width:clamp(140px,56vw,380px)}
      #streamPanel{width:190px}
    }
  </style>
</head>
<body>
  <div id="playerContainer" class="ui-visible" aria-label="مشغّل متعدد الكاميرات">
    <aside id="streamPanel" aria-label="مصادر البث">
      <div class="panel-title">SOURCES</div>
      <ul id="streamList">
        <li class="stream-item active" data-id="cam1"><div class="stream-name">CAM1</div></li>
        <li class="stream-item" data-id="main"><div class="stream-name">MAIN</div></li>
        <li class="stream-item" data-id="cam2"><div class="stream-name">CAM2</div></li>
        <li class="stream-item" data-id="cam3"><div class="stream-name">CAM3</div></li>
        <li class="stream-item" data-id="cam4"><div class="stream-name">CAM4</div></li>
        <li class="stream-item" data-id="cam5"><div class="stream-name">CAM5</div></li>
        <li class="stream-item" data-id="cam6"><div class="stream-name">DRONE</div></li>
        <li class="stream-item" data-id="cam7"><div class="stream-name">SINEFLEX</div></li>
      </ul>
    </aside>

    <div id="activeCam" class="videoFrame" aria-label="الكاميرا النشطة"></div>
    <div id="mainPreview" class="videoFrame" title="انقر للتكبير/التصغير" aria-label="المعاينة الرئيسية المصغّرة"></div>
    <div class="hint">انقر على المعاينة للتكبير • أو اضغط F</div>

    <div id="gatePlay" role="dialog" aria-modal="true" aria-label="بدء التشغيل">
      <div class="gate-card">
        <div class="icon">▶</div>
        <div>
          <div style="color:#fff;font-weight:800;margin-bottom:6px">ابدأ التشغيل والمزامنة</div>
          <div style="font-size:12px;color:#eaeaf0b3">سيظهر شريط التقديم/التأخير بعد الضغط على تشغيل</div>
        </div>
        <button id="startBtn" aria-label="ابدأ التشغيل الآن">تشغيل/بدء المزامنة</button>
      </div>
    </div>

    <div id="utilityControls" role="toolbar" aria-label="أدوات">
      <button id="btnSplit" aria-label="تبديل وضع التقسيم" title="تقسيم">تقسيم</button>
      <button id="btnFill"  aria-label="تبديل ملء المحتوى" title="ملء">ملء</button>
      <button id="btnSound" aria-label="تشغيل/إيقاف الصوت" title="صوت">🔊/🔇</button>
    </div>

    <div id="globalControls" class="hidden" role="group" aria-label="تحكم موحّد">
      <button id="gBack" title="⏪ -5s">⏪ 5s</button>
      <button id="gPlay" title="⏯">⏯</button>
      <button id="gFwd"  title="+5s ⏩">5s ⏩</button>
      <input id="scrub" type="range" min="0" max="0" value="0" step="0.01" aria-label="شريط التقدم">
      <div id="timeLabel">00:00 / 00:00</div>
    </div>

    <div id="sysBanner"></div>
  </div>

  <!-- ثوابت قابلة للتعديل -->
  <script>
    // استخدم /hls من نفس النطاق (Functions). يمكن تغييرها إلى Worker خارجي إذا لزم.
    window.HLS_BASE = "";

    // API لاستخراج التوكن
    window.API_BASE = "https://steps-livekit-api.onrender.com";

    // WebSocket لــ LiveKit
    window.LK_URL = "wss://presinter-stream-gjthpz2z.livekit.cloud";
  </script>

  <!-- تحميل HLS محليًا من Function /vendor -->
  <script defer src="/vendor/hls.min.js"></script>

  <script>
  /* تنبيه صغير */
  const sysBanner=(()=>{const el=document.getElementById('sysBanner');return{show:(m)=>{try{el.textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),4500);}catch(_){console.log(m)}}}})();

  /* تعريف المصادر */
  (function(){
    const BASE=(window.HLS_BASE||"").replace(/\/$/,"");
    const build=(p)=>BASE?`${BASE}${p}`:p;
    window.sources={
      main:build("/hls/live/playlist.m3u8"),
      cam1:build("/hls/lastone/playlist.m3u8"),
      cam2:build("/hls/live2/playlist.m3u8"),
      cam3:build("/hls/live3/playlist.m3u8"),
      cam4:build("/hls/live4/playlist.m3u8"),
      cam5:build("/hls/live5/playlist.m3u8"),
      cam6:build("/hls/live6/playlist.m3u8"),
      cam7:build("/hls/live7/playlist.m3u8")
    };
    window.channelMap=[
      {id:'cam1',label:'CAM1',src:sources.cam1},
      {id:'main',label:'MAIN',src:sources.main},
      {id:'cam2',label:'CAM2',src:sources.cam2},
      {id:'cam3',label:'CAM3',src:sources.cam3},
      {id:'cam4',label:'CAM4',src:sources.cam4},
      {id:'cam5',label:'CAM5',src:sources.cam5},
      {id:'cam6',label:'DRONE',src:sources.cam6},
      {id:'cam7',label:'SINEFLEX',src:sources.cam7},
    ];
  })();

  function createVideo(parent){
    parent.innerHTML='';
    const v=document.createElement('video');
    v.playsInline=true; v.controls=false; v.preload='auto'; v.muted=true; v.setAttribute('muted','');
    parent.appendChild(v); return v;
  }
  const hlsSupported=()=>!!(window.Hls && window.Hls.isSupported && window.Hls.isSupported());

  function attachHls(video, src, {timeoutMs=10000}={}){
    return new Promise(async(resolve)=>{
      if(!video){ resolve(false); return; }
      const finish=(ok)=>{ clearTimeout(tid); resolve(!!ok); };
      const tid=setTimeout(()=>{ console.warn('HLS timeout',src); finish(false); }, timeoutMs);

      const onError=(data)=>{
        console.log('[HLS] ERROR', data);
        const code = data?.response?.code || data?.response?.status || 0;
        if(code===502 || code===404){ sysBanner.show('فشل تحميل الفيديو: تحقق من /hls وORIGIN_BASE وUPSTREAM_PREFIX وCORS.'); }
      };

      if(hlsSupported()){
        try{
          const h=new window.Hls({lowLatencyMode:true,enableWorker:true,backBufferLength:90});
          h.on(window.Hls.Events.ERROR,(_e,data)=>onError(data));
          h.on(window.Hls.Events.MANIFEST_PARSED,()=>finish(true));
          h.loadSource(src); h.attachMedia(video);
        }catch(_){ finish(false); }
      }else{
        video.src=src;
        const ok=()=>finish(true), bad=()=>finish(false);
        try{ video.addEventListener('loadedmetadata',ok,{once:true}); video.addEventListener('error',bad,{once:true}); video.load(); }catch(_){ finish(false); }
      }
    });
  }

  function isReady(v){ return !!(v && v.readyState >= 2); }
  function waitCanPlay(v, timeout=8000){
    return new Promise((res)=>{
      if(!v){ res(false); return; }
      if(isReady(v)) return res(true);
      let done=false;
      const on=()=>{ if(!done){ done=true; cleanup(); res(true); } };
      const to=setTimeout(()=>{ if(!done){ done=true; cleanup(); res(false); } }, timeout);
      function cleanup(){ try{ v.removeEventListener('canplay',on); }catch(_){ } clearTimeout(to); }
      try{ v.addEventListener('canplay',on,{once:true}); v.load(); }catch(_){ res(false); }
    });
  }
  async function safePlay(v){
    try{ await v.play(); return true; }
    catch(_){ try{ v.muted=true; v.setAttribute('muted',''); await v.play(); return true; }catch(__){ return false; } }
  }
  function getSeekableRange(v){ try{ if(v.seekable&&v.seekable.length){ return {start:v.seekable.start(0), end:v.seekable.end(0)}; } }catch(_){ } return null; }
  function snapIntoBuffer(v,t){ try{ const r=getSeekableRange(v); if(!r) return t; if(t<r.start) return r.start+0.05; if(t>r.end) return r.end-0.05; return t; }catch(_){ return t; } }

  const mainPreviewEl=document.getElementById('mainPreview');
  const activeCamEl=document.getElementById('activeCam');

  let mainPlayer=null, activePlayer=null, started=false, tickerId=null;

  function activateListHandlers(){
    document.querySelectorAll('#streamList .stream-item').forEach(li=>{
      li.onclick=()=>selectActive(li.dataset.id);
    });
  }

  async function selectActive(id){
    const ch=window.channelMap.find(x=>x.id===id);
    if(!ch) return;
    document.querySelectorAll('.stream-item').forEach(li=>li.classList.toggle('active', li.dataset.id===id));
    if(!activePlayer) activePlayer=createVideo(activeCamEl);
    const ok = await attachHls(activePlayer, ch.src);
    if(started && ok) await safePlay(activePlayer);
  }

  async function initPlayers(){
    activateListHandlers();
    mainPlayer=createVideo(mainPreviewEl);
    const okMain = await attachHls(mainPlayer, window.sources.main);
    activePlayer=createVideo(activeCamEl);
    const okCam  = await attachHls(activePlayer, window.channelMap[0].src);
    if(!okMain || !okCam){ sysBanner.show('مصادر الفيديو غير جاهزة (قد يكون 502/404).'); }
  }

  const gatePlay=document.getElementById('gatePlay');
  const globalControls=document.getElementById('globalControls');
  const timeLabel=document.getElementById('timeLabel');
  const scrub=document.getElementById('scrub');

  function startTimeTicker(){
    stopTimeTicker();
    const fmt=(t)=>{t=Math.max(0,t|0); const m=(t/60)|0,s=(t%60)|0; return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;};
    tickerId=setInterval(()=>{ try{
      if(!mainPlayer) return;
      const cur=mainPlayer.currentTime||0;
      const dur=Math.max(cur,(getSeekableRange(mainPlayer)?.end||cur));
      scrub.max=(dur||0).toFixed(2); scrub.value=(cur||0).toFixed(2);
      timeLabel.textContent=`${fmt(cur)} / ${fmt(dur)}`;
    }catch(_){ } },250);
  }
  function stopTimeTicker(){ if(tickerId){ clearInterval(tickerId); tickerId=null; } }

  async function startPlayback(){
    if(started) return;
    if(!mainPlayer || !activePlayer){ sysBanner.show('لم تُجهّز المشغلات بعد.'); return; }
    const okMainReady = await waitCanPlay(mainPlayer,8000);
    const okCamReady  = await waitCanPlay(activePlayer,8000);
    if(!okMainReady){ sysBanner.show('المصدر الرئيسي غير جاهز.'); return; }
    await safePlay(mainPlayer);
    if(okCamReady) await safePlay(activePlayer);
    started=true; gatePlay.classList.add('hidden'); globalControls.classList.remove('hidden'); startTimeTicker();
  }

  document.getElementById('startBtn').addEventListener('click', startPlayback);
  document.getElementById('btnSplit').addEventListener('click', ()=>document.getElementById('playerContainer').classList.toggle('split'));
  document.getElementById('btnFill').addEventListener('click', ()=>{
    const c=document.getElementById('playerContainer');
    if(c.classList.contains('main-full')) c.classList.remove('main-full','cover-one');
    else { c.classList.add('main-full'); setTimeout(()=>c.classList.toggle('cover-one'),50); }
  });
  document.getElementById('btnSound').addEventListener('click', ()=>{ if(!mainPlayer) return; mainPlayer.muted=!mainPlayer.muted; sysBanner.show(mainPlayer.muted?'تم كتم الصوت':'تم تشغيل الصوت');});
  document.getElementById('gPlay').addEventListener('click', async ()=>{ if(!started){ await startPlayback(); return; } if(mainPlayer.paused){ await safePlay(mainPlayer); if(activePlayer) await safePlay(activePlayer);} else { mainPlayer.pause(); if(activePlayer) activePlayer.pause(); }});
  document.getElementById('gBack').addEventListener('click', ()=>{ try{ const t=Math.max(0,(mainPlayer.currentTime||0)-5); mainPlayer.currentTime=snapIntoBuffer(mainPlayer,t); if(activePlayer) activePlayer.currentTime=snapIntoBuffer(activePlayer,t);}catch(_){ }});
  document.getElementById('gFwd').addEventListener('click', ()=>{ try{ const t=(mainPlayer.currentTime||0)+5; mainPlayer.currentTime=snapIntoBuffer(mainPlayer,t); if(activePlayer) activePlayer.currentTime=snapIntoBuffer(activePlayer,t);}catch(_){ }});
  document.getElementById('mainPreview').addEventListener('click', ()=>{ const c=document.getElementById('playerContainer'); c.classList.toggle('main-full'); });
  window.addEventListener('keydown',(e)=>{ if(e.key.toLowerCase()==='f'){ document.getElementById('playerContainer').classList.toggle('main-full'); } });

  (async function init(){ try{ await initPlayers(); }catch(e){ console.error(e); sysBanner.show('فشل التهيئة. تحقق من /hls وORIGIN_BASE/CORS.'); } })();
  </script>

  <!-- LiveKit -->
  <script>
    function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
    async function ensureLiveKit(){
      let LK=window.livekitClient || window.LivekitClient || window.LiveKit;
      if(!LK){ try{ await loadScript('/vendor/livekit-client.umd.min.js'); }catch(_){ } LK=window.livekitClient || window.LivekitClient || window.LiveKit; }
      if(!LK) throw new Error('LiveKit library did not load');
      return LK;
    }

    let lkRoom=null;
    async function joinLiveKit(){
      try{
        // اطلب الإذن أولاً ليظهر نافذة سماح
        try{ await navigator.mediaDevices.getUserMedia({video:true,audio:true}); }catch(e){ alert('اسمح للكاميرا/المايك ثم أعد المحاولة'); return; }

        const LK = await ensureLiveKit();
        const connectFn = (LK.connect || (window.livekitClient && window.livekitClient.connect) || (window.LivekitClient && window.LivekitClient.connect));
        if(typeof connectFn!=='function') throw new Error('LK.connect not available');

        const roomName = (document.getElementById('roomName')||{}).value || 'studio-1';

        const r = await fetch(`${window.API_BASE}/api/token?room=${encodeURIComponent(roomName)}`);
        let token='', wsUrl=window.LK_URL;
        try{ const j=await r.json(); token=j.token||j.accessToken||j.jwt||''; wsUrl=j.url||j.wsUrl||wsUrl; }catch{ token=await r.text(); }
        if(!token) throw new Error('token missing');
        if(!wsUrl) throw new Error('wsUrl missing');

        lkRoom = await connectFn(wsUrl, token, {autoSubscribe:true, stopLocalTrackOnUnpublish:true});
        alert('تم الانضمام');
      }catch(err){ console.error('joinLiveKit error',err); alert('تعذّر الانضمام: '+(err?.message||err)); }
    }
    function leaveLiveKit(){ try{ if(lkRoom){ lkRoom.disconnect(); lkRoom=null; alert('تمت المغادرة'); } }catch(_){ } }
  </script>

  <!-- شريط LiveKit صغير -->
  <div style="position:fixed;bottom:10px;right:10px;z-index:20;display:flex;gap:8px;background:#0b0b0fe6;border:1px solid #ffffff26;padding:10px;border-radius:12px">
    <div style="color:#fff;font-size:12px;display:flex;align-items:center;gap:6px">
      <span>(LiveKit)</span>
      <input id="roomName" placeholder="studio-1" value="studio-1" style="padding:6px 8px;border-radius:8px;border:1px solid #ffffff26;background:#111;color:#fff;min-width:120px" />
    </div>
    <button onclick="joinLiveKit()">انضم</button>
    <button onclick="leaveLiveKit()">مغادرة</button>
  </div>
</body>
</html>
