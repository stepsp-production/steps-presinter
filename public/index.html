<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steps MultiCam Player</title>

  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø®ÙÙŠÙØ© -->
  <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%2300c19a'/%3E%3C/svg%3E" />

  <!-- Ù…ÙƒØªØ¨Ø© HLS Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù†Ø·Ø§Ù‚ -->
  <script src="/vendor/hls.min.js" defer></script>

  <style>
    :root{
      --brand:#00c19a;
      --brand-2:#00ad8a;
      --brand-3:#009e7e;
      --panel:#0b0b0fe6;
      --panel-b:#ffffff26;
      --txt:#fff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden; user-select:none;
    }

    /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© */
    #playerContainer{position:relative;width:100vw;height:100vh}

    /* Ø§Ù„Ù„ÙˆØ­ØªØ§Ù† */
    .videoFrame{position:absolute;inset:auto;top:0;right:0;width:100%;height:100%;background:#000}
    #activeCam{z-index:1}
    #mainPreview{
      position:absolute; top:16px; right:20px; width:22%; height:24%;
      z-index:6; border:1px solid #fff2; border-radius:18px;
      cursor:pointer; transition:transform .18s, box-shadow .18s, width .18s, height .18s, top .18s, right .18s, left .18s;
      overflow:hidden;
    }
    #mainPreview:hover{box-shadow:0 10px 30px #0008}

    /* Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„ÙˆØ­Ø§Øª */
    .videoFrame video{display:block;width:100%;height:100%;object-fit:contain;background:#000}

    /* ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø© */
    .split #mainPreview{top:0; right:0; width:50%; height:100%; border:0; border-radius:0; cursor:default}
    .split #activeCam{top:0; left:0; right:auto; width:50%; height:100%}

    /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
    .main-full #mainPreview{top:0; right:0; width:100%; height:100%; z-index:7; border:0; border-radius:0; cursor:zoom-out}
    .main-full #activeCam{display:none}
    .main-full.cover-one #mainPreview video{object-fit:cover}

    /* ØªÙ„Ù…ÙŠØ­ */
    .hint{
      position:absolute; top:20px; right:20px; z-index:8; background:#000a; color:#fff;
      padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #fff2
    }
    .split .hint, .main-full .hint{display:none}

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØµØ§Ø¯Ø± */
    #streamPanel{
      position:absolute; top:0; left:0; height:100%; width:230px; z-index:12;
      background:none; border-right:none; padding:12px 10px; color:#fff;
      transition:opacity .18s; pointer-events:auto;
    }
    #streamPanel .panel-title{font-weight:900;letter-spacing:.8px;margin:6px 6px 12px;font-size:13px;text-shadow:0 1px 2px #000}
    #streamList{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;max-height:calc(100% - 48px);overflow:auto}
    .stream-item{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer;
      background:rgba(0,0,0,.30); border:1px solid rgba(255,255,255,.20);
      backdrop-filter: blur(2px);
      transition:background .12s, border-color .12s, transform .06s;
    }
    .stream-item:hover{background:rgba(0,0,0,.38);border-color:#ffffff35}
    .stream-item.active{background:rgba(0,0,0,.55);border-color:#ffffff60}
    .stream-name{font-weight:800; font-size:12px; letter-spacing:.4px; text-transform:uppercase}
    .dot{width:8px;height:8px;border-radius:50%;background:#9994;display:inline-block}
    .dot.online{background:#2ecc71}

    /* Ø£Ø¯ÙˆØ§Øª Ø¹Ù„ÙˆÙŠØ© ÙˆØ³ÙÙ„ÙŠØ© */
    #utilityControls,#globalControls{position:absolute;z-index:12;display:flex;gap:8px;flex-wrap:wrap;transition:opacity .18s}
    #utilityControls{top:10px;right:10px}
    #globalControls{
      bottom:70px; left:50%; transform:translateX(-50%);
      background:var(--panel); padding:10px; border-radius:14px; border:1px solid var(--panel-b);
      align-items:center; min-width:340px
    }

    button{
      -webkit-tap-highlight-color:transparent; appearance:none; border:0; outline:0; cursor:pointer;
      background:var(--brand); color:var(--txt); padding:11px 12px; font-size:12px; font-weight:800; border-radius:12px;
      letter-spacing:.2px; display:inline-flex; align-items:center; gap:8px;
      box-shadow:0 8px 18px #000a,0 0 0 0 rgba(0,193,154,.28);
      transition:transform .12s, box-shadow .12s, background .12s
    }
    button:hover{background:var(--brand-2); box-shadow:0 12px 26px #000c,0 0 0 6px rgba(0,193,154,.28)}
    button:active{background:var(--brand-3); transform:translateY(1px)}

    /* Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¨Ø¯Ø¡ */
    #gatePlay{position:absolute; inset:0; z-index:9; display:flex; align-items:center; justify-content:center; background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2))}
    #gatePlay.hidden{display:none}
    .gate-card{background:var(--panel); border:1px solid var(--panel-b); border-radius:18px; padding:18px 20px; display:flex; gap:12px; align-items:center; box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .gate-card .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--panel-b);color:#fff;background:#111a;font-size:18px}
    #startBtn{min-width:160px}

    /* Ù„ÙˆØ­Ø© Ø§Ù„ØºØ±ÙØ© (LiveKit) */
    #roomBar{
      position:absolute; z-index:12; bottom:8px; right:12px; left:260px;
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      background:var(--panel); border:1px solid var(--panel-b); padding:10px; border-radius:14px;
    }
    #roomBar select, #roomBar input[type=text]{
      background:#111; color:#fff; border:1px solid #333; border-radius:10px; padding:8px 10px; font-size:12px
    }
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;border:1px solid #ffffff22;background:#0e0e12;color:#fff;font-size:11px}
    .badge.dot{padding:0;width:10px;height:10px;border-radius:50%}

    /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ */
    .ui-hidden #streamPanel,
    .ui-hidden #utilityControls,
    .ui-hidden #globalControls,
    .ui-hidden #roomBar{opacity:0; pointer-events:none}
    .ui-visible #streamPanel,
    .ui-visible #utilityControls,
    .ui-visible #globalControls,
    .ui-visible #roomBar{opacity:1; pointer-events:auto}

    /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    @media (orientation: portrait){
      #mainPreview{top:12px;right:14px;width:58vw;height:36vh;border-radius:18px}
      #globalControls{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 8px);left:50%;transform:translateX(-50%);width:min(94vw,560px);padding:8px 10px;z-index:9999}
      #streamPanel{width:190px}
      #roomBar{left:200px}
    }
  </style>
</head>
<body>
  <div id="playerContainer" class="ui-visible" aria-label="Ù…Ø´ØºÙ‘Ù„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª">
    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
    <aside id="streamPanel" aria-label="Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨Ø«">
      <div class="panel-title">SOURCES</div>
      <ul id="streamList"></ul>
    </aside>

    <!-- Ø´Ø§Ø´ØªØ§Ù† -->
    <div id="activeCam" class="videoFrame" aria-label="Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù†Ø´Ø·Ø©"></div>
    <div id="mainPreview" class="videoFrame" title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±" aria-label="Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"></div>

    <div class="hint">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„ØªÙƒØ¨ÙŠØ± â€¢ Ø£Ùˆ Ø§Ø¶ØºØ· F</div>

    <!-- Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¨Ø¯Ø¡ -->
    <div id="gatePlay" role="dialog" aria-modal="true" aria-label="Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„">
      <div class="gate-card">
        <div class="icon">â–¶</div>
        <div>
          <div style="color:#fff;font-weight:800;margin-bottom:6px">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
          <div style="font-size:12px;color:#eaeaf0b3">Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„</div>
        </div>
        <button id="startBtn" aria-label="Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢Ù†">ØªØ´ØºÙŠÙ„/Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
      </div>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø¹Ù„ÙˆÙŠØ© -->
    <div id="utilityControls" role="toolbar" aria-label="Ø£Ø¯ÙˆØ§Øª">
      <button id="btnSplit" title="ØªÙ‚Ø³ÙŠÙ…">ØªÙ‚Ø³ÙŠÙ…</button>
      <button id="btnFill"  title="Ù…Ù„Ø¡">Ù…Ù„Ø¡</button>
      <button id="btnSound" title="ØµÙˆØª">ğŸ”Š/ğŸ”‡</button>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø³ÙÙ„ÙŠØ© Ø¨Ø³ÙŠØ·Ø© -->
    <div id="globalControls" role="group" aria-label="ØªØ­ÙƒÙ…">
      <button id="gBack" title="âª -5s">âª 5s</button>
      <button id="gPlay" title="â¯">â¯</button>
      <button id="gFwd"  title="+5s â©">5s â©</button>
      <div id="status" style="color:#fff;margin-inline-start:10px;font-size:12px;opacity:.8"></div>
    </div>

    <!-- ØºØ±ÙØ© LiveKit -->
    <div id="roomBar">
      <span class="badge" id="lkState"><span class="badge dot" id="lkDot" style="background:#e67e22"></span> LiveKit: Ù…ÙØµÙˆÙ„</span>
      <select id="roomName">
        <option value="studio-1">studio-1</option>
        <option value="studio-2">studio-2</option>
        <option value="studio-3">studio-3</option>
        <option value="studio-4">studio-4</option>
        <option value="studio-5">studio-5</option>
        <option value="studio-6">studio-6</option>
        <option value="studio-7">studio-7</option>
        <option value="studio-8">studio-8</option>
        <option value="studio-9">studio-9</option>
        <option value="studio-10">studio-10</option>
      </select>
      <button id="btnJoin">Ø§Ù†Ø¶Ù… Ù„Ù„ØºØ±ÙØ©</button>
      <button id="btnLeave" disabled>Ù…ØºØ§Ø¯Ø±Ø©</button>
      <button id="btnMic" disabled>Ø§Ù„Ù…Ø§ÙŠÙƒ</button>
      <button id="btnCam" disabled>Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    </div>
  </div>

  <script>window.HLS_BASE = "https://hls-proxy.it-f2c.workers.dev";</script>

  <script>
  (function(){
    'use strict';

    /*** ========= ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØµØ§Ø¯Ø± ========= ***/
    // Ø§ØªØ±Ùƒ HLS_BASE ÙØ§Ø±ØºØ© Ù„ØªØ³ØªØ®Ø¯Ù… /hls Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù†Ø·Ø§Ù‚ (Pages Function)
    const HLS_BASE = (window.HLS_BASE || '').replace(/\/+$/, '');
    const build = (p) => HLS_BASE ? (HLS_BASE + p) : p;

    // Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ) â€” ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ø§ØªÙÙ‚Ù†Ø§
    const SOURCES = {
      main:  build('/hls/live/playlist.m3u8'),
      cam1:  build('/hls/lastone/playlist.m3u8'),
      cam2:  build('/hls/live2/playlist.m3u8'),
      cam3:  build('/hls/live3/playlist.m3u8'),
      cam4:  build('/hls/live4/playlist.m3u8'),
      cam5:  build('/hls/live5/playlist.m3u8'),
      cam6:  build('/hls/live6/playlist.m3u8'),
      cam7:  build('/hls/live7/playlist.m3u8'),
    };

    const CHANNELS = [
      {id:'main', label:'MAIN',  url:SOURCES.main},
      {id:'cam1', label:'CAM1',  url:SOURCES.cam1},
      {id:'cam2', label:'CAM2',  url:SOURCES.cam2},
      {id:'cam3', label:'CAM3',  url:SOURCES.cam3},
      {id:'cam4', label:'CAM4',  url:SOURCES.cam4},
      {id:'cam5', label:'CAM5',  url:SOURCES.cam5},
      {id:'cam6', label:'DRONE', url:SOURCES.cam6},
      {id:'cam7', label:'SINEFLEX', url:SOURCES.cam7},
    ];

    /*** ========= Ø¹Ù†Ø§ØµØ± DOM ========= ***/
    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));

    const root      = $('#playerContainer');
    const previewEl = $('#mainPreview');
    const activeEl  = $('#activeCam');
    const listEl    = $('#streamList');
    const gateEl    = $('#gatePlay');
    const startBtn  = $('#startBtn');

    const btnSplit  = $('#btnSplit');
    const btnFill   = $('#btnFill');
    const btnSound  = $('#btnSound');
    const gBack     = $('#gBack');
    const gPlay     = $('#gPlay');
    const gFwd      = $('#gFwd');
    const statusEl  = $('#status');

    const roomSel   = $('#roomName');
    const btnJoin   = $('#btnJoin');
    const btnLeave  = $('#btnLeave');
    const btnMic    = $('#btnMic');
    const btnCam    = $('#btnCam');
    const lkDot     = $('#lkDot');
    const lkState   = $('#lkState');

    /*** ========= Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ ========= ***/
    let mainPlayer  = null;   // {kind:'hls'|'native', hls?, video}
    let activePlayer= null;
    let currentActiveId = 'cam1';
    let uiHideTimer = null;

    // ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
    function ensureVideo(container){
      let v = $('video', container);
      if(!v){
        v = document.createElement('video');
        v.setAttribute('playsinline','');
        v.setAttribute('webkit-playsinline','');
        v.muted = true;
        v.controls = false;
        container.innerHTML = '';
        container.appendChild(v);
      }
      return v;
    }

    /*** ========= Ù…ÙØ³Ø§Ø¹Ø¯Ø© HLS ========= ***/
    function attachM3U8(video, url){
      // Ø§ÙØµÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚
      if(video.__hls){
        try { video.__hls.destroy(); } catch(_){}
        video.__hls = null;
      }
      video.pause();
      video.removeAttribute('src');
      video.load();

      // Safari/iOS ÙŠØ¯Ø¹Ù… HLS Ø£ØµÙ„Ø§Ù‹
      const canNative = video.canPlayType('application/vnd.apple.mpegurl');
      if (window.Hls && window.Hls.isSupported && window.Hls.isSupported()) {
        const hls = new window.Hls({
          maxBufferLength: 10,
          backBufferLength: 10,
          liveDurationInfinity:true,
        });
        video.__hls = hls;
        hls.on(window.Hls.Events.ERROR, (_, data)=>{
          console.warn('[HLS] ERROR', data);
          statusEl.textContent = 'HLS ERROR: ' + (data?.details || data?.type || 'error');
        });
        hls.loadSource(url);
        hls.attachMedia(video);
        return {kind:'hls', hls, video};
      } else if (canNative) {
        video.src = url;
        return {kind:'native', video};
      } else {
        alert('Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ HLSØŒ Ø¬Ø±Ù‘Ø¨ Safari Ø£Ùˆ Chrome Ø­Ø¯ÙŠØ«.');
        return null;
      }
    }

    function playSafe(player){
      if(!player) return;
      const v = player.video;
      v.play().catch(()=>{
        // ÙŠØªØ·Ù„Ø¨ ØªÙØ§Ø¹Ù„
        statusEl.textContent = 'Ø§Ø¶ØºØ· ØªØ´ØºÙŠÙ„ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ (Autoplay)';
      });
    }

    /*** ========= Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ø± ========= ***/
    function buildList(){
      listEl.innerHTML = '';
      CHANNELS.forEach(ch=>{
        const li = document.createElement('li');
        li.className = 'stream-item';
        li.dataset.id = ch.id;
        li.innerHTML = `
          <span class="dot" id="dot-${ch.id}"></span>
          <span class="stream-name">${ch.label}</span>
        `;
        li.addEventListener('click', ()=>switchActive(ch.id));
        listEl.appendChild(li);
      });
      markActive(currentActiveId);
    }
    function markActive(id){
      $$('.stream-item', listEl).forEach(el=>{
        el.classList.toggle('active', el.dataset.id===id);
      });
    }

    /*** ========= ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© (Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡) ========= ***/
    async function pingStreams(){
      const now = Date.now();
      const paths = [
        {id:'main', p:'/hls/live/playlist.m3u8'},
        {id:'cam1', p:'/hls/lastone/playlist.m3u8'},
        {id:'cam2', p:'/hls/live2/playlist.m3u8'},
        {id:'cam3', p:'/hls/live3/playlist.m3u8'},
        {id:'cam4', p:'/hls/live4/playlist.m3u8'},
        {id:'cam5', p:'/hls/live5/playlist.m3u8'},
        {id:'cam6', p:'/hls/live6/playlist.m3u8'},
        {id:'cam7', p:'/hls/live7/playlist.m3u8'},
      ];
      await Promise.all(paths.map(async ({id,p})=>{
        const dot = $(`#dot-${id}`);
        if(!dot) return;
        try{
          const res = await fetch(`${p}?ping=${now}`, {method:'HEAD', cache:'no-store'});
          dot.classList.toggle('online', res.ok);
        }catch{
          dot.classList.remove('online');
        }
      }));
    }
    setInterval(pingStreams, 8000);

    /*** ========= Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ========= ***/
    function switchMain(){
      const v = ensureVideo(previewEl);
      mainPlayer = attachM3U8(v, SOURCES.main);
      playSafe(mainPlayer);
    }
    function switchActive(id){
      currentActiveId = id;
      markActive(id);
      const v = ensureVideo(activeEl);
      const url = CHANNELS.find(c=>c.id===id)?.url;
      if(!url) return;
      activePlayer = attachM3U8(v, url);
      playSafe(activePlayer);
    }

    /*** ========= Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¨Ø¯Ø¡ ========= ***/
    async function startPlayback(){
      try{
        switchMain();
        switchActive(currentActiveId);
        gateEl.classList.add('hidden');
        statusEl.textContent = '';
        await pingStreams();
      }catch(e){
        console.error(e);
        alert('ØªØ¹Ø°Ø± Ø§Ù„ØªØ´ØºÙŠÙ„: '+ (e?.message || e));
      }
    }

    /*** ========= Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ø§Ù…Ø© ========= ***/
    gPlay.addEventListener('click', ()=>{
      const v = activePlayer?.video || mainPlayer?.video;
      if(!v) return;
      if(v.paused) v.play(); else v.pause();
    });
    gBack.addEventListener('click', ()=>{
      const v = activePlayer?.video || mainPlayer?.video;
      if(!v) return;
      const t = v.currentTime - 5;
      if (v.seekable && v.seekable.length) v.currentTime = Math.max(v.seekable.start(0), t);
      else v.currentTime = Math.max(0, t);
    });
    gFwd.addEventListener('click', ()=>{
      const v = activePlayer?.video || mainPlayer?.video;
      if(!v) return;
      const t = v.currentTime + 5;
      if (v.seekable && v.seekable.length) v.currentTime = Math.min(v.seekable.end(v.seekable.length-1), t);
      else v.currentTime = t;
    });

    // ØªÙ‚Ø³ÙŠÙ…/Ù…Ù„Ø¡/ØµÙˆØª
    btnSplit.addEventListener('click', ()=>root.classList.toggle('split'));
    btnFill.addEventListener('click', ()=>root.classList.toggle('cover-one'));
    btnSound.addEventListener('click', ()=>{
      const v = activePlayer?.video || mainPlayer?.video;
      if(!v) return;
      v.muted = !v.muted;
    });

    // ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    previewEl.addEventListener('click', ()=>root.classList.toggle('main-full'));
    window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='f') root.classList.toggle('main-full') });

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    function showUI(){
      root.classList.add('ui-visible');
      root.classList.remove('ui-hidden');
      clearTimeout(uiHideTimer);
      uiHideTimer = setTimeout(()=>{
        root.classList.remove('ui-visible');
        root.classList.add('ui-hidden');
      }, 1800);
    }
    ['mousemove','mousedown','keydown','touchstart'].forEach(ev=>window.addEventListener(ev, showUI, {passive:true}));
    showUI();

    // Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡
    startBtn.addEventListener('click', startPlayback);

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§
    buildList();
    pingStreams();

    /*** ========= LiveKit ========= ***/
    // Ù†Ø­Ù…Ù„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨ ÙÙ‚Ø·
    function loadScript(src){
      return new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src=src; s.async=true; s.onload=()=>res(); s.onerror=()=>rej(new Error('load failed '+src));
        document.head.appendChild(s);
      });
    }
    async function ensureLiveKit(){
      // Ø£Ø¹Ø¯ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø­Ù…Ù‘Ù„ Ø³Ø§Ø¨Ù‚Ù‹Ø§
      const g = (window.LivekitClient || window.LiveKit || window.LK || {});
      if (g && (g.connect || typeof window.connect==='function')) {
        return { ...(g||{}), connect: g.connect || window.connect };
      }
      await loadScript('/vendor/livekit-client.umd.min.js');
      const gg = (window.LivekitClient || window.LiveKit || window.LK || {});
      if (gg && (gg.connect || typeof window.connect==='function')) {
        return { ...(gg||{}), connect: gg.connect || window.connect };
      }
      throw new Error('LiveKit library did not load');
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ© (Ø¹Ø¯Ù‘Ù„ WS URL Ø¹Ù†Ø¯Ùƒ)
    const LIVEKIT_WS_URL = ''; // Ù…Ø«Ø§Ù„: wss://xxx.livekit.cloud
    const TOKEN_ENDPOINTS = [
      'https://steps-livekit-api.onrender.com/api/token',
      'https://steps-livekit-api.onrender.com/token',
      'https://steps-livekit-api.onrender.com/api/rtoken',
      'https://steps-livekit-api.onrender.com/api/get-token',
    ];

    async function fetchTokenSmart(room, identity){
      const tried = [];
      for (const base of TOKEN_ENDPOINTS){
        const url = `${base}?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`;
        tried.push(url);
        try{
          const r = await fetch(url, {cache:'no-store'});
          if(r.ok){
            // Ù†Ø­Ø§ÙˆÙ„ JSON Ø«Ù… Ù†Øµ
            const ct = r.headers.get('content-type')||'';
            if(ct.includes('application/json')){
              const j = await r.json();
              if(j?.token) return j.token;
              if(typeof j === 'string') return j;
            }
            const t = await r.text();
            if(t) return t;
          }
        }catch{}
      }
      alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†. ØªÙ…Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù„Ù‰:\n' + tried.join('\n'));
      throw new Error('no token');
    }

    let lk = null; // {room, connect, ...}
    let lkRoom = null;

    function setLKState(connected){
      lkDot.style.background = connected ? '#2ecc71' : '#e67e22';
      lkState.innerHTML = `<span class="badge dot" style="background:${connected?'#2ecc71':'#e67e22'}"></span> LiveKit: ${connected?'Ù…ØªØµÙ„':'Ù…ÙØµÙˆÙ„'}`;
      btnLeave.disabled = !connected;
      btnMic.disabled = !connected;
      btnCam.disabled = !connected;
      btnJoin.disabled = connected;
    }

    btnJoin.addEventListener('click', async ()=>{
      try{
        lk = await ensureLiveKit();
      }catch(e){
        console.error('joinLiveKit error', e);
        alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: LiveKit library did not load');
        return;
      }

      const room = roomSel.value || 'studio-1';
      const identity = 'guest-' + Math.random().toString(36).slice(2,7);
      let token = null;

      try{
        token = await fetchTokenSmart(room, identity);
      }catch(e){ return; }

      try{
        const wsUrl = LIVEKIT_WS_URL || (lk?.RegionUrlProvider ? lk.RegionUrlProvider.createUrl(room) : null);
        const urlToUse = wsUrl || (typeof lk?.defaultWsUrl === 'function' ? lk.defaultWsUrl(room) : null) || '';
        const connectFn = lk.connect;
        if (typeof connectFn !== 'function') throw new Error('LK.connect not available');

        lkRoom = await connectFn(urlToUse, token, {
          autoSubscribe:true,
          stopLocalTrackOnUnpublish:true,
        });
        setLKState(true);
      }catch(e){
        console.error('joinLiveKit error', e);
        alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: '+ (e?.message||e));
      }
    });

    btnLeave.addEventListener('click', ()=>{
      try{ lkRoom?.disconnect?.(); }catch(_){}
      lkRoom=null; setLKState(false);
    });

    btnMic.addEventListener('click', async ()=>{
      if(!lkRoom) return;
      try{
        const micEnabled = lkRoom.localParticipant.isMicrophoneEnabled;
        if(micEnabled && lkRoom.localParticipant.isMicrophoneEnabled()){
          await lkRoom.localParticipant.setMicrophoneEnabled(false);
        }else{
          await lkRoom.localParticipant.setMicrophoneEnabled(true);
        }
      }catch(e){ console.warn(e); }
    });
    btnCam.addEventListener('click', async ()=>{
      if(!lkRoom) return;
      try{
        const camEnabled = lkRoom.localParticipant.isCameraEnabled && lkRoom.localParticipant.isCameraEnabled();
        await lkRoom.localParticipant.setCameraEnabled(!camEnabled);
      }catch(e){ console.warn(e); }
    });

    // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©: Ù„Ø§ Ù†Ø´ØºÙ‘Ù„ Ø´ÙŠØ¡ Ø­ØªÙ‰ ÙŠØ¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    setLKState(false);

  })();
  </script>
</body>
</html>
