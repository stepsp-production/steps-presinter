<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>لوحة المراقبة - HLS + LiveKit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ملاحظة: الـ CSP يتم عبر _headers على Pages وليس هنا -->
  <style>
    :root{--bg:#0b0d10;--card:#12151a;--muted:#7b8694;--ok:#19c37d;--bad:#e54;--warn:#f6c41c;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#e9eef5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans Arabic",Tahoma,Arial,sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;background:#0f1216;position:sticky;top:0;z-index:5;border-bottom:1px solid #1c212b}
    header .left, header .right{display:flex;gap:10px;align-items:center}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#141923;border:1px solid #202735;color:#b7c3d1;font-size:13px}
    .btn{background:#1a212c;color:#e9eef5;border:1px solid #2a3442;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .toggle{display:inline-flex;gap:8px;align-items:center}
    .row{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
    @media (max-width:1100px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #1c232f;border-radius:14px}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid #1c232f;color:#dfe8f3;font-size:15px}
    .card .body{padding:12px}
    .rooms{max-height:60vh;overflow:auto}
    .room{display:flex;align-items:center;justify-content:space-between;border:1px solid #1b2230;background:#0f141b;margin-bottom:8px;border-radius:10px;padding:8px}
    .room .meta small{display:block;color:#8ea0b6}
    .room .status{width:10px;height:10px;border-radius:50%;}
    .room .status.ok{background:var(--ok)}
    .room .status.bad{background:var(--bad)}
    .cams{display:grid;grid-template-columns: repeat(4, 1fr); gap:10px}
    @media (max-width:1350px){.cams{grid-template-columns: repeat(3, 1fr)}}
    @media (max-width:980px){.cams{grid-template-columns: repeat(2, 1fr)}}
    @media (max-width:640px){.cams{grid-template-columns: 1fr}}
    video{width:100%;aspect-ratio:16/9;background:black;border-radius:12px;border:1px solid #1c232f}
    .mainWrap{grid-column:1/-1}
    .streamCard{position:relative}
    .dot{position:absolute;top:8px;left:8px;width:10px;height:10px;border-radius:50%;box-shadow:0 0 0 2px #0f141b}
    .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)} .dot.warn{background:var(--warn)}
    .label{position:absolute;bottom:8px;right:8px;background:#0e1220b3;padding:4px 8px;border-radius:8px;border:1px solid #233046;color:#c9d6e4;font-size:12px}
    .thumb{cursor:pointer;transition:transform .15s ease}
    .thumb:hover{transform:scale(1.01)}
    .help{color:var(--muted);font-size:12px;margin-top:8px}
    .muted{color:var(--muted)}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    .switch{position:relative;display:inline-flex;align-items:center;gap:8px}
    .switch input{appearance:none;width:38px;height:22px;background:#1a212c;border-radius:999px;border:1px solid #2a3442;position:relative;outline:none;cursor:pointer}
    .switch input:checked{background:#15351e;border-color:#1f5a33}
    .switch input::after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;background:#e9eef5;border-radius:50%;transition:left .15s ease}
    .switch input:checked::after{left:18px}
    .error{color:#ffb4aa}
    footer{padding:10px 16px;color:#7f8ea3}
  </style>
  <script defer src="/vendor/hls.min.js"></script>
  <script defer src="/vendor/livekit-client.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="left">
      <span class="badge">لوحة المراقبة</span>
      <span id="cspNote" class="badge" title="CSP / الاتصالات">CSP OK</span>
    </div>
    <div class="right controls">
      <label class="switch" title="مزامنة كل الكاميرات مع الرئيسية بشكل مستمر">
        <input id="autoSyncToggle" type="checkbox" />
        <span>مزامنة تلقائية</span>
      </label>
      <button id="syncNowBtn" class="btn" title="مزامنة الآن">مزامنة الآن</button>
      <button id="reloadBtn" class="btn" title="إعادة تحميل">إعادة تحميل</button>
    </div>
  </header>

  <div class="row">
    <!-- لوحة الغرف -->
    <section class="card">
      <h3>الغرف (LiveKit)</h3>
      <div class="body rooms" id="roomsBox">
        <div class="help">سيتم تحميل قائمة الغرف تلقائياً. إن لم تظهر، تحقق من API: <span class="muted">https://steps-livekit-api.onrender.com</span></div>
      </div>
      <div class="body">
        <div class="controls">
          <button id="refreshRoomsBtn" class="btn">تحديث الغرف</button>
          <button id="leaveRoomBtn" class="btn" disabled>مغادرة الغرفة</button>
        </div>
        <div id="roomStatus" class="help"></div>
      </div>
    </section>

    <!-- الفيديوهات -->
    <section class="card">
      <h3>الكاميرات (HLS)</h3>
      <div class="body">
        <div id="cams" class="cams">
          <!-- الرئيسية -->
          <div class="streamCard mainWrap">
            <span class="dot bad" id="dot-main"></span>
            <span class="label">MAIN - live</span>
            <video id="video-main" playsinline autoplay muted></video>
          </div>
          <!-- البقية -->
        </div>
        <div class="help">إذا ظهرت الشاشة سوداء مع أن التحميل يعمل، اضغط على الفيديو للتشغيل يدويًا (سياسة المتصفح)، أو عطّل كتم الصوت مؤقتًا ثم أعد التشغيل.</div>
      </div>
    </section>
  </div>

  <footer>تشغيل عبر HLS Proxy: <span id="baseHost" class="muted"></span> — آخر حالة: <span id="lastMsg" class="muted">—</span></footer>

<script>
/** إعدادات عامة **/
window.HLS_BASE = "https://hls-proxy.it-f2c.workers.dev"; // الوركر الذي يربط التانل
const LIVEKIT_API = "https://steps-livekit-api.onrender.com"; // API الخارجي لديك (قراءة الغرف/توكِن)
const STREAMS = [
  { key: "main",  path: "/hls/live/playlist.m3u8",  label: "MAIN - live"},
  { key: "live2", path: "/hls/live2/playlist.m3u8", label: "live2"},
  { key: "live3", path: "/hls/live3/playlist.m3u8", label: "live3"},
  { key: "live4", path: "/hls/live4/playlist.m3u8", label: "live4"},
  { key: "live5", path: "/hls/live5/playlist.m3u8", label: "live5"},
  { key: "live6", path: "/hls/live6/playlist.m3u8", label: "live6"},
  { key: "live7", path: "/hls/live7/playlist.m3u8", label: "live7"},
  { key: "last",  path: "/hls/lastone/playlist.m3u8", label: "lastone"}
];
const hlsPlayers = new Map(); // key -> {hls, video}

/** مساعدات واجهة **/
const $ = (sel)=>document.querySelector(sel);
const mk = (tag, cls)=>{const el = document.createElement(tag); if(cls) el.className=cls; return el;}
const setDot = (key, state)=> {
  const dot = document.getElementById("dot-"+key);
  if(!dot) return;
  dot.classList.remove("ok","bad","warn");
  dot.classList.add(state);
};
const log = (msg)=> { $("#lastMsg").textContent = msg; }

/** بناء بطاقات الكاميرات الثانوية **/
(function buildCams(){
  const wrap = $("#cams");
  STREAMS.filter(s=>s.key!=="main").forEach(s=>{
    const card = mk("div","streamCard thumb");
    card.title = "انقر لجعلها رئيسية";
    const dot = mk("span","dot bad"); dot.id = "dot-"+s.key; card.appendChild(dot);
    const lbl = mk("span","label"); lbl.textContent = s.label; card.appendChild(lbl);
    const v = mk("video"); v.id = "video-"+s.key; v.playsInline = true; v.muted = true; v.autoplay = true; card.appendChild(v);
    card.addEventListener("click", ()=>swapToMain(s.key));
    wrap.appendChild(card);
  });
})();

/** تشغيل HLS على عنصر فيديو معين **/
async function attachHlsTo(video, url, key){
  try {
    if(window.Hls && window.Hls.isSupported()){
      const hls = new Hls({
        enableWorker: true,
        lowLatencyMode: true,
        backBufferLength: 30,
      });
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, async()=>{
        setDot(key,"ok");
        try { await video.play(); } catch(e){ /* تجاهل */ }
      });
      hls.on(Hls.Events.ERROR, (e, data)=>{
        if(data?.fatal){
          setDot(key,"bad");
          log(`[HLS:${key}] ${data.details || data.type}`);
          try { hls.destroy(); } catch(_){}
        }else{
          setDot(key,"warn");
        }
      });
      hlsPlayers.set(key, {hls, video});
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = url;
      video.addEventListener('loadedmetadata', async()=>{ setDot(key,"ok"); try{await video.play();}catch(_){}} );
      hlsPlayers.set(key, {hls:null, video});
    } else {
      setDot(key,"bad");
      log("Hls.js غير مدعوم في هذا المتصفح.");
    }
  } catch(err){
    setDot(key,"bad");
    log("attachHlsTo error: "+(err?.message||err));
  }
}

/** بداية التشغيل لكل الكاميرات **/
async function startAll(){
  $("#baseHost").textContent = window.HLS_BASE;
  for(const s of STREAMS){
    const v = document.getElementById("video-"+s.key);
    const full = window.HLS_BASE + s.path;
    await attachHlsTo(v, full, s.key);
  }
}
startAll();

/** تبديل الرئيسية مع أخرى **/
function swapToMain(key){
  if(key==="main") return;
  // تبادل الـ src بين الفيديوهين عبر إعادة التهيئة
  const main = STREAMS.find(s=>s.key==="main");
  const other = STREAMS.find(s=>s.key===key);
  if(!main || !other) return;

  // دمّر اللاعبين أولاً
  for(const k of ["main", key]){
    const p = hlsPlayers.get(k);
    if(p?.hls){ try{p.hls.destroy();}catch(_){} }
  }

  // بدّل المسارات المنطقية
  const tmpPath = main.path; main.path = other.path; other.path = tmpPath;

  // حدّث الملصقات
  $(`.label`).textContent = "MAIN - " + main.path.split("/")[2];

  // أعِد التشغيل
  attachHlsTo($("#video-main"), window.HLS_BASE+main.path, "main");
  attachHlsTo($("#video-"+key), window.HLS_BASE+other.path, key);
}

/** المزامنة **/
function syncOnce(){
  const mainP = hlsPlayers.get("main");
  if(!mainP?.video) return;
  const t = mainP.video.currentTime;
  for(const s of STREAMS){
    if(s.key==="main") continue;
    const p = hlsPlayers.get(s.key);
    if(!p?.video) continue;
    try{
      const drift = Math.abs(p.video.currentTime - t);
      if(drift > 0.6){ p.video.currentTime = t; }
    }catch(_){}
  }
}
let syncTimer = null;
$("#syncNowBtn").addEventListener("click", syncOnce);
$("#autoSyncToggle").addEventListener("change", (e)=>{
  if(e.target.checked){
    syncTimer = setInterval(syncOnce, 1200);
  }else{
    clearInterval(syncTimer); syncTimer = null;
  }
});
$("#reloadBtn").addEventListener("click", ()=> location.reload());

/** Ping حالات البث (GET بدلاً من HEAD) لإظهار النقطة الخضراء في الواجهة **/
async function pingStream(key, path){
  try{
    const url = `${window.HLS_BASE}${path}?ping=${Date.now()}`;
    const res = await fetch(url, { method:"GET", cache:"no-store", mode:"cors" });
    if(!res.ok){ setDot(key,"bad"); return; }
    const text = await res.text();
    if(text && text.includes("#EXTM3U")) setDot(key,"ok"); else setDot(key,"warn");
  }catch(_){ setDot(key,"bad"); }
}
async function pingAll(){
  for(const s of STREAMS){ pingStream(s.key, s.path); }
}
setInterval(pingAll, 5000);
pingAll();

/** —— الغرف (LiveKit) —— **/
let currentRoom = null; // LiveKit Room instance
async function ensureLiveKit(){
  if(!window.LivekitClient && !window.livekit){
    throw new Error("LiveKit library did not load");
  }
}
function renderRooms(list){
  const box = $("#roomsBox");
  box.innerHTML = "";
  list.forEach((r,i)=>{
    const row = mk("div","room");
    const meta = mk("div","meta");
    const title = mk("div"); title.textContent = r.name || `room-${i+1}`;
    const small = mk("small"); small.textContent = (r.numParticipants!=null? `عدد المشاركين: ${r.numParticipants}` : "—");
    meta.appendChild(title); meta.appendChild(small);

    const right = mk("div");
    const st = mk("span","status "+(r.isActive?"ok":"bad")); right.appendChild(st);
    const btn = mk("button","btn"); btn.textContent = "انضمام";
    btn.addEventListener("click", ()=>joinRoom(r.name || `room-${i+1}`));
    right.appendChild(btn);

    row.appendChild(meta); row.appendChild(right);
    box.appendChild(row);
  });
}
async function fetchRooms(){
  try{
    await ensureLiveKit();
  }catch(e){
    $("#roomStatus").innerHTML = `<span class="error">LiveKit لم تُحمَّل: ${e.message}</span>`;
    return renderRooms(Array.from({length:10},(_,i)=>({name:`room-${i+1}`, isActive:false})));
  }
  try{
    const res = await fetch(`${LIVEKIT_API}/rooms`, {cache:"no-store"});
    if(res.ok){
      const data = await res.json();
      // نتوقع شكلاً: [{name, numParticipants, isActive}, ...] وإلا نحول حسب الموجود
      const rooms = Array.isArray(data) ? data.map(x=>({
        name: x.name || x.room || x.id || "room",
        numParticipants: x.numParticipants ?? x.num_participants ?? null,
        isActive: x.isActive ?? (x.numParticipants>0)
      })) : [];
      // في حال خالٍ أو غير متوقع، وفر 10 غرف افتراضية
      const list = rooms.length>0 ? rooms : Array.from({length:10},(_,i)=>({name:`room-${i+1}`, isActive:false}));
      renderRooms(list);
      $("#roomStatus").textContent = "تم تحديث الغرف.";
    }else{
      $("#roomStatus").innerHTML = `<span class="error">فشل جلب الغرف (${res.status})</span>`;
      renderRooms(Array.from({length:10},(_,i)=>({name:`room-${i+1}`, isActive:false})));
    }
  }catch(err){
    $("#roomStatus").innerHTML = `<span class="error">خطأ الاتصال بالغرف: ${err.message}</span>`;
    renderRooms(Array.from({length:10},(_,i)=>({name:`room-${i+1}`, isActive:false})));
  }
}
async function joinRoom(roomName){
  try{
    await ensureLiveKit();
    $("#roomStatus").textContent = `يتم الانضمام إلى ${roomName}...`;
    // احصل على معلومات الخادم والرمز (حسب API لديك)
    // نتوقع endpoint يعيد {url, token}
    const who = encodeURIComponent("browser-"+Math.random().toString(36).slice(2,8));
    const res = await fetch(`${LIVEKIT_API}/token?room=${encodeURIComponent(roomName)}&identity=${who}`, {cache:"no-store"});
    if(!res.ok){ throw new Error(`token API ${res.status}`); }
    const { url, token } = await res.json();
    if(!url || !token) throw new Error("رد غير صالح من token API");
    const { Room, RoomEvent, createLocalTracks } = window.livekit || window.LivekitClient;

    // أنشئ الغرفة واتصل
    const room = new Room();
    currentRoom = room;
    $("#leaveRoomBtn").disabled = false;

    room.on(RoomEvent.Connected, ()=> $("#roomStatus").textContent = `متصل بالغرفة: ${roomName}`);
    room.on(RoomEvent.Disconnected, ()=> $("#roomStatus").textContent = `تمت مغادرة الغرفة: ${roomName}`);
    room.on(RoomEvent.ParticipantConnected, p => log(`انضم: ${p.identity}`));
    room.on(RoomEvent.ParticipantDisconnected, p => log(`غادر: ${p.identity}`));

    await room.connect(url, token);

    // إن أردت نشر الصوت/الفيديو المحلي (اختياري):
    // const tracks = await createLocalTracks({ audio: true, video: true });
    // await room.localParticipant.publishTracks(tracks);

  }catch(err){
    $("#roomStatus").innerHTML = `<span class="error">تعذر الانضمام: ${err.message}</span>`;
  }
}
$("#leaveRoomBtn").addEventListener("click", ()=>{
  try{
    if(currentRoom){ currentRoom.disconnect(); }
  }catch(_){}
  currentRoom = null;
  $("#leaveRoomBtn").disabled = true;
  $("#roomStatus").textContent = "تمت المغادرة.";
});
$("#refreshRoomsBtn").addEventListener("click", fetchRooms);

// تحميل أولي لقائمة الغرف
fetchRooms();

/** تشخيص بسيط لـ CSP في الواجهة **/
(function checkCSP(){
  const ok = [location.origin.includes("http") ? "self" : "", "workers.dev", "trycloudflare.com", "livekit.cloud"].filter(Boolean).join(" • ");
  $("#cspNote").textContent = "CSP OK: "+ok;
})();
</script>
</body>
</html>
