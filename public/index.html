<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Steps MultiCam + LiveKit</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%2300c19a'/%3E%3C/svg%3E"/>

<style>
:root{--btn:#00c19a;--btnh:#00ad8a;--btna:#009e7e;--panel:#0b0b0fe6;--bd:#ffffff26}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
#wrap{position:relative;height:100vh;width:100vw;overflow:hidden}
#active,#main{position:absolute;inset:0}
.video{width:100%;height:100%;object-fit:contain;background:#000}
#main{inset:auto 16px 16px auto;width:22%;height:24%;border:1px solid #fff2;border-radius:16px;z-index:5;cursor:pointer;transition:all .18s}

.split #main{inset:0;width:50%;height:100%;border:0;border-radius:0;cursor:default}
.split #active{left:0;width:50%}

#panel{position:absolute;top:10px;left:10px;width:230px;z-index:7}
.title{font-weight:900;letter-spacing:.8px;margin:6px 6px 12px}
.item{display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid #ffffff33;border-radius:12px;background:#0006;margin:8px 0;cursor:pointer}
.item:hover{background:#0009}
.dot{width:8px;height:8px;border-radius:50%;background:#666}
.ok{background:#0f0}

#bar{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:8px;align-items:center;background:var(--panel);border:1px solid var(--bd);border-radius:14px;padding:8px 10px;z-index:7}
button{appearance:none;border:0;border-radius:10px;background:var(--btn);color:#fff;font-weight:800;padding:9px 12px;cursor:pointer}
button:hover{background:var(--btnh)} button:active{background:var(--btna)}

#gate{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2));z-index:8}
#gate.hidden{display:none}
.card{display:flex;gap:12px;align-items:center;background:var(--panel);border:1px solid var(--bd);border-radius:14px;padding:16px 20px}

#hint{position:absolute;top:12px;right:16px;background:#000a;border:1px solid #fff2;border-radius:999px;padding:6px 10px;z-index:6}

.ui-hidden #panel, .ui-hidden #bar, .ui-hidden #hint, .ui-hidden #rooms{opacity:0;pointer-events:none;transition:opacity .25s}

/* Ù„ÙˆØ­Ø© Ø§Ù„ØºØ±Ù */
#rooms{position:absolute;right:12px;bottom:80px;z-index:7;background:var(--panel);border:1px solid var(--bd);border-radius:14px;padding:10px 12px;width:min(520px,92vw)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
input,select{background:#0d0f12;color:#fff;border:1px solid #ffffff30;border-radius:10px;padding:8px 10px}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;border:1px solid #ffffff30;background:#12151a;font-size:12px}
.icon{font-size:14px}
</style>
</head>
<body>
<div id="wrap" class="ui-hidden">

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ø± -->
  <aside id="panel" aria-label="Ù…ØµØ§Ø¯Ø±">
    <div class="title">SOURCES</div>
    <div id="list"></div>
  </aside>

  <!-- Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª -->
  <div id="active"></div>
  <div id="main" title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±"></div>

  <!-- Ø´Ø±ÙŠØ· ØªØ­ÙƒÙ… -->
  <div id="bar">
    <button id="btnStart">ØªØ´ØºÙŠÙ„/Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
    <button id="btnSplit">ØªÙ‚Ø³ÙŠÙ…</button>
    <button id="btnMute">ğŸ”Š/ğŸ”‡</button>
  </div>

  <!-- ØªÙ„Ù…ÙŠØ­ -->
  <div id="hint">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„ØªÙƒØ¨ÙŠØ± â€¢ F Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</div>

  <!-- Ø¨ÙˆØ§Ø¨Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ -->
  <div id="gate" role="dialog" aria-modal="true">
    <div class="card">
      <div class="icon" style="width:34px;height:34px;display:grid;place-items:center;border-radius:50%;border:1px solid #fff2;background:#111a">â–¶</div>
      <div>
        <div style="font-weight:800;margin-bottom:4px">Ø§Ø¶ØºØ· ØªØ´ØºÙŠÙ„ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„</div>
        <div style="font-size:12px;color:#eaeaf0b3">Ø³ÙŠØ¨Ø¯Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·</div>
      </div>
      <button id="go">ØªØ´ØºÙŠÙ„/Ø¨Ø¯Ø¡</button>
    </div>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØºØ±Ù (LiveKit) -->
  <section id="rooms" aria-label="Ø§Ù„ØºØ±Ù (LiveKit)">
    <div class="row">
      <span class="badge"><span class="icon">ğŸ¬</span> Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</span>
      <input id="showName" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" style="min-width:160px"/>
      <span class="badge"><span class="icon">ğŸ·ï¸</span> Ø§Ù„ØºØ±ÙØ©</span>
      <select id="roomSel">
        <option value="studio-1">studio-1</option>
        <option value="studio-2">studio-2</option>
        <option value="studio-3">studio-3</option>
        <option value="studio-4">studio-4</option>
        <option value="studio-5">studio-5</option>
        <option value="studio-6">studio-6</option>
        <option value="studio-7">studio-7</option>
        <option value="studio-8">studio-8</option>
        <option value="studio-9">studio-9</option>
        <option value="studio-10">studio-10</option>
      </select>
      <button id="btnJoin">Ø§Ù†Ø¶Ù… Ù„Ù„ØºØ±ÙØ©</button>
      <button id="btnLeave" disabled>Ù…ØºØ§Ø¯Ø±Ø©</button>
      <span id="lkState" class="badge"><span class="icon">ğŸŸ¢</span> LiveKit: Ù…ÙØµÙˆÙ„</span>
    </div>
    <div class="row">
      <button id="btnCam">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
      <button id="btnMic">Ø§Ù„Ù…Ø§ÙŠÙƒ</button>
    </div>
  </section>

</div>

<!-- ØªØ­Ù…ÙŠÙ„ hls Ù…Ù† Ù†Ø·Ø§Ù‚Ùƒ -->
<script>
function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.async=true;s.onload=res;s.onerror=()=>rej(new Error('load fail '+src));document.head.appendChild(s);});}
let HlsLib=null; async function ensureHls(){ if(HlsLib) return HlsLib; await loadScript('/vendor/hls.min.js'); if(window.Hls){HlsLib=window.Hls; return HlsLib;} throw new Error('HLS lib not loaded'); }
</script>

c

const $ = (s,p=document)=>p.querySelector(s);
const list = $('#list'), wrap=$('#wrap'), activeBox=$('#active'), mainBox=$('#main');
const btnSplit=$('#btnSplit'), btnStart=$('#btnStart'), btnMute=$('#btnMute');
const gate=$('#gate'), go=$('#go');

let vActive=null, vMain=null, hlsA=null, hlsM=null, isMuted=false, split=false, uiTimer=null;

// Ø¥Ù†Ø´Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ
function makeVideo(parent){
  const v=document.createElement('video');
  v.className='video'; v.playsInline=true; v.autoplay=false; v.controls=false; v.muted=isMuted;
  parent.innerHTML=''; parent.appendChild(v);
  return v;
}

// Ø±Ø¨Ø· HLS
async function attachM3U8(video,url){
  const Hls=await ensureHls();
  if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src=url; await video.play().catch(()=>{});
    return null;
  } else {
    const h=new Hls({ enableWorker:true, lowLatencyMode:true, backBufferLength:60, maxBufferLength:10 });
    h.on(Hls.Events.ERROR,(_,data)=>{ console.warn('[HLS] ERROR', data); });
    h.loadSource(url); h.attachMedia(video);
    await video.play().catch(()=>{});
    return h;
  }
}

async function switchActive(id){
  if (!vActive) return;
  const url=SOURCES[id]||SOURCES.cam1;
  if (hlsA && hlsA.destroy) { hlsA.destroy(); hlsA=null; }
  vActive.pause(); vActive.removeAttribute('src'); vActive.load();
  hlsA = await attachM3U8(vActive,url);
}
async function switchMain(id='main'){
  if (!vMain) return;
  const url=SOURCES[id]||SOURCES.main;
  if (hlsM && hlsM.destroy) { hlsM.destroy(); hlsM=null; }
  vMain.pause(); vMain.removeAttribute('src'); vMain.load();
  hlsM = await attachM3U8(vMain,url);
}

// Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© + Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡
function renderList(){
  list.innerHTML='';
  for (const [id,label] of order){
    const row=document.createElement('div');
    row.className='item'; row.dataset.id=id;
    row.innerHTML=`<div class="dot" id="dot-${id}"></div><div style="font-weight:800">${label}</div>`;
    row.onclick=()=> { if(id==='main') switchMain('main'); else switchActive(id); };
    list.appendChild(row);
  }
}

function pingStreams(){
  for (const [id] of order){
    const u=SOURCES[id]+(SOURCES[id].includes('?')?'&':'?')+'ping='+Date.now();
    fetch(u,{method:'HEAD'}).then(r=>{
      const dot=$('#dot-'+id); if(dot) dot.classList.toggle('ok', r.ok);
    }).catch(()=>{ const dot=$('#dot-'+id); if(dot) dot.classList.remove('ok');});
  }
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„/Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
async function startPlayback(){
  vActive=makeVideo(activeBox);
  vMain=makeVideo(mainBox);
  try{
    await switchMain('main');
    await switchActive('cam1');
    btnStart.disabled=true; go.disabled=true; gate.classList.add('hidden');
  }catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¨Ø¯Ø¡: '+(e?.message||e)); }
}

// ÙˆØ§Ø¬Ù‡Ø©
btnSplit.onclick=()=>{ split=!split; wrap.classList.toggle('split',split); };
btnMute.onclick =()=>{ isMuted=!isMuted; if(vMain) vMain.muted=isMuted; if(vActive) vActive.muted=isMuted; };
go.onclick=startPlayback; btnStart.onclick=startPlayback;
mainBox.addEventListener('click',()=>{ split=!split; wrap.classList.toggle('split',split); });

// Ø¥Ø®ÙØ§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ
function showUI(){ wrap.classList.remove('ui-hidden'); clearTimeout(uiTimer); uiTimer=setTimeout(()=>wrap.classList.add('ui-hidden'), 1600); }
document.addEventListener('mousemove', showUI,{passive:true});
document.addEventListener('keydown',(e)=>{ if(e.key.toLowerCase()==='f') showUI(); });

// ØªÙ‡ÙŠØ¦Ø©
renderList(); pingStreams(); setInterval(pingStreams,8000);
</script>

<!-- LiveKit -->
<script>
let LK=null, room=null, camOn=false, micOn=false;

async function ensureLiveKit(){
  if (LK) return LK;
  await loadScript('/vendor/livekit-client.umd.min.js');
  if (!window.LiveKit) throw new Error('LiveKit library did not load');
  LK = window.LiveKit;
  return LK;
}

// Ø¬Ø±Ù‘Ø¨ Ø¹Ø¯Ø© Ù…Ø³Ø§Ø±Ø§Øª Ù„Ù„Ù€ API
async function fetchTokenSmart(room, identity){
  const base = 'https://steps-livekit-api.onrender.com';
  const paths = [
    `/api/token?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`,
    `/token?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`,
    `/api/rtoken?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`,
    `/api/get-token?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`
  ];
  const tried=[];
  for (const p of paths){
    const url = base + p; tried.push(url);
    try{
      const r = await fetch(url);
      if (!r.ok) continue;
      const ct = (r.headers.get('content-type')||'').toLowerCase();
      if (ct.includes('application/json')) {
        const j=await r.json();
        if (j?.token && j?.url) return { token:j.token, wsUrl:j.url };
        if (j?.token && j?.wsUrl) return { token:j.token, wsUrl:j.wsUrl };
        if (j?.token && j?.host)   return { token:j.token, wsUrl:`wss://${j.host}` };
      } else {
        const t = await r.text();
        const m = t.match(/(ws[s]?:\/\/[^\s"']+)/i);
        const token = t.replace(/[\r\n]/g,'').trim();
        if (m && token.length>20) return { token, wsUrl:m[1] };
      }
    }catch{}
  }
  throw new Error('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†. ØªÙ…Ù‘Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù„Ù‰:\n'+tried.join('\n'));
}

function setLKState(txt){ $('#lkState').innerHTML = `<span class="icon">ğŸŸ¢</span> ${txt}`; }

async function joinLiveKit(){
  try{
    const LiveKit = await ensureLiveKit();
    const roomName = $('#roomSel').value || 'studio-1';
    const identity = 'guest-' + Math.random().toString(36).slice(2,7);
    const { token, wsUrl } = await fetchTokenSmart(roomName, identity);

    room = new LiveKit.Room();
    await room.connect(wsUrl, token, { autoSubscribe:true, stopLocalTrackOnUnpublish:true });

    setLKState(`Ù…ØªØµÙ„: ${roomName}`);
    $('#btnJoin').disabled = true; $('#btnLeave').disabled = false;

  }catch(e){
    console.error('joinLiveKit error', e);
    alert(e?.message || String(e));
  }
}

async function leaveLiveKit(){
  try{
    if (room){
      await room.disconnect(); room = null;
      setLKState('Ù…ÙØµÙˆÙ„'); $('#btnJoin').disabled=false; $('#btnLeave').disabled=true;
    }
  }catch{}
}

async function toggleCam(){
  try{
    await ensureLiveKit(); if (!room) return alert('Ø§Ù†Ø¶Ù… Ø£ÙˆÙ„Ù‹Ø§');
    camOn = !camOn;
    await room.localParticipant.setCameraEnabled(camOn);
  }catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: '+(e?.message||e)); }
}

async function toggleMic(){
  try{
    await ensureLiveKit(); if (!room) return alert('Ø§Ù†Ø¶Ù… Ø£ÙˆÙ„Ù‹Ø§');
    micOn = !micOn;
    await room.localParticipant.setMicrophoneEnabled(micOn);
  }catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù…Ø§ÙŠÙƒ: '+(e?.message||e)); }
}

$('#btnJoin').onclick = joinLiveKit;
$('#btnLeave').onclick = leaveLiveKit;
$('#btnCam').onclick   = toggleCam;
$('#btnMic').onclick   = toggleMic;
</script>
</body>
</html>
