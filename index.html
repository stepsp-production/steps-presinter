<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة المراقبة</title>

  <!-- لا نضع CSP داخل HTML؛ نستخدم ملف _headers في Cloudflare Pages -->

  <!-- مسارات المكتبات المحلية كما كانت لديك.
       إن لم تكن موجودة فعليًا، سيجري التحميل تلقائيًا من CDN (انظر البلوك في آخر الصفحة). -->
  <script defer src="/vendor/hls.min.js"></script>
  <script defer src="/vendor/livekit-client.umd.min.js"></script>

  <style>
    :root{
      --bg:#0f1115; --panel:#151824; --muted:#7e88a3; --text:#e6ecf1; --ok:#17c964; --warn:#f5a524; --err:#f31260; --brand:#006fee;
      --card:#111522; --border:#24283a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text); font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Noto Kufi Arabic", "Dubai", "Tajawal", sans-serif;
    }
    .app{display:grid; grid-template-columns:280px 1fr; min-height:100vh}
    header{
      grid-column:1 / -1; display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px; background:var(--panel); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:5;
    }
    header .actions{display:flex; gap:8px; align-items:center}
    button{
      background:#1b2134; color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    button.primary{background:var(--brand); border-color:var(--brand); color:#fff}
    button.ghost{background:transparent}
    button:disabled{opacity:.5; cursor:not-allowed}
    .sidebar{
      background:var(--panel); border-inline-start:1px solid var(--border); padding:12px 10px; overflow:auto
    }
    .section-title{font-weight:700; color:#aab6d1; font-size:13px; margin:8px 0 6px}
    .rooms{display:flex; flex-direction:column; gap:6px}
    .room{
      background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden;
    }
    .room-hd{
      display:flex; align-items:center; justify-content:space-between; padding:8px 10px; cursor:pointer; user-select:none;
      background:linear-gradient(180deg, #131729, #101427);
    }
    .room-hd .name{font-weight:700}
    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0e1323; font-size:12px;
    }
    .dot{width:10px; height:10px; border-radius:50%; background:#3b3f55; box-shadow:0 0 0 1px rgba(0,0,0,.2) inset}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.err{background:var(--err)}
    .room-bd{padding:10px; display:grid; grid-template-columns:repeat(2,1fr); gap:8px; background:#0f1324; border-top:1px solid var(--border)}
    .cam-btn{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:7px 9px; border-radius:10px; background:#12172a; border:1px solid var(--border); cursor:pointer;
    }
    .cam-btn span{font-weight:600}
    .main{
      padding:12px; overflow:auto;
      display:grid; grid-template-rows:auto 1fr; gap:12px;
    }
    .grid{
      display:grid; grid-template-columns:repeat(4,1fr); gap:10px;
    }
    .card{
      background:#0e1323; border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column;
    }
    .card h4{margin:0; padding:8px 10px; border-bottom:1px solid var(--border); color:#aab6d1}
    video{
      width:100%; height:240px; background:#000; display:block;
    }
    .toolbar{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; background:#0b0f1d; border:1px solid var(--border); padding:2px 6px; border-radius:6px; color:#b6c3e0}
    @media (max-width:1200px){ .grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:900px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:600px){ .app{grid-template-columns:1fr} .sidebar{order:2} }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <strong>لوحة المراقبة</strong>
    </div>
    <div class="actions">
      <button id="btnPlayAll" class="primary">تشغيل الكل</button>
      <button id="btnPauseAll">إيقاف الكل</button>
      <button id="btnSync" class="ghost">مزامنة</button>
      <span class="kbd">HLS عبر Worker</span>
    </div>
  </header>

  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="section-title">الغرف (10)</div>
      <div class="rooms" id="rooms"></div>
    </aside>

    <main class="main">
      <div class="toolbar">
        <span>الغرفة النشطة: <strong id="activeRoomName">—</strong></span>
        <span id="lkStatus" class="pill"><i class="dot" id="lkDot"></i> LiveKit</span>
        <span id="mainStatus" class="pill"><i class="dot" id="mainDot"></i> main</span>
      </div>

      <section class="grid" id="grid">
        <!-- سيتم ملؤها برمجياً بالبطاقات والفيديوهات -->
      </section>
    </main>
  </div>

  <!-- ====== التهيئة العامة (ضبط المسارات وأسماء الكاميرات) ====== -->
  <script>
    // قاعدة HLS النهائية: الوركر المربوط مع التانل (كما طلبت)
    const HLS_BASE = 'https://hls-proxy.it-f2c.workers.dev';

    // مفاتيح الكاميرات (لا تغيّر ترتيب العرض لديك)
    const CAMERA_KEYS = ['live', 'lastone', 'live2', 'live3', 'live4', 'live5', 'live6', 'live7'];

    // توليد غرف افتراضية room-1 .. room-10 (إن كان لديك أسماء أخرى استبدل هذه القيم)
    const ROOMS = Array.from({length: 10}, (_,i)=> ({ id:`room-${i+1}`, name:`الغرفة ${i+1}` }));

    // API الخاص بإصدار توكن LiveKit
    const LIVEKIT_API = 'https://steps-livekit-api.onrender.com';

    // تحويل مفتاح الكاميرا لمسار m3u8
    const toPath = (key)=> `/hls/${key}/playlist.m3u8`;

    // حالة عامة
    const state = {
      activeRoom: ROOMS[0].id,
      hlsByKey: {},      // key -> Hls instance
      videoByKey: {},    // key -> <video>
      roomObj: null      // LiveKit Room
    };
  </script>

  <!-- ====== مولّد واجهة الغرف واللاعبين (لا يغيّر ستايلك بل يملأ المحتوى فقط) ====== -->
  <script>
    const $rooms = document.getElementById('rooms');
    const $grid  = document.getElementById('grid');
    const $activeRoomName = document.getElementById('activeRoomName');

    function el(tag, attrs={}, children=[]){
      const n = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if (k === 'class') n.className = v;
        else if (k === 'html') n.innerHTML = v;
        else n.setAttribute(k, v);
      }
      for(const c of children) n.appendChild(c);
      return n;
    }

    function buildRooms(){
      $rooms.innerHTML = '';
      ROOMS.forEach((r, idx)=>{
        const dot = el('i', {class:'dot', id:`roomDot-${r.id}`});
        const pill = el('span', {class:'pill'}, [dot, document.createTextNode(' متصل')]);
        const hd = el('div', {class:'room-hd'}, [
          el('span', {class:'name', html:r.name}), pill
        ]);
        const body = el('div', {class:'room-bd'});
        CAMERA_KEYS.forEach(key=>{
          const btn = el('div', {class:'cam-btn', 'data-room':r.id, 'data-key':key}, [
            el('span', {html:key}),
            el('i', {class:'dot', id:`dot-${r.id}-${key}`})
          ]);
          btn.addEventListener('click', ()=> switchRoom(r.id, key));
          body.appendChild(btn);
        });
        const room = el('div', {class:'room'}, [hd, body]);
        hd.addEventListener('click', ()=> setActiveRoom(r.id));
        $rooms.appendChild(room);

        if (idx === 0) setActiveRoom(r.id);
      });
    }

    function buildGrid(){
      $grid.innerHTML = '';
      CAMERA_KEYS.forEach(key=>{
        const card = el('div', {class:'card'});
        card.appendChild(el('h4', {html:key}));
        const v = el('video', {playsinline:'', controls:'', muted:'', 'data-key':key});
        card.appendChild(v);
        $grid.appendChild(card);
        state.videoByKey[key] = v;
      });
    }

    function setActiveRoom(roomId){
      state.activeRoom = roomId;
      $activeRoomName.textContent = ROOMS.find(x=>x.id===roomId)?.name || roomId;
      // إعادة ربط كل الفيديوهات للغرفة النشطة
      CAMERA_KEYS.forEach(key=>{
        attachHlsToKey(key);
      });
    }

    function switchRoom(roomId, key){
      setActiveRoom(roomId);
      // تركيز على بطاقة المفتاح المطلوب
      const card = state.videoByKey[key]?.closest('.card');
      if (card) card.scrollIntoView({behavior:'smooth', block:'center', inline:'nearest'});
    }
  </script>

  <!-- ====== أدوات HLS + Ping (HEAD→GET) وفولباك CDN للمكتبات ====== -->
  <script>
    // محمّل سكربت بسيط
    function loadScript(src, cb){
      const s = document.createElement('script');
      s.src = src; s.defer = true; s.async = true; s.crossOrigin = 'anonymous';
      s.onload = ()=> cb && cb(null); s.onerror = ()=> cb && cb(new Error('load ' + src));
      document.head.appendChild(s);
    }

    // فولباك لـ hls.js في حال الملف المحلي غير متاح
    (function ensureHls(){
      if (!window.Hls) {
        loadScript('https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js', function(){});
      }
    })();

    // Ping عبر GET بدلاً من HEAD + فحص EXTM3U
    async function pingOnce(pathOrUrl){
      try{
        const full = (pathOrUrl.startsWith('http') ? pathOrUrl : (HLS_BASE + pathOrUrl)) + '?ping=' + Date.now();
        const res = await fetch(full, { method:'GET', cache:'no-store' });
        if(!res.ok) return false;
        const text = await res.text();
        return text.includes('#EXTM3U');
      }catch(e){
        return false;
      }
    }

    // إرفاق HLS إلى فيديو بناء على المفتاح
    function attachHlsToKey(key){
      const videoEl = state.videoByKey[key];
      if (!videoEl) return;

      // دمّر أي نسخة قديمة
      try{ state.hlsByKey[key]?.destroy?.(); }catch(_){}
      state.hlsByKey[key] = null;

      const url = HLS_BASE + toPath(key);

      if (window.Hls && window.Hls.isSupported()){
        const hls = new Hls({ enableWorker:true, lowLatencyMode:true });
        state.hlsByKey[key] = hls;
        hls.loadSource(url);
        hls.attachMedia(videoEl);
        hls.on(Hls.Events.MANIFEST_PARSED, async ()=>{
          try{ await videoEl.play(); }catch(_){}
        });
        hls.on(Hls.Events.ERROR, (e,d)=>{
          if (d?.fatal){
            try{ hls.destroy(); }catch(_){}
            state.hlsByKey[key] = null;
          }
        });
      } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
        videoEl.src = url;
        videoEl.addEventListener('loadedmetadata', ()=> videoEl.play().catch(()=>{}), {once:true});
      }
    }

    // مزامنة كل الفيديوهات إلى طرف البث الحي
    function syncAll(){
      CAMERA_KEYS.forEach(key=>{
        const hls = state.hlsByKey[key];
        const v = state.videoByKey[key];
        if (!v) return;
        try{
          if (hls && typeof hls.liveSyncPosition === 'number'){
            v.currentTime = hls.liveSyncPosition;
          } else if (v.buffered && v.buffered.length){
            const end = v.buffered.end(v.buffered.length - 1);
            v.currentTime = Math.max(0, end - 0.5);
          }
          // تأكد التشغيل
          v.play().catch(()=>{});
        }catch(_){}
      });
    }

    // فحص الحالة (نقطة خضراء) لكل كاميرا
    async function refreshDots(){
      const roomId = state.activeRoom;
      // dot للغرفة (يُظهر حالة main كمؤشر عام)
      const okMain = await pingOnce(toPath('live'));
      setDot(`roomDot-${roomId}`, okMain ? 'ok' : 'err');
      setDot('mainDot', okMain ? 'ok' : 'err');

      // باقي الكاميرات
      for (const key of CAMERA_KEYS){
        const ok = await pingOnce(toPath(key));
        setDot(`dot-${roomId}-${key}`, ok ? 'ok' : 'err');
      }
    }

    function setDot(id, st){
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('ok','warn','err');
      if (st) el.classList.add(st);
    }
  </script>

  <!-- ====== LiveKit: ضمان التحميل (محلي ثم CDN) + الانضمام للغرفة ====== -->
  <script>
    function ensureLiveKit(cb){
      if (window.livekit || window.LivekitClient) return cb && cb(null);
      // جرّب المحلي
      loadScript('/vendor/livekit-client.umd.min.js', function(){
        if (window.livekit || window.LivekitClient) return cb && cb(null);
        // فولباك CDN
        loadScript('https://cdn.jsdelivr.net/npm/livekit-client@2/dist/livekit-client.umd.min.js', function(err){
          cb && cb(null);
        });
      });
    }

    async function joinRoomWithToken(roomName, identity){
      return new Promise((resolve,reject)=>{
        ensureLiveKit(async function(){
          try{
            const who = identity || ('browser-' + Math.random().toString(36).slice(2,8));
            const r = await fetch(`${LIVEKIT_API}/token?room=${encodeURIComponent(roomName)}&identity=${encodeURIComponent(who)}`, {cache:'no-store'});
            if (!r.ok) throw new Error('token API '+r.status);
            const { url, token } = await r.json();
            const LK = window.livekit || window.LivekitClient;
            const room = new LK.Room();
            await room.connect(url, token);
            resolve(room);
          }catch(err){ reject(err); }
        });
      });
    }

    async function connectActiveRoom(){
      try{
        document.getElementById('lkDot') && setDot('lkDot', 'warn');
        const room = await joinRoomWithToken(state.activeRoom);
        state.roomObj = room;
        setDot('lkDot', 'ok');
      }catch(_){
        setDot('lkDot', 'err');
      }
    }
  </script>

  <!-- ====== ربط الأزرار + الإقلاع ====== -->
  <script>
    document.getElementById('btnPlayAll').addEventListener('click', ()=>{
      CAMERA_KEYS.forEach(k=> state.videoByKey[k]?.play?.().catch(()=>{}));
    });
    document.getElementById('btnPauseAll').addEventListener('click', ()=>{
      CAMERA_KEYS.forEach(k=> state.videoByKey[k]?.pause?.());
    });
    document.getElementById('btnSync').addEventListener('click', syncAll);

    // بناء الواجهة وربط البث
    buildRooms();
    buildGrid();
    setActiveRoom(ROOMS[0].id);

    // أول فحص للحالة ثم كل 8 ثوانٍ
    refreshDots();
    setInterval(refreshDots, 8000);

    // حاول الاتصال بالغرفة النشطة (اختياري)
    connectActiveRoom();
  </script>
</body>
</html>
