<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steps Co VIP Player</title>

  <!-- Ù„ÙˆØ¯Ø±Ø§Øª Ù…Ø­Ù„ÙŠØ© ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„-CSP (Ù…Ù† Ù†Ø·Ø§Ù‚Ùƒ ÙÙ‚Ø·) -->
  <script>
    function loadScript(src){
      return new Promise((res, rej)=>{
        const s=document.createElement('script');
        s.src=src; s.async=true;
        s.onload=()=>res(); s.onerror=()=>rej(new Error('script load failed: '+src));
        document.head.appendChild(s);
      });
    }
    async function ensureHls(){
      if(window.Hls) return window.Hls;
      await loadScript('/vendor/hls.min.js');
      if(!window.Hls) throw new Error('HLS library did not load');
      return window.Hls;
    }
    async function ensureLiveKit(){
      if(window.LiveKit) return window.LiveKit;
      await loadScript('/vendor/livekit-client.umd.min.js');
      if(!window.LiveKit) throw new Error('LiveKit library did not load');
      return window.LiveKit;
    }
  </script>

  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© -->
  <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%2300c19a'/%3E%3C/svg%3E" />

  <style>
    :root{
      --btn-bg:#00c19a; --btn-bg-h:#00ad8a; --btn-bg-a:#009e7e; --btn-txt:#fff;
      --panel-bg:#0b0b0fe6; --panel-bd:#ffffff26;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

    #playerContainer{position:relative;width:100vw;height:100vh}
    .videoFrame{position:absolute;top:0;right:0;width:100%;height:100%;background:#000;overflow:hidden}

    /* Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…ØµØºÙ‘Ø±Ø© */
    #mainPreview{position:absolute;top:16px;right:20px;width:22%;height:24%;z-index:6;border:1px solid #fff2;border-radius:18px;cursor:pointer;transition:transform .18s,box-shadow .18s,width .18s,height .18s,top .18s,right .18s,left .18s}
    #mainPreview:hover{box-shadow:0 10px 30px #0008}
    #mainPreview video{display:block;width:100%;height:100%;object-fit:contain}

    /* ØªÙ‚Ø³ÙŠÙ… (MAIN ÙŠÙ…ÙŠÙ† Ø¯Ø§Ø¦Ù…Ù‹Ø§) */
    .split #mainPreview{top:0;right:0;width:50%;height:100%;border:0;border-radius:0;cursor:default}
    .split #activeCam{top:0;left:0;right:auto;width:50%;height:100%}

    /* Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„ØªÙ‚Ø³ÙŠÙ… */
    .split.mode1 #mainPreview video, .split.mode1 #activeCam  video{object-fit:contain}
    .split.mode2 #mainPreview video, .split.mode2 #activeCam  video{object-fit:contain; transform:scale(1.08); transform-origin:center}
    .split.mode3 #mainPreview video, .split.mode3 #activeCam  video{object-fit:cover}

    /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
    .main-full #mainPreview{top:0;right:0;width:100%;height:100%;z-index:7;border:0;border-radius:0;cursor:zoom-out}
    .main-full #activeCam{display:none}
    .main-full.cover-one #mainPreview video{object-fit:cover}

    .hint{position:absolute;top:20px;right:20px;z-index:8;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
    .split .hint,.main-full .hint{display:none}

    /* Ø£Ø´Ø±Ø·Ø© */
    #utilityControls,#globalControls{position:absolute;z-index:12;display:flex;gap:8px;flex-wrap:wrap;transition:opacity .18s}
    #utilityControls{top:10px;right:10px}
    #globalControls{bottom:70px;left:50%;transform:translateX(-50%);background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd);align-items:center;min-width:340px}
    #globalControls.hidden{display:none}

    /* LiveKit panel */
    #lkPanel{position:absolute; bottom:14px; right:14px; z-index:20; background:var(--panel-bg); border:1px solid var(--panel-bd); border-radius:14px; padding:10px; backdrop-filter: blur(8px); display:flex; flex-direction:column; gap:8px; width: min(92vw, 520px); transition:opacity .18s}
    #lkPanel h3{margin:0;color:#fff;font-size:13px}
    #lkGrid{display:grid; grid-template-columns: repeat( auto-fit, minmax(120px,1fr) ); gap:8px; max-height:34vh; overflow:auto;}
    .tile{position:relative; background:#0b0b0f; border:1px solid #ffffff22; border-radius:10px; overflow:hidden; min-height:90px}
    .tile video{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute; left:6px; top:6px; background:#000a; color:#fff; font-size:10px; padding:2px 6px; border-radius:999px; border:1px solid #fff2}
    #lkControls{display:flex; gap:6px; flex-wrap:wrap}
    #lkControls select, #lkControls input, #lkControls .text{font-size:11px}
    #lkControls select, #lkControls input{background:#10151f; color:#fff; border:1px solid #ffffff22; border-radius:10px; padding:8px}
    #lkHint{color:#eaeaf0b3; font-size:11px}

    button{-webkit-tap-highlight-color:transparent;appearance:none;border:0;outline:0;cursor:pointer;background:var(--btn-bg);color:var(--btn-txt);padding:11px 12px;font-size:12px;font-weight:800;border-radius:12px;letter-spacing:.2px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 18px #000a,0 0 0 0 rgba(0,193,154,.28);transition:transform .12s,box-shadow .12s,background .12s}
    button:hover{background:var(--btn-bg-h);box-shadow:0 12px 26px #000c,0 0 0 6px rgba(0,193,154,.28)}
    button:active{background:var(--btn-bg-a);transform:translateY(1px)}

    #scrub{-webkit-appearance:none;appearance:none;width:320px;height:6px;border-radius:999px;background:#ffffff30;outline:none;margin:0 8px}
    #scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #0006;cursor:pointer}
    #timeLabel{color:#fff;font-size:12px;min-width:108px;text-align:center}

    /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    #streamPanel{position:absolute; top:0; left:0; height:100%; width:230px; z-index:12; background:none; border-right:none; padding:12px 10px; color:#fff; transition:opacity .18s}
    #streamPanel .panel-title{font-weight:900;letter-spacing:.8px;margin:6px 6px 12px;font-size:13px;text-shadow:0 1px 2px #000}
    #streamList{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;max-height:calc(100% - 48px);overflow:auto}
    .stream-item{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer; background:rgba(0,0,0,.30); border:1px solid rgba(255,255,255,.20); backdrop-filter: blur(2px); transition:background .12s, border-color .12s, transform .06s;}
    .stream-item:hover{background:rgba(0,0,0,.38);border-color:#ffffff35}
    .stream-item.active{background:rgba(0,0,0,.55);border-color:#ffffff60}
    .stream-name{font-weight:800; font-size:12px; letter-spacing:.4px; text-transform:uppercase}
    .dot{width:8px;height:8px;border-radius:50%;background:#808080;border:1px solid #0006;box-shadow:0 0 0 1px #0008 inset}
    .dot.ok{background:#20d05a}

    /* Ø¥Ø®ÙØ§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ù…ÙˆÙ„ */
    .ui-hidden #streamPanel, .ui-hidden #utilityControls, .ui-hidden #globalControls, .ui-hidden #lkPanel, .ui-hidden .hint { opacity:0; pointer-events:none }
    .ui-visible #streamPanel, .ui-visible #utilityControls, .ui-visible #globalControls, .ui-visible #lkPanel, .ui-visible .hint { opacity:1; pointer-events:auto }

    .layer{position:absolute; inset:0;}
    .fade-in{animation:fadeIn .18s ease forwards}
    .fade-out{animation:fadeOut .18s ease forwards}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeOut{from{opacity:1}to{opacity:0}}

    @media (orientation: portrait){
      #mainPreview{top:12px;right:14px;width:58vw;height:36vh;border-radius:18px}
      #globalControls{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 8px);left:50%;transform:translateX(-50%);width:min(94vw,560px);padding:8px 10px;z-index:9999}
      #scrub{width:clamp(140px,56vw,380px)}
      #streamPanel{width:190px}
    }
  </style>
</head>
<body>
  <div id="playerContainer" class="ui-visible" aria-label="Ù…Ø´ØºÙ‘Ù„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª">
    <aside id="streamPanel" aria-label="Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨Ø«">
      <div class="panel-title">SOURCES</div>
      <ul id="streamList"></ul>
    </aside>

    <div id="activeCam" class="videoFrame" aria-label="Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù†Ø´Ø·Ø©"></div>
    <div id="mainPreview" class="videoFrame" title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±" aria-label="Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù…ØµØºÙ‘Ø±Ø©"></div>
    <div class="hint">Ø­Ø±Ù‘Ùƒ Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© â€¢ Ø§Ù†Ù‚Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„ØªÙƒØ¨ÙŠØ± â€¢ S ØªÙ‚Ø³ÙŠÙ… â€¢ F Ù…Ù„Ø¡</div>

    <div id="gatePlay" role="dialog" aria-modal="true" aria-label="Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„">
      <div class="gate-card" style="background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)">
        <div class="icon" style="width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--panel-bd);color:#fff;background:#111a;font-size:18px">â–¶</div>
        <div>
          <div style="color:#fff;font-weight:800;margin-bottom:6px">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
          <div id="gateMsg" style="font-size:12px;color:#eaeaf0b3">Ø³ÙŠØ¨Ù‚Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ø¸Ø§Ù‡Ø±Ù‹Ø§ Ø­ØªÙ‰ ÙŠÙ†Ø¬Ø­ Ø§Ù„ØªØ´ØºÙŠÙ„.</div>
        </div>
        <button id="startBtn" aria-label="Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢Ù†" style="min-width:160px">ØªØ´ØºÙŠÙ„/Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
      </div>
    </div>

    <div id="utilityControls" role="toolbar" aria-label="Ø£Ø¯ÙˆØ§Øª">
      <button id="btnSplit" aria-label="ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ‚Ø³ÙŠÙ…" title="ØªÙ‚Ø³ÙŠÙ…">ØªÙ‚Ø³ÙŠÙ…</button>
      <button id="btnFill"  aria-label="ØªØ¨Ø¯ÙŠÙ„ Ù…Ù„Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰" title="Ù…Ù„Ø¡">Ù…Ù„Ø¡</button>
      <button id="btnSound" aria-label="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª" title="ØµÙˆØª">ğŸ”Š/ğŸ”‡</button>
    </div>

    <div id="globalControls" class="hidden" role="group" aria-label="ØªØ­ÙƒÙ… Ù…ÙˆØ­Ù‘Ø¯">
      <button id="gBack" title="âª -5s">âª 5s</button>
      <button id="gPlay" title="â¯">â¯</button>
      <button id="gFwd"  title="+5s â©">5s â©</button>
      <input id="scrub" type="range" min="0" max="0" value="0" step="0.01" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…">
      <div id="timeLabel">00:00 / 00:00</div>
    </div>
  </div>

  <div id="lkPanel" aria-label="LiveKit Panel">
    <h3>Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (LiveKit)</h3>
    <div id="lkControls">
      <label class="text" for="lkRoom">Ø§Ù„ØºØ±ÙØ©:</label>
      <select id="lkRoom">
        <option>studio-1</option><option>studio-2</option><option>studio-3</option><option>studio-4</option><option>studio-5</option>
        <option>studio-6</option><option>studio-7</option><option>studio-8</option><option>studio-9</option><option>studio-10</option>
      </select>
      <input id="lkName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
      <button id="lkJoin">Ø§Ù†Ø¶Ù… Ù„Ù„ØºØ±ÙØ©</button>
      <button id="lkLeave" disabled>Ù…ØºØ§Ø¯Ø±Ø©</button>
      <button id="lkToggleCam" disabled>Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
      <button id="lkToggleMic" disabled>Ø§Ù„Ù…Ø§ÙŠÙƒ</button>
      <span id="lkHint" class="text">Ø§Ø¶ØºØ· â€œØªØ´ØºÙŠÙ„/Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©â€ Ø£ÙˆÙ„Ù‹Ø§ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„.</span>
    </div>
    <div id="lkGrid" aria-live="polite"></div>
  </div>

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ù‚ÙˆØ§Ø¹Ø¯ HLS Ùˆ LiveKit -->
  <script>
    (function pickHlsBase(){
      const u=new URL(location.href);
      const q=u.searchParams.get('hls');
      const base = (q || window.HLS_BASE || '/hls').replace(/\/+$/,'');
      window.HLS_BASE = base;
    })();
    window.LIVEKIT_WS  = window.LIVEKIT_WS  || 'wss://presinter-stream-gjthpz2z.livekit.cloud';
    window.TOKEN_BASE  = window.TOKEN_BASE  || 'https://steps-livekit-api.onrender.com';
  </script>

  <!-- Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨Ø« -->
  <script>
    (function(){
      const BASE = String(window.HLS_BASE||'').replace(/\/+$/,'');
      function build(p){
        let path = '/' + String(p||'').replace(/^\/+/, '');
        if (/\/hls$/i.test(BASE)) path = path.replace(/^\/hls(\/|$)/i, '/');
        return BASE + path;
      }
      window.sources = {
        main: build('/hls/live/playlist.m3u8'),
        cam1: build('/hls/lastone/playlist.m3u8'),
        cam2: build('/hls/live2/playlist.m3u8'),
        cam3: build('/hls/live3/playlist.m3u8'),
        cam4: build('/hls/live4/playlist.m3u8'),
        cam5: build('/hls/live5/playlist.m3u8'),
        cam6: build('/hls/live6/playlist.m3u8'),
        cam7: build('/hls/live7/playlist.m3u8')
      };
      window.channelMap = [
        {id:'main',label:'MAIN',src:sources.main},
        {id:'cam1',label:'Cam1',src:sources.cam1},
        {id:'cam2',label:'Cam2',src:sources.cam2},
        {id:'cam3',label:'Cam3',src:sources.cam3},
        {id:'cam4',label:'Cam4',src:sources.cam4},
        {id:'cam5',label:'Cam5',src:sources.cam5},
        {id:'cam6',label:'Drone',src:sources.cam6},
        {id:'cam7',label:'Sineflex',src:sources.cam7},
      ];
    })();
  </script>

  <!-- ØªØ´ØºÙŠÙ„ HLS + Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© -->
  <script>
    const rootEl         = document.getElementById('playerContainer');
    const mainContainer  = document.getElementById('mainPreview');
    const camContainer   = document.getElementById('activeCam');
    const gatePlay       = document.getElementById('gatePlay');
    const gateMsgEl      = document.getElementById('gateMsg');
    const startBtn       = document.getElementById('startBtn');
    const btnSplit       = document.getElementById('btnSplit');
    const btnFill        = document.getElementById('btnFill');
    const btnSound       = document.getElementById('btnSound');
    const globalControls = document.getElementById('globalControls');
    const gPlay          = document.getElementById('gPlay');
    const gBack          = document.getElementById('gBack');
    const gFwd           = document.getElementById('gFwd');
    const scrub          = document.getElementById('scrub');
    const timeLabel      = document.getElementById('timeLabel');
    const streamList     = document.getElementById('streamList');

    const SAFETY_EDGE = 0.80;
    let started=false, splitMode=0, isMainFull=false;
    let mainPlayer=null, activePlayer=null, currentCam='cam2';
    let ticker=null, isScrubbing=false;
    const playersCache=new Map();

    const fmt=(t)=>{t=Math.max(0,Math.floor(t||0));const m=String(Math.floor(t/60)).padStart(2,'0');const s=String(t%60).padStart(2,'0');return `${m}:${s}`;};
    function getSeekableRange(v){try{const r=v.seekable;if(!r||!r.length)return null;return{start:r.start(r.length-1),end:r.end(r.length-1)};}catch(e){return null;}}
    function capLiveEdge(v,t){const r=getSeekableRange(v); if(r) return Math.min(t, r.end - SAFETY_EDGE); return t;}
    function containsTime(v,t){try{const b=v.buffered;for(let i=0;i<b.length;i++){if(t>=b.start(i)&&t<=b.end(i)) return {start:b.start(i),end:b.end(i)};} }catch(e){} return null;}
    function nearestBufferedTime(v,t){try{const b=v.buffered;let best=null,dm=1e9;for(let i=0;i<b.length;i++){const s=b.start(i),e=b.end(i);const cand=(t<s)?s:(t>e?e:t);const d=Math.abs(cand-t);if(d<dm){dm=d;best=cand;}} return best;}catch(e){return null;}}
    function snapIntoBuffer(v,t){t=capLiveEdge(v,t); const r=containsTime(v,t); if(r) return t; const near=nearestBufferedTime(v,t); return typeof near==='number'?near:t;}

    async function attachHls(video,url, onReady){
      const Hls = await ensureHls();
      const hls=new Hls({
        lowLatencyMode:false,
        liveSyncDurationCount:3, liveMaxLatencyDurationCount:6,
        maxBufferLength:18, backBufferLength:14, maxBufferSize:40*1000*1000,
        capLevelToPlayerSize:true, enableWorker:true,
        maxBufferHole:0.15, maxSeekHole:0.25, nudgeOffset:0.12, nudgeMaxRetry:10,
        abrMaxWithRealBitrate:true,
      });
      video.__hls=hls;
      hls.on(Hls.Events.MEDIA_ATTACHED,()=>hls.loadSource(url));
      hls.on(Hls.Events.MANIFEST_PARSED,()=>{ onReady && onReady(); });
      hls.on(Hls.Events.ERROR,(_,err)=>{
        console.warn('[HLS] ERROR',err);
        gatePlay.classList.remove('hidden');
        gateMsgEl.textContent='ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ØªØ­Ù‚Ù‚ Ù…Ù† HLS_BASE ÙˆORIGIN_BASE ÙˆCORS (502/404 Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±).';
      });
      hls.attachMedia(video);
      return hls;
    }

    function createVideoElement(url, onReady){
      const wrap=document.createElement('div'); wrap.className='layer'; wrap.style.cssText='position:absolute;inset:0;opacity:0';
      const v=document.createElement('video');
      v.playsInline=true; v.muted=true; v.controls=false; v.preload='auto'; v.crossOrigin='anonymous';
      v.style.cssText='width:100%;height:100%;object-fit:contain';
      wrap.appendChild(v);

      if(/\.m3u8(\?|$)/i.test(url)){
        if(v.canPlayType('application/vnd.apple.mpegURL')){ v.src=url; v.addEventListener('loadedmetadata',()=>onReady&&onReady()); }
        else { attachHls(v,url,onReady); }
      }else{
        v.src=url; v.addEventListener('loadedmetadata',()=>onReady&&onReady());
      }
      return {wrap, video:v};
    }

    function mountTo(container, node){container.appendChild(node);}

    function initMain(){
      const {wrap,video}=createVideoElement(window.sources.main, ()=>{
        // Ù„Ø§ Ù†Ø®ÙÙŠ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ù‡Ù†Ø§Ø› ÙÙ‚Ø· Ù†ØºÙŠÙ‘Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ "Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„"
        gateMsgEl.textContent='Ø§Ù„Ù…ØµØ¯Ø± Ø¬Ø§Ù‡Ø² â€” Ø§Ø¶ØºØ· ØªØ´ØºÙŠÙ„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©';
      });
      mountTo(mainContainer,wrap); wrap.style.opacity='1';
      mainPlayer=video;
    }

    function getOrCreateCam(id){
      let ent=playersCache.get(id);
      if(ent) return ent;
      const {wrap,video}=createVideoElement(window.sources[id]);
      mountTo(camContainer,wrap);
      const rec={wrap,video,ready:false};
      video.addEventListener('canplay',()=>{rec.ready=true;},{once:true});
      playersCache.set(id,rec);
      return rec;
    }

    function buildStreamList(){
      streamList.innerHTML='';
      (window.channelMap||[]).forEach(ch=>{
        const li=document.createElement('li'); li.className='stream-item'; li.dataset.cam=ch.id;
        const dot=document.createElement('span'); dot.className='dot'; dot.title='status';
        const name=document.createElement('div'); name.className='stream-name'; name.textContent=ch.label;
        li.appendChild(dot); li.appendChild(name);
        li.addEventListener('click',()=>setActiveCamSmooth(ch.id));
        streamList.appendChild(li);
      });
      document.addEventListener('keydown',(e)=>{
        if(e.target && ['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
        const items=[...document.querySelectorAll('.stream-item')];
        const n=Number(e.key); if(n>=1 && n<=items.length) items[n-1].click();
      });
      pingStreams(); setInterval(pingStreams, 8000);
    }
    function markActiveList(){
      document.querySelectorAll('.stream-item').forEach(el=>{
        el.classList.toggle('active',el.dataset.cam===currentCam);
      });
    }
    async function pingStreams(){
      const items=[...document.querySelectorAll('.stream-item')];
      await Promise.all(items.map(async li=>{
        const id=li.dataset.cam; const src=window.sources[id];
        const dot=li.querySelector('.dot');
        if(!src){ dot.classList.remove('ok'); dot.title='NO URL'; return; }
        try{
          const u = src + (src.includes('?')?'&':'?') + 'ping=' + Date.now();
          const r=await fetch(u, {method:'GET', cache:'no-store', mode:'cors'});
          const ct=(r.headers.get('content-type')||'').toLowerCase();
          const ok = r.ok && (ct.includes('application') && ct.includes('mpegurl'));
          dot.classList.toggle('ok', ok);
          dot.title = ok ? 'OK' : `HTTP ${r.status||'ERR'}`;
        }catch(e){ dot.classList.remove('ok'); dot.title='ERR'; }
      }));
    }

    function initOnce(){
      initMain();
      const first=getOrCreateCam(currentCam);
      first.wrap.style.opacity='1';
      activePlayer=first.video;
      buildStreamList();
      markActiveList();
    }
    initOnce();

    async function setActiveCamSmooth(id){
      if(!window.sources[id] || id===currentCam) return;
      currentCam=id; markActiveList();
      const target=getOrCreateCam(id);
      const v=target.video, w=target.wrap;
      if(!target.ready) await new Promise(r => v.addEventListener('canplay', r, {once:true}));
      let T = (mainPlayer && isFinite(mainPlayer.currentTime)) ? mainPlayer.currentTime : 0;
      v.currentTime = snapIntoBuffer(v, T);
      try{ await v.play(); }catch(_){}
      w.className='layer fade-in'; w.style.opacity='1';
      const old = activePlayer, oldWrap = old ? old.parentElement : null;
      setTimeout(()=>{ if(oldWrap){ oldWrap.className='layer fade-out'; oldWrap.style.opacity='0'; } activePlayer=v; }, 180);
    }

    // Ø¥Ø®ÙØ§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù…ÙˆÙ„
    let uiTimer=null;
    function showUI(){
      rootEl.classList.remove('ui-hidden'); rootEl.classList.add('ui-visible');
      clearTimeout(uiTimer);
      uiTimer=setTimeout(()=>{
        rootEl.classList.add('ui-hidden'); rootEl.classList.remove('ui-visible');
      }, 2500);
    }
    ['mousemove','touchstart','keydown'].forEach(ev=>document.addEventListener(ev,showUI,{passive:true}));
    [document.getElementById('streamPanel'), document.getElementById('utilityControls'), document.getElementById('globalControls'), document.getElementById('lkPanel')].forEach(el=>{
      el.addEventListener('mouseenter',()=>{clearTimeout(uiTimer); rootEl.classList.remove('ui-hidden'); rootEl.classList.add('ui-visible');});
      el.addEventListener('mouseleave',showUI);
    });
    setTimeout(showUI,1000);

    // ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    document.getElementById('mainPreview').addEventListener('click',()=>{
      if(splitMode!==0) return;
      isMainFull=!isMainFull;
      rootEl.classList.toggle('main-full',isMainFull);
      rootEl.classList.toggle('cover-one',isMainFull);
    });

    function once(el, ev){return new Promise(r=>el.addEventListener(ev, r, {once:true}));}
    async function tryPlay(v){ try{ const p=v.play(); if(p) await p; return true; }catch{ return false; } }

    function startTimeTicker(){
      if(ticker) return;
      ticker=setInterval(()=>{
        if(isScrubbing || !mainPlayer) return;
        let d=0, ct=mainPlayer.currentTime||0;
        const r=mainPlayer.seekable; if(r&&r.length) d=r.end(r.length-1);
        if(d&&isFinite(d)) scrub.max=d;
        scrub.value=ct||0; timeLabel.textContent=`${fmt(ct)} / ${fmt(d||0)}`;
      },250);
    }

    async function startPlayback(){
      gateMsgEl.textContent='Ø¬Ø§Ø±Ù Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„â€¦';
      // Ù„Ø§ Ù†Ø®ÙÙŠ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ ØªØ´ØºÙŠÙ„ ÙØ¹Ù„ÙŠ
      const ok1 = await tryPlay(mainPlayer);
      const ok2 = await tryPlay(activePlayer||mainPlayer);
      if(!(ok1||ok2)){
        gateMsgEl.textContent='Ù„Ù… ÙŠÙ†Ø¬Ø­ Ø§Ù„ØªØ´ØºÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØµÙˆØª/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± (502 ÙŠØ¹Ù†ÙŠ Ø£Ù† ORIGIN_BASE Ù„Ø§ ÙŠØ¹Ù…Ù„).';
        return;
      }
      // Ù†Ø¬Ø§Ø­
      started=true;
      gatePlay.classList.add('hidden');
      globalControls.classList.remove('hidden');
      gateMsgEl.textContent='';
      // Ù‚Ø±Ø¨Ù†Ø§ Ù„Ù„Ø­Ø§ÙØ©
      setTimeout(()=>{
        const r=mainPlayer.seekable; if(r&&r.length){ mainPlayer.currentTime=Math.max(r.start(0), r.end(r.length-1)-SAFETY_EDGE); }
      },300);
      startTimeTicker();
    }

    const gSeek=(ofs)=>{
      if(!started || !mainPlayer) return;
      const t=capLiveEdge(mainPlayer,(mainPlayer.currentTime||0)+ofs);
      mainPlayer.currentTime=t;
      if(activePlayer) activePlayer.currentTime=snapIntoBuffer(activePlayer,t);
    };
    gBack.addEventListener('click',()=>gSeek(-5));
    gFwd .addEventListener('click',()=>gSeek( 5));
    gPlay.addEventListener('click',async()=>{
      if(!started) return;
      if(mainPlayer.paused){try{await mainPlayer.play();}catch(e){}} else mainPlayer.pause();
    });
    scrub.addEventListener('input',()=>{ if(started) isScrubbing=true; });
    scrub.addEventListener('change',()=>{
      if(!started) return;
      const nt=capLiveEdge(mainPlayer, parseFloat(scrub.value)||0);
      mainPlayer.currentTime=nt;
      if(activePlayer) activePlayer.currentTime=snapIntoBuffer(activePlayer,nt);
      isScrubbing=false;
    });

    document.getElementById('btnSplit').addEventListener('click',()=>{
      splitMode=(splitMode+1)%4;
      rootEl.classList.toggle('split', splitMode!==0);
      rootEl.classList.remove('mode1','mode2','mode3');
      if(splitMode===1) rootEl.classList.add('mode1');
      if(splitMode===2) rootEl.classList.add('mode2');
      if(splitMode===3) rootEl.classList.add('mode3');
    });
    document.getElementById('btnFill').addEventListener('click',()=>{
      if(splitMode===0){
        isMainFull=!isMainFull;
        rootEl.classList.toggle('main-full',isMainFull);
        rootEl.classList.toggle('cover-one',isMainFull);
      }else{
        splitMode = (splitMode===2)?3:2;
        rootEl.classList.remove('mode1','mode2','mode3');
        rootEl.classList.add(splitMode===2?'mode2':'mode3');
        rootEl.classList.add('split');
      }
    });
    document.getElementById('btnSound').addEventListener('click',()=>{ if(!started || !mainPlayer) return; mainPlayer.muted=!mainPlayer.muted; if(!mainPlayer.muted) mainPlayer.play().catch(()=>{}); });

    document.getElementById('startBtn').addEventListener('click',startPlayback);
    document.addEventListener('keydown',(e)=>{
      if(e.key===' '||e.key==='Enter'){ e.preventDefault(); startPlayback(); }
      if(e.key==='S'||e.key==='s'){ document.getElementById('btnSplit').click(); }
      if(e.key==='F'||e.key==='f'){ document.getElementById('btnFill') .click(); }
      if(e.key==='M'||e.key==='m'){ document.getElementById('btnSound').click(); }
      if(e.key==='ArrowLeft'){ gBack.click(); }
      if(e.key==='ArrowRight'){ gFwd .click(); }
    });
  </script>

  <!-- LiveKit -->
  <script>
    const lkJoinBtn   = document.getElementById('lkJoin');
    const lkLeaveBtn  = document.getElementById('lkLeave');
    const lkToggleCam = document.getElementById('lkToggleCam');
    const lkToggleMic = document.getElementById('lkToggleMic');
    const lkHint      = document.getElementById('lkHint');
    const lkGrid      = document.getElementById('lkGrid');
    const lkRoomSel   = document.getElementById('lkRoom');
    const lkNameInp   = document.getElementById('lkName');
    let lkRoom=null;

    function setLkStatus(msg){ lkHint.textContent=msg; }
    function randId(){ return Math.random().toString(36).slice(2,8); }

    async function fetchTokenSmart(room, identity){
      const base = (window.TOKEN_BASE||'').replace(/\/+$/,'');
      const tries = [
        `${base}/api/token?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`,
        `${base}/token?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`,
        `${base}/api/rtoken?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`,
        `${base}/api/get-token?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`
      ];
      let lastErr='';
      for(const url of tries){
        try{
          const r=await fetch(url, {cache:'no-store'});
          if(r.ok){
            const text=await r.text();
            try{
              const js=JSON.parse(text);
              if(js?.token) return js.token;
              if(js?.ok && js?.accessToken) return js.accessToken;
            }catch(_){
              if(text && text.length>10) return text;
            }
            lastErr = `HTTP ${r.status}`;
          }else{
            lastErr = `HTTP ${r.status}`;
          }
        }catch(e){ lastErr = String(e); }
      }
      throw new Error(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†. ØªÙ…Ù‘Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù„Ù‰:\n${tries.join('\n')}\nØ§Ù„Ø³Ø¨Ø¨: ${lastErr}`);
    }

    function renderParticipantTile(pid, track){
      let tile = document.getElementById('tile-'+pid);
      if(!tile){
        tile = document.createElement('div'); tile.className='tile'; tile.id='tile-'+pid;
        const b=document.createElement('div'); b.className='badge'; b.textContent=pid;
        tile.appendChild(b);
        lkGrid.appendChild(tile);
      }
      if(track.kind==='video'){
        const el=document.createElement('video');
        el.autoplay=true; el.playsInline=true; el.muted = (lkRoom && lkRoom.localParticipant && lkRoom.localParticipant.identity===pid);
        tile.appendChild(el);
        track.attach(el);
      }
      if(track.kind==='audio'){
        const el=document.createElement('audio'); el.autoplay=true;
        tile.appendChild(el);
        track.attach(el);
      }
    }

    async function joinLiveKit(){
      try{
        const LK = await ensureLiveKit();
        const roomName = lkRoomSel.value || 'studio-1';
        const display   = (lkNameInp.value||'guest') + '-' + randId();
        setLkStatus('Ø¬Ø§Ø±Ù Ø·Ù„Ø¨ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øªâ€¦');
        try{ await navigator.mediaDevices.getUserMedia({audio:true, video:true}); }catch(_){}
        setLkStatus('Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†â€¦');
        const token = await fetchTokenSmart(roomName, display);
        setLkStatus('Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦');
        lkRoom = new LK.Room();
        await lkRoom.connect(window.LIVEKIT_WS, token);
        setLkStatus('Ù…ØªØµÙ„ âœ…');
        lkJoinBtn.disabled=true; lkLeaveBtn.disabled=false; lkToggleCam.disabled=false; lkToggleMic.disabled=false;
        await lkRoom.localParticipant.setCameraEnabled(true);
        await lkRoom.localParticipant.setMicrophoneEnabled(true);
        lkRoom.on(LK.RoomEvent.TrackSubscribed, (track, pub, participant)=>{ renderParticipantTile(participant.identity, track); });
        lkRoom.on(LK.RoomEvent.TrackUnsubscribed, (track, pub, participant)=>{ const tile=document.getElementById('tile-'+participant.identity); if(tile) tile.remove(); });
        lkRoom.on(LK.RoomEvent.Disconnected, ()=>{ setLkStatus('ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„'); lkGrid.innerHTML=''; lkJoinBtn.disabled=false; lkLeaveBtn.disabled=true; lkToggleCam.disabled=true; lkToggleMic.disabled=true; });
      }catch(e){
        console.error('joinLiveKit error', e);
        alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: ' + (e?.message||e));
        setLkStatus('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…');
      }
    }

    async function leaveLiveKit(){
      try{ if(lkRoom){ await lkRoom.disconnect(); } }catch(_){}
      lkRoom=null; lkGrid.innerHTML='';
      lkJoinBtn.disabled=false; lkLeaveBtn.disabled=true; lkToggleCam.disabled=true; lkToggleMic.disabled=true;
      setLkStatus('ØªÙ…Øª Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©');
    }

    document.getElementById('lkJoin').addEventListener('click', joinLiveKit);
    document.getElementById('lkLeave').addEventListener('click', leaveLiveKit);
    document.getElementById('lkToggleCam').addEventListener('click', async ()=>{
      if(!lkRoom) return;
      const en = !lkRoom.localParticipant.isCameraEnabled;
      await lkRoom.localParticipant.setCameraEnabled(en);
    });
    document.getElementById('lkToggleMic').addEventListener('click', async ()=>{
      if(!lkRoom) return;
      const en = !lkRoom.localParticipant.isMicrophoneEnabled;
      await lkRoom.localParticipant.setMicrophoneEnabled(en);
    });
  </script>
</body>
</html>
