<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steps Co VIP Player</title>

  <!-- أيقونة -->
  <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%2300c19a'/%3E%3C/svg%3E" />

  <style>
    :root{
      --btn-bg:#00c19a; --btn-bg-h:#00ad8a; --btn-bg-a:#009e7e; --btn-txt:#fff;
      --panel-bg:#0b0b0fe6; --panel-bd:#ffffff26;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

    #playerContainer{position:relative;width:100vw;height:100vh}
    .videoFrame{position:absolute;top:0;right:0;width:100%;height:100%;background:#000;overflow:hidden}
    .videoFrame video{width:100%;height:100%;object-fit:contain;background:#000}

    /* المعاينة المصغّرة */
    #mainPreview{position:absolute;top:16px;right:20px;width:22%;height:24%;z-index:6;border:1px solid #fff2;border-radius:18px;cursor:pointer;transition:transform .18s,box-shadow .18s,width .18s,height .18s,top .18s,right .18s,left .18s}
    #mainPreview:hover{box-shadow:0 10px 30px #0008}
    #mainPreview video{display:block;width:100%;height:100%;object-fit:contain}

    /* تقسيم (MAIN يمين دائمًا) */
    .split #mainPreview{top:0;right:0;width:50%;height:100%;border:0;border-radius:0;cursor:default}
    .split #activeCam{top:0;left:0;right:auto;width:50%;height:100%}

    /* أوضاع التقسيم */
    .split.mode1 #mainPreview video,
    .split.mode1 #activeCam  video{object-fit:contain; transform:none}
    .split.mode2 #mainPreview video,
    .split.mode2 #activeCam  video{object-fit:contain; transform:scale(1.08); transform-origin:center}
    .split.mode3 #mainPreview video,
    .split.mode3 #activeCam  video{object-fit:cover; transform:none}

    /* تكبير المعاينة */
    .main-full #mainPreview{top:0;right:0;width:100%;height:100%;z-index:7;border:0;border-radius:0;cursor:zoom-out}
    .main-full #activeCam{display:none}
    .main-full.cover-one #mainPreview video{object-fit:cover}

    .hint{position:absolute;top:20px;right:20px;z-index:8;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
    .split .hint,.main-full .hint{display:none}

    /* أشرطة/أزرار + إخفاء تلقائي */
    #utilityControls,#globalControls{position:absolute;z-index:12;display:flex;gap:8px;flex-wrap:wrap;transition:opacity .18s}
    #utilityControls{top:10px;right:10px}
    #globalControls{bottom:70px;left:50%;transform:translateX(-50%);background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd);align-items:center;min-width:340px}
    #globalControls.hidden{display:none}

    button{-webkit-tap-highlight-color:transparent;appearance:none;border:0;outline:0;cursor:pointer;background:var(--btn-bg);color:var(--btn-txt);padding:11px 12px;font-size:12px;font-weight:800;border-radius:12px;letter-spacing:.2px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 18px #000a,0 0 0 0 rgba(0,193,154,.28);transition:transform .12s,box-shadow .12s,background .12s}
    button:hover{background:var(--btn-bg-h);box-shadow:0 12px 26px #000c,0 0 0 6px rgba(0,193,154,.28)}
    button:active{background:var(--btn-bg-a);transform:translateY(1px)}

    #scrub{-webkit-appearance:none;appearance:none;width:320px;height:6px;border-radius:999px;background:#ffffff30;outline:none;margin:0 8px}
    #scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #0006;cursor:pointer}
    #timeLabel{color:#fff;font-size:12px;min-width:108px;text-align:center}

    #gatePlay{position:absolute;inset:0;z-index:9;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2))}
    #gatePlay.hidden{display:none}
    .gate-card{background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .gate-card .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--panel-bd);color:#fff;background:#111a;font-size:18px}
    #startBtn{min-width:160px}

    /* القائمة الجانبية */
    #streamPanel{
      position:absolute; top:0; left:0; height:100%; width:230px; z-index:12;
      background:none; border-right:none; padding:12px 10px; color:#fff;
      transition:opacity .18s; pointer-events:auto;
    }
    #streamPanel .panel-title{font-weight:900;letter-spacing:.8px;margin:6px 6px 12px;font-size:13px;text-shadow:0 1px 2px #000}
    #streamList{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;max-height:calc(100% - 48px);overflow:auto}
    .stream-item{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer;
      background:rgba(0,0,0,.30); border:1px solid rgba(255,255,255,.20);
      backdrop-filter: blur(2px);
      transition:background .12s, border-color .12s, transform .06s;
    }
    .stream-item:hover{background:rgba(0,0,0,.38);border-color:#ffffff35}
    .stream-item.active{background:rgba(0,0,0,.55);border-color:#ffffff60}
    .stream-name{font-weight:800; font-size:12px; letter-spacing:.4px; text-transform:uppercase}

    /* إخفاء واجهة التحكم تلقائيًا */
    .ui-hidden #streamPanel,
    .ui-hidden #utilityControls,
    .ui-hidden #globalControls{opacity:0; pointer-events:none}
    .ui-visible #streamPanel,
    .ui-visible #utilityControls,
    .ui-visible #globalControls{opacity:1; pointer-events:auto}

    /* طبقات وتلاشي التبديل */
    .layer{position:absolute; inset:0;}
    .fade-in{animation:fadeIn .18s ease forwards}
    .fade-out{animation:fadeOut .18s ease forwards}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeOut{from{opacity:1}to{opacity:0}}

    @media (orientation: portrait){
      #mainPreview{top:12px;right:14px;width:58vw;height:36vh;border-radius:18px}
      #globalControls{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 8px);left:50%;transform:translateX(-50%);width:min(94vw,560px);padding:8px 10px;z-index:9999}
      #scrub{width:clamp(140px,56vw,380px)}
      #streamPanel{width:190px}
    }
  </style>
</head>
<body>
  <div id="playerContainer" class="ui-visible" aria-label="مشغّل متعدد الكاميرات">

    <!-- القائمة الجانبية -->
    <aside id="streamPanel" aria-label="مصادر البث">
      <div class="panel-title">SOURCES</div>
      <ul id="streamList"></ul>
    </aside>

    <div id="activeCam" class="videoFrame" aria-label="الكاميرا النشطة"></div>
    <div id="mainPreview" class="videoFrame" title="انقر للتكبير/التصغير" aria-label="المعاينة الرئيسية المصغّرة"></div>
    <div class="hint">انقر على المعاينة للتكبير • أو اضغط F</div>

    <!-- بوابة البدء -->
    <div id="gatePlay" role="dialog" aria-modal="true" aria-label="بدء التشغيل">
      <div class="gate-card">
        <div class="icon">▶</div>
        <div>
          <div style="color:#fff;font-weight:800;margin-bottom:6px">ابدأ التشغيل والمزامنة</div>
          <div style="font-size:12px;color:#eaeaf0b3">سيظهر شريط التقديم/التأخير بعد الضغط على تشغيل</div>
        </div>
        <button id="startBtn" aria-label="ابدأ التشغيل الآن">تشغيل/بدء المزامنة</button>
      </div>
    </div>

    <!-- أدوات -->
    <div id="utilityControls" role="toolbar" aria-label="أدوات">
      <button id="btnSplit" aria-label="تبديل وضع التقسيم" title="تقسيم">تقسيم</button>
      <button id="btnFill"  aria-label="تبديل ملء المحتوى" title="ملء">ملء</button>
      <button id="btnSound" aria-label="تشغيل/إيقاف الصوت" title="صوت">🔊/🔇</button>
    </div>

    <!-- الشريط الموحّد -->
    <div id="globalControls" class="hidden" role="group" aria-label="تحكم موحّد">
      <button id="gBack" title="⏪ -5s">⏪ 5s</button>
      <button id="gPlay" title="⏯">⏯</button>
      <button id="gFwd"  title="+5s ⏩">5s ⏩</button>
      <input id="scrub" type="range" min="0" max="0" value="0" step="0.01" aria-label="شريط التقدم">
      <div id="timeLabel">00:00 / 00:00</div>
    </div>

    <!-- واجهة LiveKit -->
    <div style="position:absolute;bottom:12px;right:12px;z-index:20;background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:12px;padding:10px;display:flex;gap:8px;align-items:center">
      <span style="color:#fff">(LiveKit) الغرفة المباشرة</span>
      <input id="displayName" placeholder="اسم العرض (اختياري)" style="padding:8px;border-radius:10px;border:1px solid #444;background:#111;color:#fff;width:140px">
      <select id="roomName" style="padding:8px;border-radius:10px;border:1px solid #444;background:#111;color:#fff">
        <option>studio-1</option>
        <option>studio-2</option>
        <option>studio-3</option>
      </select>
      <button id="btnJoin">انضم للغرفة</button>
      <button id="btnLeave" disabled>مغادرة</button>
      <button id="btnCam" disabled>الكاميرا</button>
      <button id="btnMic" disabled>المايك</button>
      <span id="lkStatus" style="color:#9fe">LiveKit</span>
    </div>
    <div id="lkLocal" style="position:absolute;bottom:100px;right:12px;width:220px;height:124px;background:#000;z-index:20;border:1px solid #fff2;border-radius:10px;overflow:hidden"></div>
  </div>

  <!-- إعدادات قواعد التوجيه عبر Worker -->
  <script>
    /* غيّر هذه عند الحاجة */
    window.API_BASE = "https://steps-livekit-api.onrender.com";          /* خدمة التوكن */
    window.HLS_BASE = "";                                                 /* تُحدَّد عبر ?h=... أو عبر Functions */
  </script>

  <!-- HLS على نطاقك -->
  <script src="/vendor/hls.min.js"></script>

  <script>
    // =========== مصادر البث ===========
    (function(){
      const url = new URL(location.href);
      const H = (url.searchParams.get("h") || window.HLS_BASE || "").replace(/\/+$/,"");
      const build = (p)=>H ? `${H}${p}` : p;

      window.sources = {
        main: build("/hls/live/playlist.m3u8"),
        cam1: build("/hls/lastone/playlist.m3u8"),
        cam2: build("/hls/live2/playlist.m3u8"),
        cam3: build("/hls/live3/playlist.m3u8"),
        cam4: build("/hls/live4/playlist.m3u8"),
        cam5: build("/hls/live5/playlist.m3u8"),
        cam6: build("/hls/live6/playlist.m3u8"),
        cam7: build("/hls/live7/playlist.m3u8"),
      };

      window.channelMap = [
        {id:'main',label:'MAIN',src:sources.main},
        {id:'cam1',label:'CAM1',src:sources.cam1},
        {id:'cam2',label:'CAM2',src:sources.cam2},
        {id:'cam3',label:'CAM3',src:sources.cam3},
        {id:'cam4',label:'CAM4',src:sources.cam4},
        {id:'cam5',label:'CAM5',src:sources.cam5},
        {id:'cam6',label:'DRONE',src:sources.cam6},
        {id:'cam7',label:'SINEFLEX',src:sources.cam7},
      ];
    })();

    // =========== أدوات مساعدة ===========
    function el(q){return document.querySelector(q)}
    function ce(tag,cls){const e=document.createElement(tag); if(cls) e.className=cls; return e}

    function mountVideo(container, src){
      container.innerHTML = "";
      const v = ce("video");
      v.playsInline = true; v.controls = false; v.muted = true; v.autoplay = false;
      container.appendChild(v);

      if (v.canPlayType('application/vnd.apple.mpegurl') && /safari/i.test(navigator.userAgent)) {
        v.src = src;
        v.addEventListener('loadedmetadata', ()=> v.play()).addEventListener?.('error',console.warn);
      } else if (window.Hls) {
        const hls = new Hls({ enableWorker:true, lowLatencyMode:true });
        hls.on(Hls.Events.ERROR, (e,d)=>console.warn("[HLS] ERROR", d));
        hls.loadSource(src);
        hls.attachMedia(v);
        v.addEventListener('loadedmetadata', ()=> v.play());
      } else {
        v.src = src;
        v.addEventListener('loadedmetadata', ()=> v.play());
      }
      return v;
    }

    // بناء القائمة
    (function buildList(){
      const ul = el("#streamList");
      window.channelMap.forEach(ch=>{
        const li = ce("li","stream-item"); li.dataset.id=ch.id;
        const name = ce("div","stream-name"); name.textContent = ch.label;
        li.appendChild(name);
        li.addEventListener("click", ()=> {
          current = ch.id; refreshActive();
          document.querySelectorAll(".stream-item").forEach(x=>x.classList.toggle("active", x===li));
        });
        ul.appendChild(li);
      });
    })();

    let current = "main";
    function refreshActive(){
      mountVideo(el("#activeCam"), window.channelMap.find(c=>c.id===current).src);
    }
    mountVideo(el("#mainPreview"), sources.main);
    refreshActive();

    // بوابة التشغيل
    el("#startBtn").addEventListener("click", ()=> {
      el("#gatePlay").classList.add("hidden");
      // إظهار الشريط
      el("#globalControls").classList.remove("hidden");
    });

    // =========== تحميل مكتبة LiveKit بشكل موثوق ===========
    async function loadScript(src){
      return new Promise((res, rej)=>{
        const s = document.createElement("script");
        s.src = src; s.async = true;
        s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
      });
    }

    function pickLiveKitGlobal(){
      const cands = [
        window.LiveKit,
        window.livekitClient,
        window.livekit,
        window.LivekitClient
      ].filter(Boolean);
      return cands.length ? cands[0] : null;
    }

    async function ensureLiveKit(){
      let LK = pickLiveKitGlobal();
      if (LK) return LK;
      await loadScript("/vendor/livekit-client.umd.min.js");
      LK = pickLiveKitGlobal();
      if (!LK) throw new Error("LiveKit library did not load");
      return LK;
    }

    // =========== جلب التوكن من API مع مسارات بديلة ===========
    async function fetchTokenSmart(room, identity){
      const base = (window.API_BASE || "").replace(/\/+$/,"");
      if (!base) throw new Error("API_BASE غير مضبوط");

      const paths = ["/api/token","/token","/api/rtoken","/api/get-token"];
      const tried = [];
      for (const p of paths){
        const url = `${base}${p}?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`;
        tried.push(url);
        try{
          const r = await fetch(url, { mode:"cors" });
          if (r.ok){
            const j = await r.json();
            if (j && j.token && j.url) return j;
          }
        }catch(_){}
      }
      throw new Error("لا يمكن الحصول على التوكن. تمّت المحاولة على:\n" + tried.join("\n"));
    }

    // =========== الانضمام إلى LiveKit ===========
    let lkRoom = null, lkLocalTracks = [];
    const $status = el("#lkStatus");
    function setLKStatus(t){ $status.textContent = t; }

    async function joinLiveKit(){
      try{
        setLKStatus("جاري التحميل...");
        const LK = await ensureLiveKit();

        const roomName = el("#roomName").value || "studio-1";
        const identity = (el("#displayName").value || ("guest-" + Math.random().toString(36).slice(2,7)));
        const { token, url } = await fetchTokenSmart(roomName, identity);

        // Tracks محلية بناءً على موافقة المستخدم (زر بضغط يدوي)
        const wantCam = true, wantMic = true; // يمكن ربطها بأزرار لاحقًا
        lkLocalTracks = [];
        if (wantCam || wantMic){
          const cam = wantCam ? { video:true } : {};
          const mic = wantMic ? { audio:true } : {};
          const tracks = await LK.createLocalTracks({ ...cam, ...mic });
          lkLocalTracks.push(...tracks);
        }

        // بعض نسخ UMD لا تملك connect، فنستخدم Room كبديل
        if (typeof LK.connect === "function"){
          lkRoom = await LK.connect(url, token, { autoSubscribe:true, stopLocalTrackOnUnpublish:true });
        } else if (typeof LK.Room === "function"){
          lkRoom = new LK.Room({ autoSubscribe:true, stopLocalTrackOnUnpublish:true });
          await lkRoom.connect(url, token);
        } else {
          throw new Error("LK.connect not available");
        }

        // نشر التراكات المحلية (إن وُجدت)
        for (const t of lkLocalTracks){ await lkRoom.localParticipant.publishTrack(t); }

        // عرض المعاينة المحلية
        const localDiv = el("#lkLocal");
        localDiv.innerHTML = "";
        lkRoom.localParticipant.videoTracks.forEach(pub=>{
          const elv = document.createElement("video");
          elv.autoplay = true; elv.muted = true; elv.playsInline = true;
          pub.videoTrack.attach(elv);
          localDiv.appendChild(elv);
        });

        // التحكم بالأزرار
        el("#btnLeave").disabled = false;
        el("#btnCam").disabled = false;
        el("#btnMic").disabled = false;
        setLKStatus("متصل");
      }catch(err){
        console.error("joinLiveKit error", err);
        alert("تعذّر الانضمام: " + (err?.message || err));
        setLKStatus("فشل");
      }
    }

    async function leaveLiveKit(){
      try{
        if (lkRoom){
          await lkRoom.disconnect();
          lkRoom = null;
        }
        lkLocalTracks.forEach(t=>{ try{ t.stop(); }catch{} });
        lkLocalTracks = [];
        el("#lkLocal").innerHTML = "";
        el("#btnLeave").disabled = true;
        el("#btnCam").disabled = true;
        el("#btnMic").disabled = true;
        setLKStatus("LiveKit");
      }catch(e){ console.warn(e); }
    }

    // ربط أزرار LiveKit
    el("#btnJoin").addEventListener("click", joinLiveKit);
    el("#btnLeave").addEventListener("click", leaveLiveKit);
    el("#btnCam").addEventListener("click", async ()=>{
      if (!lkRoom) return;
      const pub = lkRoom.localParticipant.getTrackPublication("camera");
      if (pub && pub.isEnabled) await pub.setEnabled(false);
      else if (pub) await pub.setEnabled(true);
    });
    el("#btnMic").addEventListener("click", async ()=>{
      if (!lkRoom) return;
      const pub = lkRoom.localParticipant.getTrackPublication("microphone");
      if (pub && pub.isEnabled) await pub.setEnabled(false);
      else if (pub) await pub.setEnabled(true);
    });

    // اختصارات بسيطة
    document.addEventListener("keydown", (e)=>{
      if (e.key.toLowerCase()==="f"){
        const c = document.body.classList;
        if (c.contains("main-full")) c.remove("main-full"); else c.add("main-full");
      }
    });
  </script>
</body>
</html>
