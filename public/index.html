<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Steps Co — MultiCam + LiveKit</title>

  <!-- اضبط هذه القيم حسب بيئتك -->
  <script>
    // عنوان الـ Worker الذي يوجّه إلى التانِل (لا تُضِف /hls في النهاية)
    window.HLS_BASE   = "https://hls-proxy.it-f2c.workers.dev";
    // خدمة التوكن (Backend) التي تتولّد منها رموز LiveKit
    window.TOKEN_BASE = "https://steps-livekit-api.onrender.com";
    // مضيف LiveKit (سحابة livekit أو خادمك)
    window.LK_URL     = "wss://presinter-stream-gjthpz2z.livekit.cloud";
  </script>

  <!-- فافيكون بسيطة -->
  <link rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%2300c19a'/%3E%3C/svg%3E">

  <style>
    :root{
      --btn:#00c19a; --btn-h:#00ad8a; --btn-a:#009e7e; --txt:#fff;
      --panel:#0b0b0fe6; --bd:#ffffff26;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

    #player{position:relative;width:100vw;height:100vh}

    /* الفيديوهات */
    .videoFrame{position:absolute;inset:0;background:#000;overflow:hidden}
    .videoFrame video{width:100%;height:100%;object-fit:contain;background:#000}

    /* المعاينة المصغّرة */
    #mainPreview{position:absolute;top:14px;right:16px;width:22%;height:24%;z-index:6;border:1px solid #fff2;border-radius:18px;cursor:pointer;transition:transform .18s,box-shadow .18s,width .18s,height .18s,top .18s,right .18s,left .18s}
    #mainPreview video{object-fit:contain}
    #mainPreview:hover{box-shadow:0 10px 30px #0008}

    /* تقسيم (يمين: المعاينة، يسار: النشطة) */
    .split #mainPreview{top:0;right:0;width:50%;height:100%;border:0;border-radius:0;cursor:default}
    .split #active{left:0;right:auto;width:50%;height:100%}

    /* تكبير المعاينة */
    .main-full #mainPreview{top:0;right:0;width:100%;height:100%;z-index:7;border:0;border-radius:0;cursor:zoom-out}
    .main-full #active{display:none}

    /* تلميح */
    .hint{position:absolute;top:18px;right:18px;z-index:8;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
    .split .hint,.main-full .hint{display:none}

    /* اللوائح/الأزرار + إخفاء تلقائي */
    #leftPanel,#topTools,#bottomBar{position:absolute;z-index:12;transition:opacity .18s}
    .ui-hidden #leftPanel,.ui-hidden #topTools,.ui-hidden #bottomBar{opacity:0;pointer-events:none}
    .ui-visible #leftPanel,.ui-visible #topTools,.ui-visible #bottomBar{opacity:1;pointer-events:auto}

    /* قائمة الكاميرات */
    #leftPanel{
      top:0; left:0; height:100%; width:240px;
      padding:12px 10px; color:#fff;
      background:none; border-right:none;
    }
    .panel-title{font-weight:900;letter-spacing:.8px;margin:6px 8px 12px;font-size:13px;text-shadow:0 1px 2px #000}
    #camList{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;max-height:calc(100% - 52px);overflow:auto}
    .cam-item{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer;
      background:rgba(0,0,0,.30); border:1px solid rgba(255,255,255,.20);
      backdrop-filter: blur(2px);
      transition:background .12s, border-color .12s, transform .06s;
    }
    .cam-item:hover{background:rgba(0,0,0,.38);border-color:#ffffff35}
    .cam-item.active{background:rgba(0,0,0,.55);border-color:#ffffff60}
    .cam-name{font-weight:800; font-size:12px; letter-spacing:.4px}
    .dot{width:10px;height:10px;border-radius:50%;border:1px solid #0004;box-shadow:0 0 0 2px #0005 inset}
    .ok{background:#22c55e}
    .bad{background:#ef4444}
    .unknown{background:#666}

    /* أدوات علوية */
    #topTools{top:10px;right:10px;display:flex;gap:8px;flex-wrap:wrap}
    button{appearance:none;border:0;outline:0;cursor:pointer;background:var(--btn);color:var(--txt);padding:11px 12px;font-size:12px;font-weight:800;border-radius:12px;letter-spacing:.2px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 18px #000a,0 0 0 0 rgba(0,193,154,.28);transition:transform .12s,box-shadow .12s,background .12s}
    button:hover{background:var(--btn-h);box-shadow:0 12px 26px #000c,0 0 0 6px rgba(0,193,154,.28)}
    button:active{background:var(--btn-a);transform:translateY(1px)}

    /* شريط سفلي */
    #bottomBar{
      bottom:12px; left:50%; transform:translateX(-50%);
      background:var(--panel); padding:10px;
      border:1px solid var(--bd); border-radius:14px; color:#fff;
      display:flex; align-items:center; gap:10px; min-width:360px;
    }

    /* بوابة البدء */
    #gate{position:absolute;inset:0;z-index:9;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2))}
    #gate.hidden{display:none}
    .gate-card{background:var(--panel);border:1px solid var(--bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .gate-card .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--bd);color:#fff;background:#111a;font-size:18px}
    #startBtn{min-width:180px}

    /* لوحة LiveKit */
    #lkPanel{
      position:absolute; top:10px; left:260px; z-index:12;
      background:var(--panel); color:#fff; padding:10px; border-radius:12px; border:1px solid var(--bd);
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    #rooms{display:flex; gap:6px; flex-wrap:wrap}
    .room-btn{padding:6px 8px; border-radius:10px; font-weight:700; background:#2228; color:#fff; border:1px solid #fff2; cursor:pointer}
    .room-btn.active{background:#2dd4bf33; border-color:#2dd4bf}

    #msg{position:absolute;bottom:16px;right:16px;z-index:50;color:#fff;font:12px/1.4 system-ui}

    @media (orientation: portrait){
      #mainPreview{top:12px;right:14px;width:58vw;height:36vh;border-radius:18px}
      #leftPanel{width:200px}
      #lkPanel{left:216px}
      #bottomBar{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 8px);left:50%;transform:translateX(-50%);width:min(94vw,560px);padding:8px 10px;z-index:9999}
    }
  </style>
</head>
<body>
  <div id="player" class="ui-visible" aria-label="مشغّل متعدد الكاميرات">
    <!-- قائمة الكاميرات -->
    <aside id="leftPanel" aria-label="مصادر البث">
      <div class="panel-title">الكاميرات</div>
      <ul id="camList"></ul>
    </aside>

    <!-- لوحة LiveKit -->
    <section id="lkPanel" aria-label="غرف LiveKit">
      <div id="rooms"></div>
      <input id="identity" placeholder="اسمك (للغرفة)" style="padding:8px;border-radius:8px;border:1px solid #ffffff22;background:#111a;color:#fff" />
      <button id="joinBtn">انضمام</button>
      <button id="leaveBtn" style="display:none;background:#ef4444">خروج</button>
    </section>

    <div id="active" class="videoFrame" aria-label="الكاميرا النشطة"></div>
    <div id="mainPreview" class="videoFrame" title="انقر للتكبير/التصغير" aria-label="المعاينة الرئيسية المصغّرة"></div>
    <div class="hint">انقر على المعاينة للتكبير • أو اضغط F</div>

    <!-- أدوات -->
    <div id="topTools" role="toolbar" aria-label="أدوات">
      <button id="btnSplit" title="تقسيم">تقسيم</button>
      <button id="btnFit"   title="ملاءمة">ملء/احتواء</button>
      <button id="btnMute"  title="صوت">🔊/🔇</button>
    </div>

    <!-- شريط سفلي (حاليًا بدون سكرَب لكونها Live) -->
    <div id="bottomBar" role="group" aria-label="تحكم">
      <span>حالة البث حيّ • اضغط «بدء» لتشغيل جميع الكاميرات</span>
    </div>

    <!-- بوابة البدء -->
    <div id="gate" role="dialog" aria-modal="true" aria-label="بدء التشغيل">
      <div class="gate-card">
        <div class="icon">▶</div>
        <div>
          <div style="color:#fff;font-weight:800;margin-bottom:6px">ابدأ التشغيل والمزامنة</div>
          <div style="font-size:12px;color:#eaeaf0b3">عند الضغط سيتم تشغيل جميع الكاميرات والتحقق من حالتها</div>
        </div>
        <button id="startBtn" aria-label="ابدأ التشغيل الآن">تشغيل/بدء</button>
      </div>
    </div>
  </div>

  <div id="msg"></div>

  <!-- مكتبة HLS من نطاقك (يجب أن تتوفر عبر /vendor/hls.min.js) -->
  <script>
    function loadScript(src){
      return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src; s.async = true; s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
      });
    }
  </script>
  <script>
    // ضمان تحميل HLS من /vendor داخل نفس النطاق (تبعًا لـ CSP)
    async function ensureHls(){
      if (window.Hls) return window.Hls;
      await loadScript('/vendor/hls.min.js');
      if (!window.Hls) throw new Error('HLS library did not load');
      return window.Hls;
    }
    // ضمان تحميل LiveKit من /vendor داخل نفس النطاق
    async function ensureLiveKit(){
      if (window.LiveKit && typeof window.LiveKit.connect === 'function') return window.LiveKit;
      await loadScript('/vendor/livekit-client.umd.min.js');
      if (!window.LiveKit || typeof window.LiveKit.connect !== 'function') {
        throw new Error('LiveKit library did not load');
      }
      return window.LiveKit;
    }
  </script>

  <script>
    // ----------- إعداد المصادر -----------
    const BASE = (window.HLS_BASE || '').replace(/\/+$/, '');
    const h = (p) => BASE ? (BASE + p) : p;

    const SOURCES = {
      main   : h('/hls/live/playlist.m3u8'),
      lastone: h('/hls/lastone/playlist.m3u8'),
      live2  : h('/hls/live2/playlist.m3u8'),
      live3  : h('/hls/live3/playlist.m3u8'),
      live4  : h('/hls/live4/playlist.m3u8'),
      live5  : h('/hls/live5/playlist.m3u8'),
      live6  : h('/hls/live6/playlist.m3u8'),
      live7  : h('/hls/live7/playlist.m3u8'),
    };

    const CHANNELS = [
      { id:'main',    label:'MAIN',   url:SOURCES.main   },
      { id:'lastone', label:'LAST',   url:SOURCES.lastone},
      { id:'live2',   label:'CAM2',   url:SOURCES.live2  },
      { id:'live3',   label:'CAM3',   url:SOURCES.live3  },
      { id:'live4',   label:'CAM4',   url:SOURCES.live4  },
      { id:'live5',   label:'CAM5',   url:SOURCES.live5  },
      { id:'live6',   label:'CAM6',   url:SOURCES.live6  },
      { id:'live7',   label:'CAM7',   url:SOURCES.live7  },
    ];

    // ----------- عناصر DOM -----------
    const el = {
      player: document.getElementById('player'),
      active: document.getElementById('active'),
      preview: document.getElementById('mainPreview'),
      gate: document.getElementById('gate'),
      startBtn: document.getElementById('startBtn'),
      camList: document.getElementById('camList'),
      btnSplit: document.getElementById('btnSplit'),
      btnFit: document.getElementById('btnFit'),
      btnMute: document.getElementById('btnMute'),
      rooms: document.getElementById('rooms'),
      idInput: document.getElementById('identity'),
      joinBtn: document.getElementById('joinBtn'),
      leaveBtn: document.getElementById('leaveBtn'),
      msg: document.getElementById('msg'),
    };

    // ----------- حالات عامة -----------
    let isMainFull = false;
    let isSplit = false;
    let fitMode = 'contain'; // contain | cover
    let activeId = 'main';
    let hlsInstances = new Map();   // id -> Hls instance
    let videoEls = new Map();       // id -> HTMLVideoElement
    let pingTimer = null;

    function showMsg(t){ el.msg.textContent = t; setTimeout(()=>{ if(el.msg.textContent===t) el.msg.textContent=''; }, 4000); }

    // ----------- إنشاء فيديو وإرفاق HLS -----------
    async function attachHlsTo(id, url, parent){
      const Hls = await ensureHls();

      // أنشئ فيديو
      let v = videoEls.get(id);
      if (!v) {
        v = document.createElement('video');
        v.playsInline = true;
        v.muted = (id !== 'main'); // الرئيسية غير ميوت مبدئيًا، والباقي ميوت
        v.autoplay = true;
        v.controls = false;
        v.setAttribute('preload','auto');
        videoEls.set(id, v);
      }

      // أفرغ القديم
      parent.innerHTML = '';
      parent.appendChild(v);

      // حرّر HLS سابق
      const old = hlsInstances.get(id);
      if (old) { try { old.destroy(); } catch{} hlsInstances.delete(id); }

      if (Hls.isSupported()) {
        const hls = new Hls({
          enableWorker: true,
          lowLatencyMode: true,
          backBufferLength: 30,
        });
        hls.on(Hls.Events.ERROR, (_e, data) => {
          console.error('[HLS] ERROR', data);
          showMsg('خطأ في تشغيل HLS: تحقق من التانِل/الوركر');
        });
        hls.loadSource(url);
        hls.attachMedia(v);
        hlsInstances.set(id, hls);
      } else if (v.canPlayType('application/vnd.apple.mpegurl')) {
        v.src = url;
      } else {
        throw new Error('HLS غير مدعوم في هذا المتصفح');
      }

      v.style.objectFit = fitMode;
      // محاولة تشغيل
      try { await v.play(); } catch { /* ينتظر تفاعل المستخدم */ }
      return v;
    }

    // ----------- بناء قائمة الكاميرات -----------
    function buildCamList(){
      el.camList.innerHTML = '';
      for (const ch of CHANNELS) {
        const li = document.createElement('li');
        li.className = 'cam-item' + (ch.id===activeId ? ' active':'');
        li.dataset.id = ch.id;

        const dot = document.createElement('span'); dot.className = 'dot unknown';
        const name = document.createElement('span'); name.className = 'cam-name'; name.textContent = ch.label;

        li.appendChild(dot); li.appendChild(name);
        li.onclick = ()=> switchActive(ch.id);
        el.camList.appendChild(li);
      }
    }

    function markStatus(id, ok){
      const item = [...el.camList.children].find(li => li.dataset.id===id);
      if (!item) return;
      const dot = item.querySelector('.dot');
      dot.className = 'dot ' + (ok ? 'ok' : 'bad');
    }

    // ----------- تشغيل أولي / تبديل -----------
    async function startPlayback(){
      el.gate.classList.add('hidden');

      // شغّل الرئيسية في المعاينة ثم انقلها إلى الإطار الكبير
      await attachHlsTo('main', SOURCES.main, el.preview);
      setTimeout(()=> switchActive('main'), 50);

      // فعّل مؤشّرات الحالة
      startPing();
    }

    async function switchActive(id){
      activeId = id;
      for (const li of el.camList.children) {
        li.classList.toggle('active', li.dataset.id===id);
      }
      const ch = CHANNELS.find(c => c.id===id);
      if (!ch) return;

      await attachHlsTo(id, ch.url, el.active);
      // اجعل غير النشطة ميوت
      for (const [k,v] of videoEls) v.muted = (k !== id);
    }

    // ----------- Ping للحالة (HEAD عبر الـWorker) -----------
    function startPing(){
      if (pingTimer) clearInterval(pingTimer);
      const pingOnce = async ()=>{
        const ts = Date.now();
        for (const ch of CHANNELS) {
          const u = ch.url + (ch.url.includes('?') ? '&' : '?') + 'ping=' + ts;
          try {
            const r = await fetch(u, { method:'HEAD', cache:'no-store', mode:'cors' });
            markStatus(ch.id, r.ok);
          } catch {
            markStatus(ch.id, false);
          }
        }
      };
      pingOnce();
      pingTimer = setInterval(pingOnce, 8000);
    }

    // ----------- أوضاع العرض -----------
    function toggleSplit(){
      isSplit = !isSplit;
      document.body.classList.toggle('split', isSplit);
    }
    function toggleFit(){
      fitMode = (fitMode === 'contain') ? 'cover' : 'contain';
      for (const v of videoEls.values()) v.style.objectFit = fitMode;
    }
    function toggleMainFull(){
      isMainFull = !isMainFull;
      document.body.classList.toggle('main-full', isMainFull);
    }

    // ----------- إخفاء/إظهار الواجهة تلقائيًا -----------
    ;(function initAutoUI(){
      let t=null, visible=true;
      const set = (vis)=>{
        if (visible===vis) return;
        visible=vis;
        document.getElementById('player').classList.toggle('ui-hidden', !vis);
        document.getElementById('player').classList.toggle('ui-visible',  vis);
      };
      const kick = ()=>{
        set(true);
        if (t) clearTimeout(t);
        t = setTimeout(()=>set(false), 2500);
      };
      window.addEventListener('mousemove', kick);
      window.addEventListener('touchstart', kick);
      kick();
    })();

    // ----------- LiveKit (انضمام/خروج) -----------
    let lkRoom = null;
    let selectedRoom = 'studio-1';

    function buildRooms(){
      el.rooms.innerHTML = '';
      for (let i=1;i<=10;i++){
        const id = `studio-${i}`;
        const b = document.createElement('button');
        b.className = 'room-btn' + (id===selectedRoom ? ' active':'' );
        b.textContent = id;
        b.onclick = ()=>{ selectedRoom=id; buildRooms(); };
        el.rooms.appendChild(b);
      }
    }

    async function fetchTokenSmart(room, identity){
      const base = (window.TOKEN_BASE || '').replace(/\/+$/,'');
      if (!base) throw new Error('TOKEN_BASE غير مهيّأ');
      const paths = [
        `/api/token?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`,
        `/token?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`,
        `/api/rtoken?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`,
        `/api/get-token?room=${encodeURIComponent(room)}&identity=${encodeURIComponent(identity)}`
      ];
      const tried = [];
      for (const p of paths) {
        const url = base + p;
        tried.push(url);
        try {
          const r = await fetch(url, { mode:'cors', cache:'no-store' });
          if (!r.ok) continue;
          const ct = (r.headers.get('content-type') || '').toLowerCase();
          if (ct.includes('application/json')) {
            const j = await r.json();
            if (j?.token) return j.token;
            if (j?.accessToken) return j.accessToken;
          } else {
            const t = await r.text();
            if (t && t.length > 10) return t.trim();
          }
        } catch {}
      }
      throw new Error('لا يمكن الحصول على التوكن. تمّت المحاولة على:\n' + tried.join('\n'));
    }

    async function joinLiveKit(){
      try{
        const LK = await ensureLiveKit();
        const identity = (el.idInput.value || '').trim() || ('guest-' + Math.random().toString(36).slice(2,7));
        const token = await fetchTokenSmart(selectedRoom, identity);
        const url = window.LK_URL;

        // سيطلب المتصفح إذن الكاميرا/المايك عند تفعيل tracks
        lkRoom = await LK.connect(url, token, { autoSubscribe: true, webAudioMix: true, audio: true, video: true });
        showMsg(`تم الانضمام إلى ${selectedRoom} كـ ${identity}`);
        el.joinBtn.style.display = 'none';
        el.leaveBtn.style.display = 'inline-flex';
      }catch(err){
        console.error('joinLiveKit error', err);
        showMsg('تعذّر الانضمام: ' + (err?.message || err));
      }
    }

    async function leaveLiveKit(){
      try{
        if (lkRoom){
          await lkRoom.disconnect();
          lkRoom = null;
        }
        showMsg('تم الخروج من الغرفة');
      }catch{}
      el.joinBtn.style.display = 'inline-flex';
      el.leaveBtn.style.display = 'none';
    }

    // ----------- أحداث واجهة -----------
    el.startBtn.addEventListener('click', startPlayback);
    el.btnSplit.addEventListener('click', toggleSplit);
    el.btnFit.addEventListener('click', toggleFit);
    el.btnMute.addEventListener('click', ()=>{
      const v = videoEls.get(activeId);
      if (!v) return;
      v.muted = !v.muted;
    });

    el.preview.addEventListener('click', toggleMainFull);
    window.addEventListener('keydown', (e)=>{ if (e.key.toLowerCase()==='f') toggleMainFull(); });

    el.joinBtn.addEventListener('click', joinLiveKit);
    el.leaveBtn.addEventListener('click', leaveLiveKit);

    // ----------- تهيئة الصفحة -----------
    (function init(){
      buildCamList();
      buildRooms();
      // مبدئيًا نجهّز فيديو فارغ في الإطارات لمنع أخطاء addEventListener على null
      el.active.innerHTML = '<video muted playsinline></video>';
      el.preview.innerHTML = '<video muted playsinline></video>';
    })();
  </script>
</body>
</html>
